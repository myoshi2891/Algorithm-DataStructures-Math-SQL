<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LeetCode 1115: Print FooBar Alternately</title>
        <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
            rel="stylesheet"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css"
            rel="stylesheet"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css"
            rel="stylesheet"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;600&family=Source+Code+Pro:wght@400;600&display=swap"
            rel="stylesheet"
        />
        <style>
            html {
                scroll-behavior: smooth;
            }
            code[class*='language-'],
            pre[class*='language-'] {
                font-family: 'JetBrains Mono', 'Source Code Pro', monospace;
                font-size: 0.95rem;
            }
            div.code-toolbar > .toolbar {
                opacity: 1;
            }
            div.code-toolbar > .toolbar .toolbar-item > button,
            div.code-toolbar > .toolbar .toolbar-item > a {
                background: #fff;
                border: 1px solid #e6e8ef;
                border-radius: 10px;
                padding: 1rem 1.5rem;
                margin: 1rem 1rem 0 0;
                font:
                    600 13px/1.2 Inter,
                    system-ui,
                    sans-serif;
                color: #334155;
                box-shadow: 0 2px 6px rgba(20, 32, 70, 0.06);
                transition:
                    transform 0.15s,
                    box-shadow 0.15s,
                    background 0.15s;
            }
            div.code-toolbar > .toolbar .toolbar-item > button:hover {
                transform: translateY(-1px);
                box-shadow: 0 10px 28px rgba(20, 32, 70, 0.08);
                background: linear-gradient(180deg, #e8fff6, #c8f1e1);
            }
            .flowchart-svg {
                max-width: 100%;
                height: auto;
                margin-top: 20px;
            }
        </style>
    </head>
    <body
        class="min-h-screen p-8 sm:p-6 font-[Inter] text-slate-800 leading-relaxed bg-[linear-gradient(135deg,#f0fdf4_0%,#dbeafe_100%)]"
    >
        <div class="max-w-7xl mx-auto">
            <header
                id="header"
                class="mb-8 rounded-2xl p-8 shadow-[0_10px_30px_rgba(16,185,129,0.10)] bg-[linear-gradient(135deg,#d1fae5,#bfdbfe)]"
            >
                <h1 class="text-[2.5rem] font-bold text-teal-800 mb-2">Print FooBar Alternately</h1>
                <p class="text-xl text-cyan-700 font-semibold mt-2">
                    Condition変数による交互出力 - O(n) 時間計算量
                </p>
                <nav class="flex flex-wrap gap-4 mt-6">
                    <a
                        href="#overview"
                        class="inline-block px-5 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_10px_20px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-700"
                    >
                        概要
                    </a>
                    <a
                        href="#steps"
                        class="inline-block px-5 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_10px_20px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-700"
                    >
                        ステップ解説
                    </a>
                    <a
                        href="#code"
                        class="inline-block px-5 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_10px_20px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-700"
                    >
                        コード実装
                    </a>
                    <a
                        href="#diagram"
                        class="inline-block px-5 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_10px_20px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-700"
                    >
                        フローチャート
                    </a>
                    <a
                        href="#complexity"
                        class="inline-block px-5 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_10px_20px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-700"
                    >
                        計算量分析
                    </a>
                </nav>
            </header>

            <section id="overview" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="text-[2rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    アルゴリズム概要
                </h2>

                <h3 class="text-xl font-semibold text-teal-800 mt-6 mb-3">問題文</h3>
                <p class="text-slate-700 leading-7 mb-4">
                    2つの異なるスレッドが同時に
                    <code class="px-2 py-1 bg-slate-100 rounded">foo()</code> と
                    <code class="px-2 py-1 bg-slate-100 rounded">bar()</code>
                    を呼び出す際、出力が必ず
                    <code class="px-2 py-1 bg-slate-100 rounded">"foobar"</code> のパターンで n
                    回繰り返されるように同期制御を実装します。
                </p>

                <h3 class="text-xl font-semibold text-teal-800 mt-6 mb-3">入出力例</h3>
                <div class="bg-slate-50 rounded-lg p-4 mb-4 font-mono text-sm">
                    <strong>Example 1:</strong><br />
                    Input: n = 1<br />
                    Output: "foobar"<br /><br />
                    <strong>Example 2:</strong><br />
                    Input: n = 2<br />
                    Output: "foobarfoobar"
                </div>

                <h3 class="text-xl font-semibold text-teal-800 mt-6 mb-3">制約条件</h3>
                <ul class="list-disc list-inside text-slate-700 leading-7 space-y-2">
                    <li><code class="px-2 py-1 bg-slate-100 rounded">1 ≤ n ≤ 1000</code></li>
                    <li>
                        スレッドA が
                        <code class="px-2 py-1 bg-slate-100 rounded">foo(printFoo)</code> を呼び出す
                    </li>
                    <li>
                        スレッドB が
                        <code class="px-2 py-1 bg-slate-100 rounded">bar(printBar)</code> を呼び出す
                    </li>
                    <li>
                        出力は必ず交互に <code class="px-2 py-1 bg-slate-100 rounded">foo</code> →
                        <code class="px-2 py-1 bg-slate-100 rounded">bar</code> のパターン
                    </li>
                </ul>

                <h3 class="text-xl font-semibold text-teal-800 mt-6 mb-3">戦略</h3>
                <ul class="list-disc list-inside text-slate-700 leading-7 space-y-2">
                    <li><strong>Condition変数</strong>による待機/通知パターン</li>
                    <li>
                        フラグ（<code class="px-2 py-1 bg-slate-100 rounded">foo_printed</code
                        >）で実行順序を制御
                    </li>
                    <li>
                        <code class="px-2 py-1 bg-slate-100 rounded">with</code>
                        文によるロック自動管理
                    </li>
                    <li>
                        <code class="px-2 py-1 bg-slate-100 rounded">while</code>
                        ループでスプリアス・ウェイクアップに対応
                    </li>
                </ul>

                <h3 class="text-xl font-semibold text-teal-800 mt-6 mb-3">主要ポイント</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div class="bg-emerald-50 rounded-lg p-4 border-2 border-emerald-200">
                        <h4 class="font-semibold text-emerald-800 mb-2">時間計算量</h4>
                        <p class="text-slate-700">O(n) - n回のイテレーション</p>
                    </div>
                    <div class="bg-sky-50 rounded-lg p-4 border-2 border-sky-200">
                        <h4 class="font-semibold text-sky-800 mb-2">空間計算量</h4>
                        <p class="text-slate-700">O(1) - 固定サイズの同期オブジェクト</p>
                    </div>
                </div>
            </section>

            <section id="steps" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="text-[2rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    ステップバイステップ解説
                </h2>
                <div id="step-visualization-root"></div>
            </section>

            <section id="code" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="text-[2rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    Python実装
                </h2>
                <pre
                    class="line-numbers"
                ><code class="language-python">from threading import Condition

class FooBar:
    """
    2スレッド間の交互実行を保証する同期クラス

    Attributes:
        n: foobar を出力する回数
        _cv: 条件変数（ロック + 通知機構）
        _foo_printed: foo実行済みフラグ
    """

    def __init__(self, n: int) -> None:
        """
        Args:
            n: 繰り返し回数 (1 <= n <= 1000)
        """
        self.n = n
        # 条件変数（内部で Lock を保持）
        self._cv = Condition()
        # False: foo のターン, True: bar のターン
        self._foo_printed = False

    def foo(self, printFoo) -> None:
        """
        "foo" を n 回出力（スレッドA用）

        Args:
            printFoo: "foo" を出力するコールバック
        """
        for _ in range(self.n):
            with self._cv:  # ロック取得（自動解放）
                # bar が完了するまで待機
                while self._foo_printed:
                    self._cv.wait()  # ロック解放して待機

                # printFoo() outputs "foo"
                printFoo()

                # bar に実行権を渡す
                self._foo_printed = True
                self._cv.notify()  # bar を起床

    def bar(self, printBar) -> None:
        """
        "bar" を n 回出力（スレッドB用）

        Args:
            printBar: "bar" を出力するコールバック
        """
        for _ in range(self.n):
            with self._cv:  # ロック取得（自動解放）
                # foo が完了するまで待機
                while not self._foo_printed:
                    self._cv.wait()  # ロック解放して待機

                # printBar() outputs "bar"
                printBar()

                # foo に実行権を戻す
                self._foo_printed = False
                self._cv.notify()  # foo を起床</code></pre>
            </section>

            <section id="diagram" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="text-[2rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    フローチャート
                </h2>
                <div class="mt-[20px] overflow-x-auto">
                    <svg
                        viewBox="0 0 900 1300"
                        class="flowchart-svg"
                        role="img"
                        aria-label="Print FooBar Alternately flowchart"
                    >
                        <!-- 背景 -->
                        <rect width="900" height="1300" fill="#fafafa" rx="12"/>

                        <defs>
                            <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#475569"/>
                            </marker>
                            <marker id="arrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#059669"/>
                            </marker>
                            <marker id="arrowRed" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#dc2626"/>
                            </marker>
                            <marker id="arrowBlue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#0284c7"/>
                            </marker>
                            <marker id="arrowPurple" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#7c3aed"/>
                            </marker>
                            <!-- ドロップシャドウ -->
                            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                                <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.15"/>
                            </filter>
                        </defs>

                        <!-- ===== 開始 ===== -->
                        <ellipse cx="450" cy="45" rx="90" ry="30" fill="#10b981" stroke="#059669" stroke-width="2" filter="url(#shadow)"/>
                        <text x="450" y="45" text-anchor="middle" dominant-baseline="middle" font-size="16" font-weight="700" fill="#ffffff">開始</text>

                        <!-- 開始→初期化 -->
                        <path d="M 450 75 L 450 100" stroke="#475569" stroke-width="2" fill="none" marker-end="url(#arrow)"/>

                        <!-- ===== 初期化 ===== -->
                        <rect x="300" y="105" width="300" height="55" rx="8" fill="#e0f2fe" stroke="#0284c7" stroke-width="2" filter="url(#shadow)"/>
                        <text x="450" y="125" text-anchor="middle" font-size="13" font-weight="600" fill="#0c4a6e">Condition変数 と</text>
                        <text x="450" y="145" text-anchor="middle" font-size="13" font-weight="600" fill="#0c4a6e">foo_printed = False 初期化</text>

                        <!-- 初期化→スレッド起動 -->
                        <path d="M 450 160 L 450 185" stroke="#475569" stroke-width="2" fill="none" marker-end="url(#arrow)"/>

                        <!-- ===== スレッド起動 ===== -->
                        <rect x="300" y="190" width="300" height="55" rx="8" fill="#e0f2fe" stroke="#0284c7" stroke-width="2" filter="url(#shadow)"/>
                        <text x="450" y="210" text-anchor="middle" font-size="13" font-weight="600" fill="#0c4a6e">スレッドA (foo) と</text>
                        <text x="450" y="230" text-anchor="middle" font-size="13" font-weight="600" fill="#0c4a6e">スレッドB (bar) 起動</text>

                        <!-- 分岐線 Thread A -->
                        <path d="M 300 217 L 210 217 L 210 290" stroke="#059669" stroke-width="2" fill="none" marker-end="url(#arrowGreen)"/>
                        <!-- 分岐線 Thread B -->
                        <path d="M 600 217 L 690 217 L 690 290" stroke="#0284c7" stroke-width="2" fill="none" marker-end="url(#arrowBlue)"/>

                        <!-- ===== Thread A タイトル ===== -->
                        <rect x="80" y="295" width="260" height="35" rx="6" fill="#059669"/>
                        <text x="210" y="318" text-anchor="middle" font-size="16" font-weight="700" fill="#ffffff">Thread A (foo)</text>

                        <!-- ===== Thread B タイトル ===== -->
                        <rect x="560" y="295" width="260" height="35" rx="6" fill="#0284c7"/>
                        <text x="690" y="318" text-anchor="middle" font-size="16" font-weight="700" fill="#ffffff">Thread B (bar)</text>

                        <!-- ===== Thread A: ロック取得 ===== -->
                        <rect x="80" y="355" width="260" height="50" rx="8" fill="#d1fae5" stroke="#059669" stroke-width="2" filter="url(#shadow)"/>
                        <text x="210" y="385" text-anchor="middle" font-size="14" font-weight="600" fill="#065f46">with cv: ロック取得</text>
                        <path d="M 210 330 L 210 355" stroke="#475569" stroke-width="2" fill="none" marker-end="url(#arrow)"/>

                        <!-- ===== Thread B: ロック取得 ===== -->
                        <rect x="560" y="355" width="260" height="50" rx="8" fill="#dbeafe" stroke="#0284c7" stroke-width="2" filter="url(#shadow)"/>
                        <text x="690" y="385" text-anchor="middle" font-size="14" font-weight="600" fill="#1e40af">with cv: ロック取得</text>
                        <path d="M 690 330 L 690 355" stroke="#475569" stroke-width="2" fill="none" marker-end="url(#arrow)"/>

                        <!-- ===== Thread A: 条件チェック ===== -->
                        <path d="M 210 450 L 290 495 L 210 540 L 130 495 Z" fill="#fef3c7" stroke="#d97706" stroke-width="2" filter="url(#shadow)"/>
                        <text x="210" y="488" text-anchor="middle" font-size="12" font-weight="600" fill="#92400e">foo_printed</text>
                        <text x="210" y="505" text-anchor="middle" font-size="12" font-weight="600" fill="#92400e">== True ?</text>
                        <path d="M 210 405 L 210 450" stroke="#475569" stroke-width="2" fill="none" marker-end="url(#arrow)"/>

                        <!-- ===== Thread B: 条件チェック ===== -->
                        <path d="M 690 450 L 770 495 L 690 540 L 610 495 Z" fill="#fef3c7" stroke="#d97706" stroke-width="2" filter="url(#shadow)"/>
                        <text x="690" y="488" text-anchor="middle" font-size="12" font-weight="600" fill="#92400e">foo_printed</text>
                        <text x="690" y="505" text-anchor="middle" font-size="12" font-weight="600" fill="#92400e">== False ?</text>
                        <path d="M 690 405 L 690 450" stroke="#475569" stroke-width="2" fill="none" marker-end="url(#arrow)"/>

                        <!-- ===== Thread A: cv.wait() ===== -->
                        <rect x="15" y="480" width="100" height="40" rx="6" fill="#fce7f3" stroke="#db2777" stroke-width="2"/>
                        <text x="65" y="505" text-anchor="middle" font-size="12" font-weight="600" fill="#9d174d">cv.wait()</text>
                        <!-- 条件→wait -->
                        <path d="M 130 495 L 115 495" stroke="#dc2626" stroke-width="2" fill="none" marker-end="url(#arrowRed)"/>
                        <!-- 「はい」ラベル（矢印の上） -->
                        <rect x="88" y="470" width="35" height="18" rx="3" fill="#fef2f2"/>
                        <text x="105" y="483" text-anchor="middle" font-size="11" font-weight="600" fill="#dc2626">はい</text>
                        <!-- wait→条件チェックへ戻る -->
                        <path d="M 65 480 L 65 435 L 175 435 L 175 450" stroke="#7c3aed" stroke-width="2" fill="none" marker-end="url(#arrowPurple)"/>
                        <rect x="75" y="418" width="60" height="16" rx="3" fill="#f5f3ff"/>
                        <text x="105" y="430" text-anchor="middle" font-size="10" font-weight="600" fill="#7c3aed">再チェック</text>

                        <!-- ===== Thread B: cv.wait() ===== -->
                        <rect x="785" y="480" width="100" height="40" rx="6" fill="#fce7f3" stroke="#db2777" stroke-width="2"/>
                        <text x="835" y="505" text-anchor="middle" font-size="12" font-weight="600" fill="#9d174d">cv.wait()</text>
                        <!-- 条件→wait -->
                        <path d="M 770 495 L 785 495" stroke="#dc2626" stroke-width="2" fill="none" marker-end="url(#arrowRed)"/>
                        <!-- 「はい」ラベル -->
                        <rect x="773" y="470" width="35" height="18" rx="3" fill="#fef2f2"/>
                        <text x="790" y="483" text-anchor="middle" font-size="11" font-weight="600" fill="#dc2626">はい</text>
                        <!-- wait→条件チェックへ戻る -->
                        <path d="M 835 480 L 835 435 L 725 435 L 725 450" stroke="#7c3aed" stroke-width="2" fill="none" marker-end="url(#arrowPurple)"/>
                        <rect x="765" y="418" width="60" height="16" rx="3" fill="#f5f3ff"/>
                        <text x="795" y="430" text-anchor="middle" font-size="10" font-weight="600" fill="#7c3aed">再チェック</text>

                        <!-- ===== Thread A: printFoo() ===== -->
                        <rect x="80" y="580" width="260" height="50" rx="8" fill="#d1fae5" stroke="#059669" stroke-width="2" filter="url(#shadow)"/>
                        <text x="210" y="610" text-anchor="middle" font-size="14" font-weight="700" fill="#065f46">printFoo()</text>
                        <!-- 条件→printFoo -->
                        <path d="M 210 540 L 210 580" stroke="#059669" stroke-width="2" fill="none" marker-end="url(#arrowGreen)"/>
                        <!-- 「いいえ」ラベル -->
                        <rect x="218" y="550" width="45" height="18" rx="3" fill="#ecfdf5"/>
                        <text x="240" y="563" text-anchor="middle" font-size="11" font-weight="600" fill="#059669">いいえ</text>

                        <!-- ===== Thread B: printBar() ===== -->
                        <rect x="560" y="580" width="260" height="50" rx="8" fill="#dbeafe" stroke="#0284c7" stroke-width="2" filter="url(#shadow)"/>
                        <text x="690" y="610" text-anchor="middle" font-size="14" font-weight="700" fill="#1e40af">printBar()</text>
                        <!-- 条件→printBar -->
                        <path d="M 690 540 L 690 580" stroke="#059669" stroke-width="2" fill="none" marker-end="url(#arrowGreen)"/>
                        <!-- 「いいえ」ラベル -->
                        <rect x="645" y="550" width="45" height="18" rx="3" fill="#ecfdf5"/>
                        <text x="667" y="563" text-anchor="middle" font-size="11" font-weight="600" fill="#059669">いいえ</text>

                        <!-- ===== Thread A: フラグ設定 ===== -->
                        <rect x="80" y="660" width="260" height="50" rx="8" fill="#d1fae5" stroke="#059669" stroke-width="2" filter="url(#shadow)"/>
                        <text x="210" y="690" text-anchor="middle" font-size="14" font-weight="600" fill="#065f46">foo_printed = True</text>
                        <path d="M 210 630 L 210 660" stroke="#475569" stroke-width="2" fill="none" marker-end="url(#arrow)"/>

                        <!-- ===== Thread B: フラグ設定 ===== -->
                        <rect x="560" y="660" width="260" height="50" rx="8" fill="#dbeafe" stroke="#0284c7" stroke-width="2" filter="url(#shadow)"/>
                        <text x="690" y="690" text-anchor="middle" font-size="14" font-weight="600" fill="#1e40af">foo_printed = False</text>
                        <path d="M 690 630 L 690 660" stroke="#475569" stroke-width="2" fill="none" marker-end="url(#arrow)"/>

                        <!-- ===== Thread A: notify ===== -->
                        <rect x="80" y="740" width="260" height="50" rx="8" fill="#d1fae5" stroke="#059669" stroke-width="2" filter="url(#shadow)"/>
                        <text x="210" y="760" text-anchor="middle" font-size="13" font-weight="600" fill="#065f46">cv.notify()</text>
                        <text x="210" y="778" text-anchor="middle" font-size="11" fill="#065f46">Thread B を起床</text>
                        <path d="M 210 710 L 210 740" stroke="#475569" stroke-width="2" fill="none" marker-end="url(#arrow)"/>

                        <!-- ===== Thread B: notify ===== -->
                        <rect x="560" y="740" width="260" height="50" rx="8" fill="#dbeafe" stroke="#0284c7" stroke-width="2" filter="url(#shadow)"/>
                        <text x="690" y="760" text-anchor="middle" font-size="13" font-weight="600" fill="#1e40af">cv.notify()</text>
                        <text x="690" y="778" text-anchor="middle" font-size="11" fill="#1e40af">Thread A を起床</text>
                        <path d="M 690 710 L 690 740" stroke="#475569" stroke-width="2" fill="none" marker-end="url(#arrow)"/>

                        <!-- ===== Thread A: ループチェック ===== -->
                        <path d="M 210 845 L 290 895 L 210 945 L 130 895 Z" fill="#fef3c7" stroke="#d97706" stroke-width="2" filter="url(#shadow)"/>
                        <text x="210" y="888" text-anchor="middle" font-size="12" font-weight="600" fill="#92400e">さらに</text>
                        <text x="210" y="905" text-anchor="middle" font-size="12" font-weight="600" fill="#92400e">イテレーション?</text>
                        <path d="M 210 790 L 210 845" stroke="#475569" stroke-width="2" fill="none" marker-end="url(#arrow)"/>

                        <!-- ===== Thread B: ループチェック ===== -->
                        <path d="M 690 845 L 770 895 L 690 945 L 610 895 Z" fill="#fef3c7" stroke="#d97706" stroke-width="2" filter="url(#shadow)"/>
                        <text x="690" y="888" text-anchor="middle" font-size="12" font-weight="600" fill="#92400e">さらに</text>
                        <text x="690" y="905" text-anchor="middle" font-size="12" font-weight="600" fill="#92400e">イテレーション?</text>
                        <path d="M 690 790 L 690 845" stroke="#475569" stroke-width="2" fill="none" marker-end="url(#arrow)"/>

                        <!-- Thread A: ループバック（はい） -->
                        <path d="M 130 895 L 50 895 L 50 380 L 80 380" stroke="#7c3aed" stroke-width="2" fill="none" marker-end="url(#arrowPurple)"/>
                        <rect x="30" y="630" width="30" height="18" rx="3" fill="#f5f3ff"/>
                        <text x="45" y="643" text-anchor="middle" font-size="11" font-weight="600" fill="#7c3aed">はい</text>

                        <!-- Thread B: ループバック（はい） -->
                        <path d="M 770 895 L 850 895 L 850 380 L 820 380" stroke="#7c3aed" stroke-width="2" fill="none" marker-end="url(#arrowPurple)"/>
                        <rect x="838" y="630" width="30" height="18" rx="3" fill="#f5f3ff"/>
                        <text x="853" y="643" text-anchor="middle" font-size="11" font-weight="600" fill="#7c3aed">はい</text>

                        <!-- ===== 終了 ===== -->
                        <ellipse cx="450" cy="1050" rx="90" ry="30" fill="#10b981" stroke="#059669" stroke-width="2" filter="url(#shadow)"/>
                        <text x="450" y="1050" text-anchor="middle" dominant-baseline="middle" font-size="16" font-weight="700" fill="#ffffff">終了</text>

                        <!-- Thread A → 終了 -->
                        <path d="M 210 945 L 210 1010 L 360 1050" stroke="#059669" stroke-width="2" fill="none" marker-end="url(#arrowGreen)"/>
                        <rect x="218" y="965" width="50" height="18" rx="3" fill="#ecfdf5"/>
                        <text x="243" y="978" text-anchor="middle" font-size="11" font-weight="600" fill="#059669">いいえ</text>

                        <!-- Thread B → 終了 -->
                        <path d="M 690 945 L 690 1010 L 540 1050" stroke="#059669" stroke-width="2" fill="none" marker-end="url(#arrowGreen)"/>
                        <rect x="637" y="965" width="50" height="18" rx="3" fill="#ecfdf5"/>
                        <text x="662" y="978" text-anchor="middle" font-size="11" font-weight="600" fill="#059669">いいえ</text>

                        <!-- ===== 凡例 ===== -->
                        <rect x="300" y="1120" width="300" height="140" rx="10" fill="#f8fafc" stroke="#e2e8f0" stroke-width="1"/>
                        <text x="450" y="1145" text-anchor="middle" font-size="14" font-weight="700" fill="#334155">凡例</text>

                        <rect x="320" y="1160" width="20" height="15" rx="3" fill="#d1fae5" stroke="#059669" stroke-width="1"/>
                        <text x="350" y="1172" font-size="11" fill="#334155">Thread A の処理</text>

                        <rect x="480" y="1160" width="20" height="15" rx="3" fill="#dbeafe" stroke="#0284c7" stroke-width="1"/>
                        <text x="510" y="1172" font-size="11" fill="#334155">Thread B の処理</text>

                        <path d="M 320 1195 L 340 1195" stroke="#059669" stroke-width="2" fill="none" marker-end="url(#arrowGreen)"/>
                        <text x="350" y="1198" font-size="11" fill="#334155">実行フロー</text>

                        <path d="M 480 1195 L 500 1195" stroke="#dc2626" stroke-width="2" fill="none" marker-end="url(#arrowRed)"/>
                        <text x="510" y="1198" font-size="11" fill="#334155">待機 (wait)</text>

                        <path d="M 320 1220 L 340 1220" stroke="#7c3aed" stroke-width="2" fill="none" marker-end="url(#arrowPurple)"/>
                        <text x="350" y="1223" font-size="11" fill="#334155">ループバック</text>

                        <path d="M 400 1235 L 420 1235 L 440 1255 L 420 1275 L 400 1275 Z" fill="#fef3c7" stroke="#d97706" stroke-width="1" transform="scale(0.5) translate(800,2370)"/>
                        <text x="510" y="1248" font-size="11" fill="#334155">条件分岐</text>
                    </svg>
                </div>

                <p class="mt-8 font-[Source_Code_Pro] text-[20px] font-semibold">
                    <strong class="text-2xl">フローの説明：</strong><br />
                    1. 初期化: Condition変数とfoo_printed=Falseを設定<br />
                    2. 並行実行: Thread AとThread Bが同時に起動<br />
                    3. Thread A: foo_printed==Trueなら待機（while+wait）、Falseなら実行<br />
                    4. Thread A: printFoo()後、foo_printed=Trueに設定してThread Bを通知<br />
                    5. Thread B: foo_printed==Falseなら待機、Trueなら実行<br />
                    6. Thread B: printBar()後、foo_printed=Falseに戻してThread Aを通知<br />
                    7. ループ: 両スレッドがn回繰り返し、終了時に合流
                </p>
            </section>

            <section id="complexity" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="text-[2rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    計算量分析
                </h2>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-emerald-50">
                                <th
                                    class="border-2 border-emerald-200 px-4 py-3 text-left font-semibold text-teal-800"
                                >
                                    項目
                                </th>
                                <th
                                    class="border-2 border-emerald-200 px-4 py-3 text-left font-semibold text-teal-800"
                                >
                                    計算量
                                </th>
                                <th
                                    class="border-2 border-emerald-200 px-4 py-3 text-left font-semibold text-teal-800"
                                >
                                    説明
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border-2 border-slate-200 px-4 py-3 font-semibold">
                                    時間計算量
                                </td>
                                <td class="border-2 border-slate-200 px-4 py-3">
                                    <code class="px-2 py-1 bg-slate-100 rounded">O(n)</code>
                                </td>
                                <td class="border-2 border-slate-200 px-4 py-3">
                                    各スレッドがn回のイテレーション
                                </td>
                            </tr>
                            <tr class="bg-slate-50">
                                <td class="border-2 border-slate-200 px-4 py-3 font-semibold">
                                    空間計算量
                                </td>
                                <td class="border-2 border-slate-200 px-4 py-3">
                                    <code class="px-2 py-1 bg-slate-100 rounded">O(1)</code>
                                </td>
                                <td class="border-2 border-slate-200 px-4 py-3">
                                    固定サイズの同期オブジェクトのみ
                                </td>
                            </tr>
                            <tr>
                                <td class="border-2 border-slate-200 px-4 py-3 font-semibold">
                                    wait/notify コスト
                                </td>
                                <td class="border-2 border-slate-200 px-4 py-3">
                                    <code class="px-2 py-1 bg-slate-100 rounded">O(1)</code>
                                </td>
                                <td class="border-2 border-slate-200 px-4 py-3">
                                    各操作は定数時間
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="text-xl font-semibold text-teal-800 mt-8 mb-4">代替実装との比較</h3>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-sky-50">
                                <th
                                    class="border-2 border-sky-200 px-4 py-3 text-left font-semibold text-sky-800"
                                >
                                    実装方式
                                </th>
                                <th
                                    class="border-2 border-sky-200 px-4 py-3 text-left font-semibold text-sky-800"
                                >
                                    メモリ
                                </th>
                                <th
                                    class="border-2 border-sky-200 px-4 py-3 text-left font-semibold text-sky-800"
                                >
                                    Runtime
                                </th>
                                <th
                                    class="border-2 border-sky-200 px-4 py-3 text-left font-semibold text-sky-800"
                                >
                                    特徴
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-emerald-50">
                                <td class="border-2 border-slate-200 px-4 py-3 font-semibold">
                                    Condition変数 ⭐
                                </td>
                                <td class="border-2 border-slate-200 px-4 py-3">19.8MB</td>
                                <td class="border-2 border-slate-200 px-4 py-3">55-65ms</td>
                                <td class="border-2 border-slate-200 px-4 py-3">バランス最優秀</td>
                            </tr>
                            <tr>
                                <td class="border-2 border-slate-200 px-4 py-3">Semaphore 2個</td>
                                <td class="border-2 border-slate-200 px-4 py-3">20.0MB</td>
                                <td class="border-2 border-slate-200 px-4 py-3">65-70ms</td>
                                <td class="border-2 border-slate-200 px-4 py-3">直感的だが重い</td>
                            </tr>
                            <tr class="bg-slate-50">
                                <td class="border-2 border-slate-200 px-4 py-3">Lock + Event</td>
                                <td class="border-2 border-slate-200 px-4 py-3">19.9MB</td>
                                <td class="border-2 border-slate-200 px-4 py-3">60-68ms</td>
                                <td class="border-2 border-slate-200 px-4 py-3">軽量だが複雑</td>
                            </tr>
                            <tr>
                                <td class="border-2 border-slate-200 px-4 py-3">
                                    Lock + busy-wait
                                </td>
                                <td class="border-2 border-slate-200 px-4 py-3">19.7MB</td>
                                <td class="border-2 border-slate-200 px-4 py-3">TLE</td>
                                <td class="border-2 border-slate-200 px-4 py-3">CPU消費大</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="text-xl font-semibold text-teal-800 mt-8 mb-4">最適化のポイント</h3>
                <ul class="list-disc list-inside text-slate-700 leading-7 space-y-2">
                    <li>
                        <code class="px-2 py-1 bg-slate-100 rounded">with</code>
                        文による自動ロック管理で例外安全性を確保
                    </li>
                    <li>
                        <code class="px-2 py-1 bg-slate-100 rounded">while</code>
                        ループでスプリアス・ウェイクアップに対応
                    </li>
                    <li>単一Condition変数で両方向の同期を実現（Semaphore 2個より軽量）</li>
                    <li>
                        <code class="px-2 py-1 bg-slate-100 rounded">notify()</code>
                        は待機中のスレッドのみ起床（効率的）
                    </li>
                    <li>
                        フラグ（<code class="px-2 py-1 bg-slate-100 rounded">bool</code
                        >）は1バイトでキャッシュ効率が高い
                    </li>
                </ul>
            </section>
        </div>

        <script type="text/babel">
            const { useState, useEffect, useRef } = React;

            const StepVisualization = () => {
                const [activeStep, setActiveStep] = useState(1);
                const [isPlaying, setIsPlaying] = useState(false);
                const timerRef = useRef(null);

                const stepsData = [
                    {
                        step: 1,
                        title: '初期化',
                        desc: 'Condition変数と状態フラグを初期化します。foo_printed = Falseにより、必ずThread A（foo）から開始されることが保証されます。',
                        visual: { type: 'init' },
                    },
                    {
                        step: 2,
                        title: 'Thread A: ロック取得',
                        desc: 'Thread Aが with cv: でロックを取得します。このロックにより、Thread AとThread Bが同時にクリティカルセクションに入ることを防ぎます。',
                        visual: { type: 'lockA' },
                    },
                    {
                        step: 3,
                        title: 'Thread A: 条件チェック',
                        desc: 'foo_printed == True かチェックします。初回はFalseなので、wait()をスキップしてprintFoo()を実行できます。',
                        visual: { type: 'checkA', fooPrinted: false },
                    },
                    {
                        step: 4,
                        title: 'Thread A: printFoo() 実行',
                        desc: 'printFoo()を呼び出して "foo" を出力します。この後、foo_printed = True に設定します。',
                        visual: { type: 'printFoo' },
                    },
                    {
                        step: 5,
                        title: 'Thread A: フラグ設定とnotify',
                        desc: 'foo_printed = True に設定し、cv.notify() でThread Bを起床させます。その後、ロックを解放します。',
                        visual: { type: 'notifyB', fooPrinted: true },
                    },
                    {
                        step: 6,
                        title: 'Thread B: ロック取得',
                        desc: 'Thread Bが with cv: でロックを取得します。Thread Aがロックを解放した後に取得できます。',
                        visual: { type: 'lockB' },
                    },
                    {
                        step: 7,
                        title: 'Thread B: 条件チェック',
                        desc: 'foo_printed == False かチェックします。現在はTrueなので、wait()をスキップしてprintBar()を実行できます。',
                        visual: { type: 'checkB', fooPrinted: true },
                    },
                    {
                        step: 8,
                        title: 'Thread B: printBar() 実行',
                        desc: 'printBar()を呼び出して "bar" を出力します。この後、foo_printed = False に戻します。',
                        visual: { type: 'printBar' },
                    },
                    {
                        step: 9,
                        title: 'Thread B: フラグリセットとnotify',
                        desc: 'foo_printed = False に戻し、cv.notify() でThread Aを起床させます。これで1サイクル完了し、次のイテレーションへ進みます。',
                        visual: { type: 'notifyA', fooPrinted: false },
                    },
                    {
                        step: 10,
                        title: 'ループ継続',
                        desc: '両スレッドがn回のイテレーションを繰り返します。foo_printed フラグと notify() により、必ず交互実行が保証されます。',
                        visual: { type: 'loop' },
                    },
                    {
                        step: 11,
                        title: 'スプリアス・ウェイクアップ対策',
                        desc: 'while ループにより、偽の起床（spurious wakeup）が発生しても条件を再チェックします。if 文だと危険です。',
                        visual: { type: 'spurious' },
                    },
                    {
                        step: 12,
                        title: '完了',
                        desc: "両スレッドがn回の実行を完了し、出力 'foobar' * n が得られます。デッドロックなく安全に終了します。",
                        visual: { type: 'complete' },
                    },
                ];

                useEffect(() => {
                    if (isPlaying) {
                        if (activeStep >= stepsData.length) {
                            setIsPlaying(false);
                            setActiveStep(1);
                            return;
                        }
                        timerRef.current = setTimeout(() => {
                            setActiveStep((prev) => prev + 1);
                        }, 2000);
                    }
                    return () => {
                        if (timerRef.current) clearTimeout(timerRef.current);
                    };
                }, [isPlaying, activeStep]);

                const handlePlay = () => {
                    if (isPlaying) return;
                    setIsPlaying(true);
                    if (activeStep === stepsData.length) {
                        setActiveStep(1);
                    }
                };

                const handlePrev = () => {
                    if (activeStep > 1) {
                        setActiveStep((prev) => prev - 1);
                        setIsPlaying(false);
                    }
                };

                const handleNext = () => {
                    if (activeStep < stepsData.length) {
                        setActiveStep((prev) => prev + 1);
                        setIsPlaying(false);
                    }
                };

                const handleReset = () => {
                    setActiveStep(1);
                    setIsPlaying(false);
                };

                const handleStepClick = (step) => {
                    setActiveStep(step);
                    setIsPlaying(false);
                };

                const currentStepData = stepsData[activeStep - 1];

                const VisualComponent = ({ visual }) => {
                    if (visual.type === 'init') {
                        return (
                            <svg
                                viewBox="0 0 600 300"
                                style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            >
                                <rect
                                    x="200"
                                    y="80"
                                    width="200"
                                    height="80"
                                    rx="8"
                                    fill="#e0f2fe"
                                    stroke="#0284c7"
                                    strokeWidth="2"
                                />
                                <text
                                    x="300"
                                    y="120"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="18"
                                    fontWeight="600"
                                    fill="#0284c7"
                                >
                                    Condition変数 (cv)
                                </text>

                                <rect
                                    x="200"
                                    y="180"
                                    width="200"
                                    height="60"
                                    rx="8"
                                    fill="#fef3c7"
                                    stroke="#f59e0b"
                                    strokeWidth="2"
                                />
                                <text
                                    x="300"
                                    y="210"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="18"
                                    fontWeight="600"
                                    fill="#f59e0b"
                                >
                                    foo_printed = False
                                </text>
                            </svg>
                        );
                    }

                    if (visual.type === 'lockA') {
                        return (
                            <svg
                                viewBox="0 0 600 300"
                                style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            >
                                <rect
                                    x="150"
                                    y="60"
                                    width="120"
                                    height="80"
                                    rx="8"
                                    fill="#d1fae5"
                                    stroke="#10b981"
                                    strokeWidth="2"
                                />
                                <text
                                    x="210"
                                    y="100"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="18"
                                    fontWeight="600"
                                    fill="#059669"
                                >
                                    Thread A
                                </text>

                                <path
                                    d="M 270 100 L 320 100"
                                    stroke="#059669"
                                    strokeWidth="3"
                                    fill="none"
                                    markerEnd="url(#arrowGreen)"
                                />

                                <rect
                                    x="320"
                                    y="60"
                                    width="140"
                                    height="80"
                                    rx="8"
                                    fill="#e0f2fe"
                                    stroke="#0284c7"
                                    strokeWidth="2"
                                />
                                <text
                                    x="390"
                                    y="90"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                    fill="#0284c7"
                                >
                                    ロック取得
                                </text>
                                <text
                                    x="390"
                                    y="115"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="14"
                                    fill="#64748b"
                                >
                                    with cv:
                                </text>

                                <text
                                    x="300"
                                    y="180"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="18"
                                    fontWeight="600"
                                    fill="#64748b"
                                >
                                    クリティカルセクション開始
                                </text>
                            </svg>
                        );
                    }

                    if (visual.type === 'checkA') {
                        return (
                            <svg
                                viewBox="0 0 600 350"
                                style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            >
                                <path
                                    d="M 300 150 L 400 200 L 300 250 L 200 200 Z"
                                    fill="#fef3c7"
                                    stroke="#f59e0b"
                                    strokeWidth="2"
                                />
                                <text
                                    x="300"
                                    y="200"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                >
                                    <tspan x="300" dy="-8">
                                        foo_printed
                                    </tspan>
                                    <tspan x="300" dy="18">
                                        == True?
                                    </tspan>
                                </text>

                                <text
                                    x="150"
                                    y="200"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                    fill="#dc2626"
                                >
                                    はい → wait()
                                </text>

                                <text
                                    x="300"
                                    y="290"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                    fill="#059669"
                                >
                                    いいえ → printFoo()
                                </text>

                                <text
                                    x="300"
                                    y="80"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="18"
                                    fontWeight="600"
                                    fill="#64748b"
                                >
                                    現在: foo_printed = {visual.fooPrinted ? 'True' : 'False'}
                                </text>
                            </svg>
                        );
                    }

                    if (visual.type === 'printFoo') {
                        return (
                            <svg
                                viewBox="0 0 600 300"
                                style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            >
                                <rect
                                    x="200"
                                    y="80"
                                    width="200"
                                    height="80"
                                    rx="8"
                                    fill="#d1fae5"
                                    stroke="#10b981"
                                    strokeWidth="3"
                                />
                                <text
                                    x="300"
                                    y="120"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="24"
                                    fontWeight="700"
                                    fill="#059669"
                                >
                                    printFoo()
                                </text>

                                <text
                                    x="300"
                                    y="200"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="20"
                                    fontWeight="600"
                                    fill="#64748b"
                                >
                                    出力: "foo"
                                </text>
                            </svg>
                        );
                    }

                    if (visual.type === 'notifyB') {
                        return (
                            <svg
                                viewBox="0 0 600 350"
                                style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            >
                                <rect
                                    x="150"
                                    y="60"
                                    width="140"
                                    height="60"
                                    rx="8"
                                    fill="#fef3c7"
                                    stroke="#f59e0b"
                                    strokeWidth="2"
                                />
                                <text
                                    x="220"
                                    y="90"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                    fill="#f59e0b"
                                >
                                    <tspan x="220" dy="-8">
                                        foo_printed =
                                    </tspan>
                                    <tspan x="220" dy="18">
                                        True
                                    </tspan>
                                </text>

                                <path
                                    d="M 220 120 L 220 180"
                                    stroke="#64748b"
                                    strokeWidth="3"
                                    fill="none"
                                    markerEnd="url(#arrow)"
                                />

                                <rect
                                    x="150"
                                    y="180"
                                    width="140"
                                    height="60"
                                    rx="8"
                                    fill="#e0f2fe"
                                    stroke="#0284c7"
                                    strokeWidth="2"
                                />
                                <text
                                    x="220"
                                    y="210"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                    fill="#0284c7"
                                >
                                    cv.notify()
                                </text>

                                <path
                                    d="M 290 210 L 340 210"
                                    stroke="#a855f7"
                                    strokeWidth="3"
                                    fill="none"
                                    markerEnd="url(#arrowPurple)"
                                />

                                <rect
                                    x="340"
                                    y="180"
                                    width="140"
                                    height="60"
                                    rx="8"
                                    fill="#d1fae5"
                                    stroke="#10b981"
                                    strokeWidth="2"
                                />
                                <text
                                    x="410"
                                    y="210"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                    fill="#059669"
                                >
                                    <tspan x="410" dy="-8">
                                        Thread B
                                    </tspan>
                                    <tspan x="410" dy="18">
                                        起床
                                    </tspan>
                                </text>
                            </svg>
                        );
                    }

                    if (visual.type === 'lockB') {
                        return (
                            <svg
                                viewBox="0 0 600 300"
                                style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            >
                                <rect
                                    x="150"
                                    y="60"
                                    width="120"
                                    height="80"
                                    rx="8"
                                    fill="#e0f2fe"
                                    stroke="#0284c7"
                                    strokeWidth="2"
                                />
                                <text
                                    x="210"
                                    y="100"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="18"
                                    fontWeight="600"
                                    fill="#0284c7"
                                >
                                    Thread B
                                </text>

                                <path
                                    d="M 270 100 L 320 100"
                                    stroke="#0284c7"
                                    strokeWidth="3"
                                    fill="none"
                                    markerEnd="url(#arrow)"
                                />

                                <rect
                                    x="320"
                                    y="60"
                                    width="140"
                                    height="80"
                                    rx="8"
                                    fill="#e0f2fe"
                                    stroke="#0284c7"
                                    strokeWidth="2"
                                />
                                <text
                                    x="390"
                                    y="90"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                    fill="#0284c7"
                                >
                                    ロック取得
                                </text>
                                <text
                                    x="390"
                                    y="115"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="14"
                                    fill="#64748b"
                                >
                                    with cv:
                                </text>

                                <text
                                    x="300"
                                    y="180"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="18"
                                    fontWeight="600"
                                    fill="#64748b"
                                >
                                    Thread Aがロック解放後に取得
                                </text>
                            </svg>
                        );
                    }

                    if (visual.type === 'checkB') {
                        return (
                            <svg
                                viewBox="0 0 600 350"
                                style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            >
                                <path
                                    d="M 300 150 L 400 200 L 300 250 L 200 200 Z"
                                    fill="#fef3c7"
                                    stroke="#f59e0b"
                                    strokeWidth="2"
                                />
                                <text
                                    x="300"
                                    y="200"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                >
                                    <tspan x="300" dy="-8">
                                        foo_printed
                                    </tspan>
                                    <tspan x="300" dy="18">
                                        == False?
                                    </tspan>
                                </text>

                                <text
                                    x="150"
                                    y="200"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                    fill="#dc2626"
                                >
                                    はい → wait()
                                </text>

                                <text
                                    x="300"
                                    y="290"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                    fill="#059669"
                                >
                                    いいえ → printBar()
                                </text>

                                <text
                                    x="300"
                                    y="80"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="18"
                                    fontWeight="600"
                                    fill="#64748b"
                                >
                                    現在: foo_printed = {visual.fooPrinted ? 'True' : 'False'}
                                </text>
                            </svg>
                        );
                    }

                    if (visual.type === 'printBar') {
                        return (
                            <svg
                                viewBox="0 0 600 300"
                                style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            >
                                <rect
                                    x="200"
                                    y="80"
                                    width="200"
                                    height="80"
                                    rx="8"
                                    fill="#e0f2fe"
                                    stroke="#0284c7"
                                    strokeWidth="3"
                                />
                                <text
                                    x="300"
                                    y="120"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="24"
                                    fontWeight="700"
                                    fill="#0284c7"
                                >
                                    printBar()
                                </text>

                                <text
                                    x="300"
                                    y="200"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="20"
                                    fontWeight="600"
                                    fill="#64748b"
                                >
                                    出力: "bar"
                                </text>
                            </svg>
                        );
                    }

                    if (visual.type === 'notifyA') {
                        return (
                            <svg
                                viewBox="0 0 600 350"
                                style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            >
                                <rect
                                    x="150"
                                    y="60"
                                    width="140"
                                    height="60"
                                    rx="8"
                                    fill="#fef3c7"
                                    stroke="#f59e0b"
                                    strokeWidth="2"
                                />
                                <text
                                    x="220"
                                    y="90"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                    fill="#f59e0b"
                                >
                                    <tspan x="220" dy="-8">
                                        foo_printed =
                                    </tspan>
                                    <tspan x="220" dy="18">
                                        False
                                    </tspan>
                                </text>

                                <path
                                    d="M 220 120 L 220 180"
                                    stroke="#64748b"
                                    strokeWidth="3"
                                    fill="none"
                                    markerEnd="url(#arrow)"
                                />

                                <rect
                                    x="150"
                                    y="180"
                                    width="140"
                                    height="60"
                                    rx="8"
                                    fill="#e0f2fe"
                                    stroke="#0284c7"
                                    strokeWidth="2"
                                />
                                <text
                                    x="220"
                                    y="210"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                    fill="#0284c7"
                                >
                                    cv.notify()
                                </text>

                                <path
                                    d="M 290 210 L 340 210"
                                    stroke="#a855f7"
                                    strokeWidth="3"
                                    fill="none"
                                    markerEnd="url(#arrowPurple)"
                                />

                                <rect
                                    x="340"
                                    y="180"
                                    width="140"
                                    height="60"
                                    rx="8"
                                    fill="#d1fae5"
                                    stroke="#10b981"
                                    strokeWidth="2"
                                />
                                <text
                                    x="410"
                                    y="210"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                    fill="#059669"
                                >
                                    <tspan x="410" dy="-8">
                                        Thread A
                                    </tspan>
                                    <tspan x="410" dy="18">
                                        起床
                                    </tspan>
                                </text>
                            </svg>
                        );
                    }

                    if (visual.type === 'loop') {
                        return (
                            <svg
                                viewBox="0 0 600 350"
                                style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            >
                                <rect
                                    x="100"
                                    y="80"
                                    width="160"
                                    height="80"
                                    rx="8"
                                    fill="#d1fae5"
                                    stroke="#10b981"
                                    strokeWidth="2"
                                />
                                <text
                                    x="180"
                                    y="120"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="18"
                                    fontWeight="600"
                                    fill="#059669"
                                >
                                    <tspan x="180" dy="-8">
                                        Thread A
                                    </tspan>
                                    <tspan x="180" dy="18">
                                        foo → notify
                                    </tspan>
                                </text>

                                <path
                                    d="M 260 120 L 340 120"
                                    stroke="#a855f7"
                                    strokeWidth="3"
                                    fill="none"
                                    markerEnd="url(#arrowPurple)"
                                />
                                <path
                                    d="M 340 120 L 260 120"
                                    stroke="#a855f7"
                                    strokeWidth="3"
                                    fill="none"
                                    markerEnd="url(#arrowPurple)"
                                />

                                <rect
                                    x="340"
                                    y="80"
                                    width="160"
                                    height="80"
                                    rx="8"
                                    fill="#e0f2fe"
                                    stroke="#0284c7"
                                    strokeWidth="2"
                                />
                                <text
                                    x="420"
                                    y="120"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="18"
                                    fontWeight="600"
                                    fill="#0284c7"
                                >
                                    <tspan x="420" dy="-8">
                                        Thread B
                                    </tspan>
                                    <tspan x="420" dy="18">
                                        bar → notify
                                    </tspan>
                                </text>

                                <text
                                    x="300"
                                    y="220"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="18"
                                    fontWeight="600"
                                    fill="#64748b"
                                >
                                    n回のイテレーション継続
                                </text>

                                <text
                                    x="300"
                                    y="260"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fill="#64748b"
                                >
                                    出力: "foobar" * n
                                </text>
                            </svg>
                        );
                    }

                    if (visual.type === 'spurious') {
                        return (
                            <svg
                                viewBox="0 0 600 400"
                                style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            >
                                <defs>
                                    <marker
                                        id="arrowGreen"
                                        markerWidth="10"
                                        markerHeight="10"
                                        refX="9"
                                        refY="3"
                                        orient="auto"
                                        markerUnits="strokeWidth"
                                    >
                                        <path d="M0,0 L0,6 L9,3 z" fill="#059669" />
                                    </marker>
                                    <marker
                                        id="arrowRed"
                                        markerWidth="10"
                                        markerHeight="10"
                                        refX="9"
                                        refY="3"
                                        orient="auto"
                                        markerUnits="strokeWidth"
                                    >
                                        <path d="M0,0 L0,6 L9,3 z" fill="#dc2626" />
                                    </marker>
                                </defs>

                                <rect
                                    x="50"
                                    y="50"
                                    width="200"
                                    height="120"
                                    rx="8"
                                    fill="#fee2e2"
                                    stroke="#dc2626"
                                    strokeWidth="2"
                                />
                                <text
                                    x="150"
                                    y="80"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                    fill="#dc2626"
                                >
                                    ❌ if 文（危険）
                                </text>
                                <text
                                    x="150"
                                    y="110"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="14"
                                    fill="#64748b"
                                >
                                    <tspan x="150" dy="-8">
                                        if foo_printed:
                                    </tspan>
                                    <tspan x="150" dy="18">
                                        {' '}
                                        cv.wait()
                                    </tspan>
                                </text>
                                <text
                                    x="150"
                                    y="150"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="12"
                                    fill="#dc2626"
                                >
                                    起床後に再チェックしない
                                </text>

                                <rect
                                    x="350"
                                    y="50"
                                    width="200"
                                    height="120"
                                    rx="8"
                                    fill="#d1fae5"
                                    stroke="#10b981"
                                    strokeWidth="2"
                                />
                                <text
                                    x="450"
                                    y="80"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                    fill="#059669"
                                >
                                    ✅ while 文（安全）
                                </text>
                                <text
                                    x="450"
                                    y="110"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="14"
                                    fill="#64748b"
                                >
                                    <tspan x="450" dy="-8">
                                        while foo_printed:
                                    </tspan>
                                    <tspan x="450" dy="18">
                                        {' '}
                                        cv.wait()
                                    </tspan>
                                </text>
                                <text
                                    x="450"
                                    y="150"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="12"
                                    fill="#059669"
                                >
                                    起床後に条件を再チェック
                                </text>

                                <text
                                    x="300"
                                    y="230"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="18"
                                    fontWeight="600"
                                    fill="#64748b"
                                >
                                    スプリアス・ウェイクアップ対策
                                </text>

                                <text
                                    x="300"
                                    y="270"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="14"
                                    fill="#64748b"
                                >
                                    <tspan x="300" dy="-8">
                                        OSレベルで偽の起床が発生する可能性がある
                                    </tspan>
                                    <tspan x="300" dy="18">
                                        while ループで条件を再確認することで安全性を確保
                                    </tspan>
                                </text>
                            </svg>
                        );
                    }

                    if (visual.type === 'complete') {
                        return (
                            <svg
                                viewBox="0 0 600 300"
                                style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            >
                                <rect
                                    x="150"
                                    y="80"
                                    width="300"
                                    height="100"
                                    rx="8"
                                    fill="#d1fae5"
                                    stroke="#10b981"
                                    strokeWidth="3"
                                />
                                <text
                                    x="300"
                                    y="120"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="24"
                                    fontWeight="700"
                                    fill="#059669"
                                >
                                    完了 ✓
                                </text>
                                <text
                                    x="300"
                                    y="150"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="18"
                                    fill="#64748b"
                                >
                                    出力: "foobar" * n
                                </text>

                                <text
                                    x="300"
                                    y="220"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="16"
                                    fontWeight="600"
                                    fill="#64748b"
                                >
                                    デッドロックなく安全に終了
                                </text>
                            </svg>
                        );
                    }

                    return null;
                };

                return (
                    <div className="grid grid-cols-1 md:grid-cols-[1fr_2fr] gap-8 mt-2">
                        <div>
                            <h3 className="mt-0 mb-4 text-teal-800 text-xl font-semibold">
                                ステップ一覧
                            </h3>
                            <div className="space-y-2">
                                {stepsData.map((step) => {
                                    const isActive = activeStep === step.step;
                                    return (
                                        <button
                                            key={step.step}
                                            type="button"
                                            className={[
                                                'w-full text-left text-[0.95rem] rounded-xl border-2 transition cursor-pointer px-4 py-4',
                                                'bg-white border-slate-200 hover:border-emerald-500 hover:translate-x-1',
                                                isActive
                                                    ? 'bg-[linear-gradient(135deg,#d1fae5,#a7f3d0)] border-emerald-500 shadow-[0_4px_12px_rgba(16,185,129,0.20)]'
                                                    : '',
                                            ].join(' ')}
                                            onClick={() => handleStepClick(step.step)}
                                            aria-label={`ステップ${step.step}: ${step.title}`}
                                            aria-current={isActive ? 'step' : undefined}
                                        >
                                            <div
                                                className={[
                                                    'font-bold mb-1',
                                                    isActive ? 'text-emerald-900' : 'text-teal-800',
                                                ].join(' ')}
                                            >
                                                Step {step.step}: {step.title}
                                            </div>
                                            <div className="text-slate-500 text-sm mt-1">
                                                {step.desc.substring(0, 50)}
                                                {step.desc.length > 50 ? '...' : ''}
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="my-auto">
                            <div className="rounded-2xl p-8 mt-10 border-2 border-emerald-200 bg-[linear-gradient(135deg,#ecfdf5,#f0f9ff)]">
                                <h3 className="mt-0 text-teal-800 text-xl font-semibold">
                                    Step {currentStepData.step}: {currentStepData.title}
                                </h3>
                                <p className="text-slate-600 leading-7">{currentStepData.desc}</p>
                            </div>

                            <VisualComponent visual={currentStepData.visual} />

                            <div className="flex flex-wrap justify-center gap-2 mt-1">
                                <button
                                    type="button"
                                    className="px-6 py-3 rounded-xl font-semibold text-white transition disabled:opacity-50 shadow hover:-translate-y-0.5 hover:shadow-[0_8px_16px_rgba(16,185,129,0.30)] bg-[linear-gradient(135deg,#10b981,#059669)]"
                                    onClick={handlePlay}
                                    disabled={isPlaying}
                                    aria-label="自動再生"
                                >
                                    ▶ Play
                                </button>
                                <button
                                    type="button"
                                    className="px-6 py-3 rounded-xl font-semibold text-white transition disabled:opacity-50 shadow hover:-translate-y-0.5 hover:shadow-[0_8px_16px_rgba(16,185,129,0.30)] bg-[linear-gradient(135deg,#0ea5e9,#0284c7)]"
                                    onClick={handlePrev}
                                    disabled={activeStep === 1}
                                    aria-label="前のステップ"
                                >
                                    ◀ Prev
                                </button>
                                <button
                                    type="button"
                                    className="px-6 py-3 rounded-xl font-semibold text-white transition disabled:opacity-50 shadow hover:-translate-y-0.5 hover:shadow-[0_8px_16px_rgba(16,185,129,0.30)] bg-[linear-gradient(135deg,#0ea5e9,#0284c7)]"
                                    onClick={handleNext}
                                    disabled={activeStep === stepsData.length}
                                    aria-label="次のステップ"
                                >
                                    Next ▶
                                </button>
                                <button
                                    type="button"
                                    className="px-6 py-3 rounded-xl font-semibold text-white transition shadow hover:-translate-y-0.5 hover:shadow-[0_8px_16px_rgba(16,185,129,0.30)] bg-[linear-gradient(135deg,#64748b,#475569)]"
                                    onClick={handleReset}
                                    aria-label="リセット"
                                >
                                    🔄 Reset
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            ReactDOM.render(
                <StepVisualization />,
                document.getElementById('step-visualization-root'),
            );
        </script>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                Prism.highlightAll();
            });
        </script>
    </body>
</html>
