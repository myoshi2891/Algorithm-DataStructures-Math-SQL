<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>
            Largest Rectangle in Histogram — 技術解説（単調増加スタック法 / Python, Tailwind版）
        </title>

        <!-- Tailwind CSS (CDN) -->
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            brand: { DEFAULT: '#2563eb', weak: '#e9f0ff' }, // Indigo/Blue
                            mint: { DEFAULT: '#10b981', weak: '#e8fff6' }, // Emerald
                            violet: { DEFAULT: '#7c3aed', weak: '#f5edff' }, // Violet
                            info: { DEFAULT: '#06b6d4', weak: '#e6fbff' }, // Cyan
                            danger: { DEFAULT: '#ef4444', weak: '#ffe9e9' },
                            paper: { DEFAULT: '#ffffff', soft: '#f7f8fc', line: '#e6e8ef' },
                        },
                        boxShadow: {
                            soft: '0 10px 28px rgba(20,32,70,.06)',
                            chip: '0 4px 10px rgba(16,185,129,.12)',
                        },
                        borderRadius: {
                            xl2: '16px',
                        },
                        fontFamily: {
                            inter: [
                                'Inter',
                                'system-ui',
                                '-apple-system',
                                'Segoe UI',
                                'Helvetica Neue',
                                'Arial',
                                'Noto Sans JP',
                                'Hiragino Kaku Gothic ProN',
                                'Yu Gothic UI',
                                'Meiryo',
                                'sans-serif',
                            ],
                            mono: [
                                'JetBrains Mono',
                                'ui-monospace',
                                'SFMono-Regular',
                                'Menlo',
                                'Consolas',
                                'Liberation Mono',
                                'monospace',
                            ],
                        },
                    },
                },
            };
        </script>

        <!-- Fonts & Icons -->
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;600&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />

        <!-- Prism.js (CDN) -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/toolbar/prism-toolbar.min.css"
        />

        <!-- Minor CSS tweaks for Prism gutters (to reduce blank space) -->
        <style>
            pre[class*='language-'] {
                margin: 0;
                padding: 10px 12px !important;
                border-radius: 0 !important;
                scrollbar-width: none;
                overflow-x: none;
                position: relative;
                gap: 0.5rem;
            }
            pre.line-numbers {
                padding-left: 4.2em !important;
            }
            .line-numbers .line-numbers-rows {
                width: 2.4em;
            }
            pre[data-line] .line-highlight {
                overflow: hidden;
                padding: 0;
                height: 0 !important;
            }
            .prism-toolbar {
                position: absolute;
                right: 0.5rem;
                top: 0.5rem;
                display: flex;
                gap: 0.5rem;
            }

            /* 既定ボタンの装飾（色・角丸・影・ホバー） */
            div.code-toolbar > .toolbar .toolbar-item > button,
            div.code-toolbar > .toolbar .toolbar-item > a {
                background: #fff;
                border: 1px solid #e6e8ef;
                border-radius: 10px;
                padding: 6px 10px;
                font:
                    600 13px/1.2 Inter,
                    system-ui,
                    -apple-system,
                    'Segoe UI',
                    'Helvetica Neue',
                    Arial,
                    sans-serif;
                color: #334155;
                box-shadow: 0 2px 6px rgba(20, 32, 70, 0.06);
                transition:
                    transform 0.15s ease,
                    box-shadow 0.15s ease,
                    background 0.15s ease;
            }
            div.code-toolbar > .toolbar .toolbar-item > button:hover {
                transform: translateY(-1px);
                box-shadow: 0 10px 28px rgba(20, 32, 70, 0.08);
                background: linear-gradient(180deg, #e8fff6, #c8f1e1);
            }

            /* 押下フィードバック（Copied! に切り替わる瞬間の色） */
            div.code-toolbar > .toolbar .toolbar-item > button:active {
                background: #e8fff6;
                border-color: #c8f1e1;
                color: #0b7f5b;
            }
        </style>
    </head>

    <body class="bg-paper-soft text-slate-800 font-inter antialiased">
        <div class="max-w-[1180px] mx-auto p-5">
            <!-- HERO -->
            <header
                class="relative rounded-xl2 border border-paper-line bg-gradient-to-tr from-white via-white to-brand-weak shadow-soft p-6 mb-6 overflow-hidden"
            >
                <div
                    class="pointer-events-none absolute inset-0"
                    style="
                        background:
                            radial-gradient(
                                1200px 280px at 20% -10%,
                                rgba(37, 99, 235, 0.08),
                                transparent 60%
                            ),
                            radial-gradient(
                                900px 220px at 85% -10%,
                                rgba(16, 185, 129, 0.1),
                                transparent 60%
                            );
                    "
                ></div>
                <h1 class="relative z-10 text-2xl md:text-3xl font-extrabold">
                    Largest Rectangle in Histogram — Python 技術解説
                </h1>
                <p class="relative z-10 text-slate-500 mt-1">
                    対象アルゴリズム：<strong class="text-slate-700"
                        >単調増加スタック法 (Monotonic Increasing Stack)</strong
                    >
                    ／ 言語：Python (CPython 3.11+)
                </p>
                <div class="relative z-10 mt-3 flex flex-wrap gap-2">
                    <span
                        class="inline-flex items-center gap-2 rounded-full border border-paper-line bg-white px-3 py-1 text-sm text-slate-700"
                        ><i class="fa-solid fa-gauge-high text-brand"></i> Time O(n)</span
                    >
                    <span
                        class="inline-flex items-center gap-2 rounded-full border border-paper-line bg-white px-3 py-1 text-sm text-slate-700"
                        ><i class="fa-solid fa-memory text-violet"></i> Space O(n)</span
                    >
                    <span
                        class="inline-flex items-center gap-2 rounded-full border border-paper-line bg-white px-3 py-1 text-sm text-slate-700"
                        ><i class="fa-solid fa-code text-mint"></i> LeetCode Class</span
                    >
                    <span
                        class="inline-flex items-center gap-2 rounded-full border border-paper-line bg-white px-3 py-1 text-sm text-slate-700"
                        ><i class="fa-solid fa-swatchbook text-info"></i> カラーパレット最適化</span
                    >
                    <span
                        class="inline-flex items-center gap-2 rounded-full border border-paper-line bg-white px-3 py-1 text-sm text-slate-700"
                        ><i class="fa-solid fa-mobile-screen text-brand"></i> レスポンシブ</span
                    >
                </div>
            </header>

            <!-- ===== 1 & 2: FULL WIDTH (same width as section 5) ===== -->
            <section
                class="rounded-xl2 border border-paper-line bg-white shadow-soft p-4 mb-5 sec1"
            >
                <div class="flex items-center gap-3 mb-3">
                    <span class="h-6 w-1.5 rounded-full bg-gradient-to-r from-brand to-info"></span>
                    <h2 class="text-xl font-semibold">1. アルゴリズム概要</h2>
                </div>
                <p class="mb-4">
                    配列を一次走査し、<em class="text-slate-700 font-semibold"
                        >高さが単調に増加するインデックス</em
                    >をスタックへ保持します。現在の高さがスタック頂点より低くなった時、頂点を最小高さとする長方形の幅が確定します。末尾では番兵（高さ0）を用い、残りを一括処理することで1本のループで実装できます。
                </p>
                <div class="grid gap-3 md:grid-cols-3">
                    <div
                        class="rounded-xl border border-paper-line bg-gradient-to-b from-white to-brand-weak p-3 shadow-soft"
                    >
                        <div class="text-xs text-slate-500">対象配列（例）</div>
                        <div id="kpiInput" class="text-2xl font-extrabold mt-1">
                            [2, 1, 5, 6, 2, 3]
                        </div>
                    </div>
                    <div
                        class="rounded-xl border border-paper-line bg-gradient-to-b from-white to-mint-weak p-3 shadow-soft"
                    >
                        <div class="text-xs text-slate-500">最大面積（進行中）</div>
                        <div id="kpiArea" class="text-2xl font-extrabold mt-1">0</div>
                    </div>
                    <div
                        class="rounded-xl border border-paper-line bg-gradient-to-b from-white to-violet-weak p-3 shadow-soft"
                    >
                        <div class="text-xs text-slate-500">現在の i / n</div>
                        <div id="kpiIndex" class="text-2xl font-extrabold mt-1">0 / 6</div>
                    </div>
                </div>
            </section>

            <section
                class="rounded-xl2 border border-paper-line bg-white shadow-soft p-4 mb-6 sec2"
            >
                <div class="flex items-center gap-3 mb-3">
                    <span
                        class="h-6 w-1.5 rounded-full bg-gradient-to-r from-violet to-fuchsia-400"
                    ></span>
                    <h2 class="text-xl font-semibold">2. コード例（シンタックスハイライト付き）</h2>
                </div>

                <!-- compact code shell -->
                <div class="rounded-xl border border-paper-line overflow-hidden">
                    <div
                        class="flex items-center justify-between border-b border-paper-line bg-gradient-to-r from-white via-brand-weak/40 to-mint-weak/40 px-3 py-2"
                    >
                        <div class="font-semibold text-sm">
                            <i class="fa-solid fa-python text-amber-500 mr-2"></i>Python / LeetCode
                            Class
                        </div>
                        <div class="text-xs text-slate-500 flex items-center gap-3">
                            <span><i class="fa-regular fa-object-group"></i> 行番号</span>
                            <span><i class="fa-regular fa-clipboard"></i> コピー可</span>
                        </div>
                    </div>
                    <div id="code" class="max-w-full overflow-auto">
                        <pre
                            class="line-numbers"
                            data-line="9-10,12-18,19"
                        ><code class="language-python">from typing import List

class Solution:
    def largestRectangleArea(self, heights: List[int]) -> int:
        n: int = len(heights)
        stack: List[int] = []
        h = heights
        ma = 0
        st = stack

        for i in range(n + 1):
            curr: int = 0 if i == n else h[i]  # sentinel at i==n
            while st and curr &lt; h[st[-1]]:
                top: int = st.pop()
                height: int = h[top]
                left: int = st[-1] if st else -1
                width: int = i - left - 1
                area: int = height * width
                if area &gt; ma:
                    ma = area
            st.append(i)  # push current index (sentinel allowed)
        return ma
</code></pre>
                    </div>
                </div>
                <p class="text-xs text-slate-500 mt-2">
                    ※ 余白を圧縮し、行番号ガターを狭めて空白を最小化しています。
                </p>
            </section>

            <!-- ===== 3 & 4: SIDE BY SIDE ===== -->
            <div class="grid gap-5 md:grid-cols-2">
                <!-- Section 3 -->
                <section class="rounded-xl2 border border-paper-line bg-white shadow-soft p-4 sec3">
                    <div class="flex items-center gap-3 mb-3">
                        <span
                            class="h-6 w-1.5 rounded-full bg-gradient-to-r from-mint to-green-400"
                        ></span>
                        <h2 class="text-xl font-semibold">3. ステップバイステップ解説</h2>
                    </div>
                    <p class="mb-3">
                        例：<code class="font-mono">[2, 1, 5, 6, 2, 3]</code>
                        を順に処理。各ステップでスタックと更新面積を表示します（クリックでジャンプ）。
                    </p>
                    <div id="steps" class="grid gap-2" aria-live="polite"></div>
                </section>

                <!-- Section 4 -->
                <section class="rounded-xl2 border border-paper-line bg-white shadow-soft p-4 sec4">
                    <div class="flex items-center gap-3 mb-3">
                        <span
                            class="h-6 w-1.5 rounded-full bg-gradient-to-r from-brand to-info"
                        ></span>
                        <h2 class="text-xl font-semibold">4. 視覚的図解・フローチャート</h2>
                    </div>

                    <!-- controls -->
                    <div
                        class="flex items-center justify-between gap-2 border border-paper-line rounded-xl bg-white px-3 py-2 mb-3 bg-gradient-to-r from-brand-weak/40 to-mint-weak/40"
                    >
                        <div class="flex items-center gap-2">
                            <button
                                id="btnPrev"
                                class="inline-flex items-center gap-2 rounded-lg border border-paper-line bg-white px-3 py-2 text-sm font-semibold hover:-translate-y-0.5 hover:shadow-soft transition"
                            >
                                <i class="fa-solid fa-circle-chevron-left text-slate-700"></i>
                                Prev
                            </button>
                            <button
                                id="btnPlay"
                                class="inline-flex items-center gap-2 rounded-lg border border-paper-line bg-white px-3 py-2 text-sm font-semibold hover:-translate-y-0.5 hover:shadow-soft transition"
                            >
                                <i class="fa-solid fa-circle-play text-slate-700"></i> Play
                            </button>
                            <button
                                id="btnNext"
                                class="inline-flex items-center gap-2 rounded-lg border border-paper-line bg-white px-3 py-2 text-sm font-semibold hover:-translate-y-0.5 hover:shadow-soft transition"
                            >
                                Next
                                <i class="fa-solid fa-circle-chevron-right text-slate-700"></i>
                            </button>
                        </div>
                        <div id="progress" class="text-xs text-slate-500">Step 1 / 7</div>
                    </div>

                    <!-- bars -->
                    <div
                        id="bars"
                        class="flex items-end gap-2 min-h-[220px] p-3 border border-dashed border-paper-line rounded-xl bg-white overflow-hidden mb-3"
                        style="
                            background:
                                radial-gradient(
                                    500px 140px at 10% -20%,
                                    rgba(37, 99, 235, 0.06),
                                    transparent 60%
                                ),
                                radial-gradient(
                                    500px 140px at 90% -20%,
                                    rgba(16, 185, 129, 0.06),
                                    transparent 60%
                                );
                        "
                    ></div>

                    <!-- stack -->
                    <div
                        id="stack"
                        class="flex flex-wrap gap-2 min-h-[42px] p-2 rounded-lg border border-mint/30 bg-gradient-to-r from-mint-weak to-white mb-2"
                    ></div>

                    <div class="flex flex-wrap gap-4 text-xs text-slate-500 mb-3">
                        <span class="inline-flex items-center gap-2"
                            ><span class="inline-block w-4 h-2 rounded bg-brand"></span>
                            現在バー</span
                        >
                        <span class="inline-flex items-center gap-2"
                            ><span class="inline-block w-4 h-2 rounded bg-mint"></span>
                            スタック中</span
                        >
                        <span class="inline-flex items-center gap-2"
                            ><span class="inline-block w-4 h-2 rounded bg-danger"></span>
                            pop対象</span
                        >
                    </div>

                    <!-- SVG (Mermaid不使用、JPでのエラー回避) -->
                    <div class="border border-paper-line rounded-xl p-2 bg-white">
                        <svg viewBox="0 0 860 240" width="100%" height="200" aria-label="Flowchart">
                            <defs>
                                <linearGradient id="g1" x1="0" x2="1">
                                    <stop offset="0%" stop-color="#e8f0ff" />
                                    <stop offset="100%" stop-color="#ffffff" />
                                </linearGradient>
                                <linearGradient id="g2" x1="0" x2="1">
                                    <stop offset="0%" stop-color="#e8fff6" />
                                    <stop offset="100%" stop-color="#ffffff" />
                                </linearGradient>
                                <style>
                                    .node {
                                        rx: 12;
                                        ry: 12;
                                        fill: url(#g1);
                                        stroke: #cfe0ff;
                                    }
                                    .node2 {
                                        rx: 12;
                                        ry: 12;
                                        fill: url(#g2);
                                        stroke: #c8f0e0;
                                    }
                                    .txt {
                                        font:
                                            600 13px Inter,
                                            Arial;
                                        fill: #1f2937;
                                    }
                                    .edge {
                                        stroke: #9aa7c8;
                                        stroke-width: 2;
                                        marker-end: url(#arrow);
                                    }
                                </style>
                                <marker
                                    id="arrow"
                                    markerWidth="10"
                                    markerHeight="10"
                                    refX="8"
                                    refY="3"
                                    orient="auto"
                                    markerUnits="strokeWidth"
                                >
                                    <path d="M0,0 L0,6 L9,3 z" fill="#9aa7c8" />
                                </marker>
                            </defs>

                            <rect class="node" x="20" y="20" width="170" height="44"></rect>
                            <text class="txt" x="35" y="48">Start &amp; stack=[]</text>

                            <rect class="node" x="230" y="20" width="210" height="44"></rect>
                            <text class="txt" x="245" y="48">for i in [0..n] (sentinel)</text>

                            <rect class="node2" x="480" y="20" width="170" height="44"></rect>
                            <text class="txt" x="495" y="48">curr = 0 if i==n else h[i]</text>

                            <rect class="node" x="690" y="20" width="150" height="44"></rect>
                            <text class="txt" x="705" y="48">push i</text>

                            <rect class="node" x="480" y="90" width="220" height="54"></rect>
                            <text class="txt" x="495" y="120">
                                while stack and curr &lt; h[top]
                            </text>

                            <rect class="node2" x="240" y="160" width="340" height="54"></rect>
                            <text class="txt" x="255" y="189">pop → left = stack[-1] or -1</text>
                            <text class="txt" x="255" y="207">
                                width = i-left-1; area = h[top]*width
                            </text>

                            <line class="edge" x1="190" y1="42" x2="230" y2="42"></line>
                            <line class="edge" x1="440" y1="42" x2="480" y2="42"></line>
                            <line class="edge" x1="650" y1="42" x2="690" y2="42"></line>
                            <line class="edge" x1="565" y1="64" x2="565" y2="90"></line>
                            <line class="edge" x1="480" y1="118" x2="240" y2="187"></line>
                            <line class="edge" x1="580" y1="144" x2="565" y2="64"></line>
                            <line class="edge" x1="765" y1="64" x2="765" y2="220"></line>
                            <line class="edge" x1="765" y1="220" x2="150" y2="220"></line>
                            <line class="edge" x1="150" y1="220" x2="150" y2="64"></line>
                        </svg>
                    </div>
                </section>
            </div>

            <!-- ===== 5: FULL WIDTH ===== -->
            <section
                class="rounded-xl2 border border-paper-line bg-white shadow-soft p-4 mt-6 sec5"
            >
                <div class="flex items-center gap-3 mb-2">
                    <span
                        class="h-6 w-1.5 rounded-full bg-gradient-to-r from-violet to-fuchsia-400"
                    ></span>
                    <h2 class="text-xl font-semibold">5. 時間計算量の説明</h2>
                </div>
                <ul class="list-disc pl-6">
                    <li>
                        <strong>時間計算量：</strong> O(n) — 各インデックスは高々 1 回 push / 1 回
                        pop。
                    </li>
                    <li>
                        <strong>空間計算量：</strong> O(n) — スタックに最大 n
                        個のインデックスを保持。
                    </li>
                </ul>
            </section>

            <footer class="text-center text-slate-500 text-sm py-4">
                © 技術解説 / Tailwind CDN版 —
                フル幅(1・2・5)＋横並び(3・4)・配色最適化・スムーズUI。
            </footer>
        </div>

        <!-- Prism scripts -->
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-highlight/prism-line-highlight.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>

        <!-- Interactions -->
        <script>
            // Data
            const inputHeights = [2, 1, 5, 6, 2, 3];
            const n = inputHeights.length;

            // Elements
            const barsEl = document.getElementById('bars');
            const stackEl = document.getElementById('stack');
            const stepsEl = document.getElementById('steps');
            const kpiArea = document.getElementById('kpiArea');
            const kpiIndex = document.getElementById('kpiIndex');
            const progress = document.getElementById('progress');

            // Steps
            const steps = [
                {
                    title: 'Step 1: i=0 → push 0',
                    desc: 'スタック空。2をpush。',
                    currentIndex: 0,
                    stack: [0],
                    pops: [],
                    maxArea: 0,
                    code: '9-10,19',
                },
                {
                    title: 'Step 2: i=1 → pop 0 → push 1',
                    desc: 'curr=1で2をpop。面積2。',
                    currentIndex: 1,
                    stack: [1],
                    pops: [0],
                    maxArea: 2,
                    code: '12-18',
                },
                {
                    title: 'Step 3: i=2 → push 2',
                    desc: '1 ≤ 5 のため push。',
                    currentIndex: 2,
                    stack: [1, 2],
                    pops: [],
                    maxArea: 2,
                    code: '9-10,19',
                },
                {
                    title: 'Step 4: i=3 → push 3',
                    desc: '5 ≤ 6 のため push。',
                    currentIndex: 3,
                    stack: [1, 2, 3],
                    pops: [],
                    maxArea: 2,
                    code: '9-10,19',
                },
                {
                    title: 'Step 5: i=4 → pop 3, pop 2 → push 4',
                    desc: '6→面積6, 5→面積10 (最大)。',
                    currentIndex: 4,
                    stack: [1, 4],
                    pops: [3, 2],
                    maxArea: 10,
                    code: '12-18',
                },
                {
                    title: 'Step 6: i=5 → push 5',
                    desc: '2 ≤ 3 のため push。',
                    currentIndex: 5,
                    stack: [1, 4, 5],
                    pops: [],
                    maxArea: 10,
                    code: '9-10,19',
                },
                {
                    title: 'Step 7: i=6 (sentinel) → pop 5,4,1',
                    desc: '残りを排出。最大は10。',
                    currentIndex: 6,
                    stack: [6],
                    pops: [5, 4, 1],
                    maxArea: 10,
                    code: '12-18',
                },
            ];

            // Render Steps (sec3)
            function renderStepsList() {
                stepsEl.innerHTML = '';
                steps.forEach((s, idx) => {
                    const item = document.createElement('div');
                    item.className =
                        'rounded-lg border border-paper-line bg-[var(--step-bg,#f4fbff)] px-3 py-2 hover:-translate-y-0.5 transition shadow-[0_4px_14px_rgba(6,182,212,.05)]';
                    item.innerHTML = `<strong class="block">${s.title}</strong><small class="block text-slate-500">${s.desc}</small>`;
                    item.addEventListener('click', () => {
                        pause();
                        applyStep(idx);
                    });
                    stepsEl.appendChild(item);
                });
            }
            function markActiveStep(index) {
                stepsEl.querySelectorAll('div').forEach((el, i) => {
                    el.classList.toggle('outline', i === index);
                    el.classList.toggle('outline-2', i === index);
                    el.classList.toggle('outline-green-500', i === index);
                    if (i === index) {
                        el.classList.add('bg-green-50');
                    } else {
                        el.classList.remove('bg-green-50');
                    }
                });
            }

            // Bars
            function renderBars(state) {
                const maxVal = Math.max(...inputHeights, 1);
                const pxPerUnit = Math.max(6, Math.floor(180 / maxVal));
                barsEl.innerHTML = '';
                inputHeights.forEach((v, idx) => {
                    const div = document.createElement('div');
                    div.className =
                        'relative w-[42px] rounded-t-[10px] rounded-b-[6px] border border-[#c6d7ff] bg-gradient-to-b from-[#dbe8ff] to-[#b7ccff] shadow-[inset_0_-1px_0_rgba(255,255,255,.7),0_8px_18px_rgba(120,153,255,.16)] transition-all';
                    div.style.height = v * pxPerUnit + 'px';
                    if (idx === state.currentIndex)
                        div.classList.add('outline', 'outline-3', 'outline-brand', 'shadow-soft');
                    if (state.stack.includes(idx)) div.classList.add('ring-1', 'ring-mint');
                    if (state.pops.includes(idx))
                        div.classList.add(
                            'bg-gradient-to-b',
                            'from-[#ffdede]',
                            'to-[#ffbaba]',
                            'border-[#ffc6c6]',
                        );
                    const lb = document.createElement('div');
                    lb.className =
                        'absolute -bottom-5 left-1/2 -translate-x-1/2 text-xs text-slate-500';
                    lb.textContent = String(v);
                    div.appendChild(lb);
                    barsEl.appendChild(div);
                });
            }

            // Stack chips
            function renderStack(state) {
                stackEl.innerHTML = '';
                state.stack.forEach((i) => {
                    const span = document.createElement('span');
                    span.className =
                        'px-2 py-1 text-xs rounded-md border border-mint/30 bg-white text-emerald-800 shadow-chip';
                    span.textContent =
                        i >= n ? 'i=sentinel (h=0)' : `i=${i} (h=${inputHeights[i]})`;
                    stackEl.appendChild(span);
                });
            }

            // Prism Line highlight update
            function highlightCode(lines) {
                const pre = document.querySelector('#code pre');
                const code = pre.querySelector('code');
                pre.setAttribute('data-line', lines);
                window.Prism && Prism.highlightElement(code);
            }

            // Controls
            let stepIndex = 0;
            let timer = null;

            function applyStep(i) {
                stepIndex = Math.max(0, Math.min(steps.length - 1, i));
                const s = steps[stepIndex];
                renderBars({
                    currentIndex: s.currentIndex,
                    stack: s.stack,
                    pops: s.pops,
                });
                renderStack({ stack: s.stack });
                kpiArea.textContent = String(s.maxArea);
                kpiIndex.textContent = `${Math.min(s.currentIndex, n)} / ${n}`;
                progress.textContent = `Step ${stepIndex + 1} / ${steps.length}`;
                markActiveStep(stepIndex);
                highlightCode(s.code);
                const active = stepsEl.children[stepIndex];
                if (active) {
                    active.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            }

            function play() {
                if (timer) {
                    pause();
                    return;
                }
                document.getElementById('btnPlay').innerHTML =
                    '<i class="fa-solid fa-circle-pause text-slate-700"></i> Pause';
                timer = setInterval(() => {
                    if (stepIndex >= steps.length - 1) {
                        pause();
                        return;
                    }
                    applyStep(stepIndex + 1);
                }, 1500);
            }
            function pause() {
                if (timer) {
                    clearInterval(timer);
                    timer = null;
                }
                document.getElementById('btnPlay').innerHTML =
                    '<i class="fa-solid fa-circle-play text-slate-700"></i> Play';
            }
            document.getElementById('btnPrev').addEventListener('click', () => {
                pause();
                applyStep(stepIndex - 1);
            });
            document.getElementById('btnNext').addEventListener('click', () => {
                pause();
                applyStep(stepIndex + 1);
            });
            document.getElementById('btnPlay').addEventListener('click', play);

            // Init
            renderStepsList();
            applyStep(0);
            addEventListener('resize', () => applyStep(stepIndex), { passive: true });
        </script>
    </body>
</html>
