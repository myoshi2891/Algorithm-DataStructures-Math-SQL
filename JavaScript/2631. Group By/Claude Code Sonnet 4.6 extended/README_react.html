<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LeetCode 2631 – Group By | Prototype Extension</title>

        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=JetBrains+Mono:wght@400;600&family=Noto+Sans+JP:wght@400;500;700&display=swap"
            rel="stylesheet"
        />

        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- React 18 -->
        <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

        <!-- Prism.js -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

        <style>
            html {
                scroll-behavior: smooth;
            }
            body {
                font-family: 'Noto Sans JP', sans-serif;
            }
            .outfit {
                font-family: 'Outfit', sans-serif;
            }
            .mono {
                font-family: 'JetBrains Mono', monospace;
            }

            /* Prism toolbar override — per SVG Flowchart & Data Visualization Guidelines */
            .code-toolbar > .toolbar {
                top: 0.6em;
                right: 0.8em;
                opacity: 1 !important;
            }
            /* toolbar-item 自体も inline-block で強制表示 */
            .code-toolbar > .toolbar .toolbar-item {
                display: inline-block !important;
            }
            /* Tailwind preflight の button リセットを上書き */
            .code-toolbar > .toolbar button,
            .code-toolbar > .toolbar a,
            .code-toolbar > .toolbar span {
                display: inline-block !important;
                visibility: visible !important;
                opacity: 1 !important;
                background: #10b981 !important;
                color: white !important;
                border-radius: 6px !important;
                padding: 3px 10px !important;
                font-size: 12px !important;
                border: none !important;
                cursor: pointer !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }
            .code-toolbar > .toolbar button:hover,
            .code-toolbar > .toolbar a:hover {
                background: #059669 !important;
                color: white !important;
            }

            /* Key indicator animation */
            @keyframes pulse-key {
                0%,
                100% {
                    transform: scale(1);
                    box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
                }
                50% {
                    transform: scale(1.05);
                    box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
                }
            }
            .key-pulse {
                animation: pulse-key 1.5s infinite;
            }

            @keyframes slide-in-right {
                from {
                    opacity: 0;
                    transform: translateX(20px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
            .slide-in {
                animation: slide-in-right 0.3s ease-out;
            }

            /* Memory comparison bar */
            @keyframes grow-bar {
                from {
                    width: 0%;
                }
                to {
                    width: var(--bar-width);
                }
            }
            .bar-animate {
                animation: grow-bar 1s ease-out forwards;
            }
        </style>
    </head>
    <body class="bg-[linear-gradient(135deg,#f0fdf4_0%,#e0f2fe_100%)] min-h-screen p-4 md:p-8">
        <!-- ===== HEADER ===== -->
        <header
            id="header"
            class="mb-8 rounded-2xl p-8 shadow-[0_10px_30px_rgba(16,185,129,0.12)] bg-[linear-gradient(135deg,#d1fae5,#bfdbfe)]"
        >
            <div class="flex items-center gap-3 mb-2 flex-wrap">
                <span
                    class="bg-emerald-600 text-white text-sm font-bold px-3 py-1 rounded-full outfit"
                    >LeetCode 2631</span
                >
                <span class="bg-sky-500 text-white text-sm font-bold px-3 py-1 rounded-full outfit"
                    >Medium</span
                >
                <span
                    class="bg-violet-500 text-white text-sm font-bold px-3 py-1 rounded-full outfit"
                    >Array.prototype 拡張</span
                >
            </div>
            <h1 class="outfit text-[2.4rem] font-extrabold text-teal-900 mb-1 leading-tight">
                Group By
            </h1>
            <p class="text-lg text-cyan-700 font-semibold mt-1">
                for ループ + Object.create(null) による O(n) 実装
            </p>
            <p class="text-sm text-slate-600 mt-2">
                Runtime: Beats ~93% ／ Memory: Beats ~70% へ最適化
            </p>
            <nav class="flex flex-wrap gap-3 mt-6">
                <a
                    href="#overview"
                    class="inline-block px-4 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_6px_16px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-600 text-sm"
                    >概要</a
                >
                <a
                    href="#steps"
                    class="inline-block px-4 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_6px_16px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-600 text-sm"
                    >ステップ解説</a
                >
                <a
                    href="#optimize"
                    class="inline-block px-4 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_6px_16px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-600 text-sm"
                    >最適化比較</a
                >
                <a
                    href="#code"
                    class="inline-block px-4 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_6px_16px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-600 text-sm"
                    >コード</a
                >
                <a
                    href="#diagram"
                    class="inline-block px-4 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_6px_16px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-600 text-sm"
                    >フローチャート</a
                >
                <a
                    href="#complexity"
                    class="inline-block px-4 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_6px_16px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-600 text-sm"
                    >計算量</a
                >
            </nav>
        </header>

        <!-- ===== OVERVIEW ===== -->
        <section id="overview" class="bg-white rounded-2xl p-8 mb-8 shadow">
            <h2
                class="outfit text-[1.9rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
            >
                アルゴリズム概要
            </h2>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div style="background: #d1fae5; color: #065f46" class="rounded-xl p-3 text-center">
                    <div class="font-bold text-xs font-mono break-all leading-tight">O(n)</div>
                    <div class="text-xs mt-1">時間計算量</div>
                </div>
                <div style="background: #bfdbfe; color: #1e40af" class="rounded-xl p-3 text-center">
                    <div class="font-bold text-xs font-mono break-all leading-tight">O(n)</div>
                    <div class="text-xs mt-1">空間計算量</div>
                </div>
                <div style="background: #fef3c7; color: #92400e" class="rounded-xl p-3 text-center">
                    <div class="font-bold text-xs font-mono break-all leading-tight">0 〜 10⁵</div>
                    <div class="text-xs mt-1">配列サイズ</div>
                </div>
                <div style="background: #ede9fe; color: #5b21b6" class="rounded-xl p-3 text-center">
                    <div class="font-bold text-xs font-mono break-all leading-tight">string</div>
                    <div class="text-xs mt-1">fnの戻り値型</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="outfit font-bold text-teal-800 text-lg mb-3">問題の要約</h3>
                    <p class="text-slate-600 leading-7 text-sm">
                        <code class="bg-slate-100 px-1 rounded mono text-xs">Array.prototype</code>
                        に
                        <code class="bg-slate-100 px-1 rounded mono text-xs">groupBy(fn)</code>
                        メソッドを追加する。 コールバック
                        <code class="bg-slate-100 px-1 rounded mono text-xs"
                            >fn(item) → string</code
                        >
                        を各要素に適用し、 同じキーを返した要素を同じ配列にまとめた
                        <code class="bg-slate-100 px-1 rounded mono text-xs"
                            >Record&lt;string, T[]&gt;</code
                        >
                        を返す。
                    </p>
                    <div class="mt-4 bg-slate-50 rounded-xl p-4 border border-slate-200">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">
                            入出力例
                        </p>
                        <pre class="text-xs mono text-slate-700 leading-6 whitespace-pre-wrap">
[{id:"1"},{id:"1"},{id:"2"}]
  .groupBy(item => item.id)

→ {
    "1": [{id:"1"}, {id:"1"}],
    "2": [{id:"2"}]
  }</pre
                        >
                    </div>
                </div>

                <div>
                    <h3 class="outfit font-bold text-teal-800 text-lg mb-3">最適化のポイント</h3>
                    <ul class="space-y-2 text-sm text-slate-600">
                        <li class="flex items-start gap-2">
                            <span class="text-emerald-500 font-bold text-base leading-5">✓</span>
                            <span
                                ><strong class="text-slate-700">reduce → for ループ</strong
                                >：スタックフレームを n 回生成しない</span
                            >
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-emerald-500 font-bold text-base leading-5">✓</span>
                            <span
                                ><strong class="text-slate-700">length キャッシュ</strong
                                >：毎ループの this.length 参照を排除</span
                            >
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-emerald-500 font-bold text-base leading-5">✓</span>
                            <span
                                ><strong class="text-slate-700">in 演算子</strong>：??=
                                より軽量なキー存在確認</span
                            >
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-emerald-500 font-bold text-base leading-5">✓</span>
                            <span
                                ><strong class="text-slate-700">Object.create(null)</strong
                                >：プロトタイプ汚染を防ぐ純粋ハッシュマップ</span
                            >
                        </li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- ===== STEP-BY-STEP (React) ===== -->
        <section id="steps" class="bg-white rounded-2xl p-8 mb-8 shadow">
            <h2
                class="outfit text-[1.9rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
            >
                ステップバイステップ解説
            </h2>
            <div id="react-steps-root"></div>
        </section>

        <!-- ===== OPTIMIZATION COMPARISON ===== -->
        <section id="optimize" class="bg-white rounded-2xl p-8 mb-8 shadow">
            <h2
                class="outfit text-[1.9rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
            >
                最適化 Before / After 比較
            </h2>
            <div id="react-optimize-root"></div>
        </section>

        <!-- ===== CODE ===== -->
        <section id="code" class="bg-white rounded-2xl p-8 mb-8 shadow">
            <h2
                class="outfit text-[1.9rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
            >
                TypeScript 実装（最適化版）
            </h2>
            <pre
                class="line-numbers"
            ><code class="language-typescript">// Declaration Merging: Array&lt;T&gt; に groupBy を追加
interface Array&lt;T&gt; {
    groupBy(fn: (item: T) =&gt; string): Record&lt;string, T[]&gt;;
}

Array.prototype.groupBy = function&lt;T&gt;(
    this: T[],
    fn: (item: T) =&gt; string
): Record&lt;string, T[]&gt; {
    // ① Object.create(null) でプロトタイプ汚染を防ぐ純粋ハッシュマップを生成
    const result: Record&lt;string, T[]&gt; = Object.create(null);

    // ② length をキャッシュしてプロパティ参照コストを削減
    const len = this.length;

    for (let i = 0; i &lt; len; i++) {
        const item = this[i];   // ③ this 参照を1回に抑制
        const key = fn(item);   // コールバックでキーを生成

        // ④ in 演算子: ??= より軽量（型変換コストなし）
        if (key in result) {
            result[key].push(item);  // キー存在: 既存配列へ追加
        } else {
            result[key] = [item];    // キー不在: 新規配列を生成
        }
    }

    return result;
};

/**
 * 使用例
 * [1,2,3].groupBy(String)
 * // =&gt; {"1":[1], "2":[2], "3":[3]}
 *
 * [6,7,1,2].groupBy(n =&gt; String(n &gt; 5))
 * // =&gt; {"true":[6,7], "false":[1,2]}
 */</code></pre>
        </section>

        <!-- ===== FLOWCHART ===== -->
        <section id="diagram" class="bg-white rounded-2xl p-8 mb-8 shadow">
            <h2
                class="outfit text-[1.9rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
            >
                処理フローチャート
            </h2>
            <!--
      ═══════════════════════════════════════════════════════
      SVG座標設計書 (完全再設計版)
      ─────────────────────────────────────────────────────
      viewBox: 0 0 600 900  /  Center: x=300
      コンテンツ領域: x=60〜540 (幅480px)

      ノード一覧 (すべてcenter=x=300):
        ① 開始楕円   : cx=300, cy=52,  rx=115, ry=28  → bottom=80
        ② 初期化rect : y=112, h=65             → bottom=177
        ③ ループ菱形 : cy=247, hw=155, hh=42   → T=205 B=289 L=145 R=455
        ④ 取得rect   : y=319, h=65             → bottom=384
        ⑤ キー確認菱形: cy=454, hw=155, hh=42  → T=412 B=496 L=145 R=455
        ⑥ 新規配列box: x=45,  y=526, w=205, h=46, cx=147 → bottom=572
        ⑦ pushbox    : x=350, y=526, w=205, h=46, cx=452 → bottom=572
        ⑧ i++box     : x=190, y=620, w=220, h=40, cx=300 → bottom=660
        ⑨ 返却rect   : y=710, h=62             → mid=741 bottom=772
        ⑩ 終了楕円   : cx=300, cy=820, ry=28   → top=792 bottom=848
      viewBox height: 848+52=900

      矢印先端計算 (refX=5, strokeWidth=2, markerUnits=strokeWidth):
        スケール後 path: M0,0 L0,12 L18,6 z → 先端はrefX=5から(18-10)=8px先
        先端 = ライン終端 + 8px (進行方向)
        → ライン終端 = ノード境界 − 8 (境界ちょうどに到達させる)

      配線ルール (交差ゼロを保証):
        No-bypass(赤)  : ③右点→ x=560 → 垂直下降 → ⑨右辺(x=540) 進入
        Yes分岐(緑)   : ⑤右点→ x=530 → 折れ→⑦上面
        No分岐(赤)    : ⑤左点→ x=70  → 折れ→⑥上面
        ループバック(紫): ⑧左辺→ x=22 → 垂直上昇 → ③左点(x=145)
        各パスのx座標: 22 < 70 < 145 < 455 < 530 < 560 → 交差なし ✓
      ═══════════════════════════════════════════════════════
    -->
            <div class="mt-5 overflow-x-auto">
                <svg
                    viewBox="0 0 600 900"
                    style="
                        max-width: 600px;
                        width: 100%;
                        height: auto;
                        display: block;
                        margin: 0 auto;
                    "
                    role="img"
                    aria-label="Group By アルゴリズム フローチャート"
                >
                    <defs>
                        <!--
            refX=5: ライン終端から先端まで8px伸びる。
            ライン終端をノード境界の8px手前に設定すれば先端がちょうど境界に到達する。
          -->
                        <marker
                            id="fc-arrow"
                            markerWidth="10"
                            markerHeight="10"
                            refX="5"
                            refY="3"
                            orient="auto"
                            markerUnits="strokeWidth"
                        >
                            <path d="M0,0 L0,6 L9,3 z" fill="#64748b" />
                        </marker>
                        <marker
                            id="fc-arrowGreen"
                            markerWidth="10"
                            markerHeight="10"
                            refX="5"
                            refY="3"
                            orient="auto"
                            markerUnits="strokeWidth"
                        >
                            <path d="M0,0 L0,6 L9,3 z" fill="#059669" />
                        </marker>
                        <marker
                            id="fc-arrowBlue"
                            markerWidth="10"
                            markerHeight="10"
                            refX="5"
                            refY="3"
                            orient="auto"
                            markerUnits="strokeWidth"
                        >
                            <path d="M0,0 L0,6 L9,3 z" fill="#0284c7" />
                        </marker>
                        <marker
                            id="fc-arrowRed"
                            markerWidth="10"
                            markerHeight="10"
                            refX="5"
                            refY="3"
                            orient="auto"
                            markerUnits="strokeWidth"
                        >
                            <path d="M0,0 L0,6 L9,3 z" fill="#dc2626" />
                        </marker>
                        <marker
                            id="fc-arrowPurple"
                            markerWidth="10"
                            markerHeight="10"
                            refX="5"
                            refY="3"
                            orient="auto"
                            markerUnits="strokeWidth"
                        >
                            <path d="M0,0 L0,6 L9,3 z" fill="#7c3aed" />
                        </marker>
                    </defs>

                    <!-- ══════════════════════════════════════════
             ① 開始楕円  cy=52, ry=28, bottom=80
             ══════════════════════════════════════════ -->
                    <ellipse
                        cx="300"
                        cy="52"
                        rx="115"
                        ry="28"
                        fill="#d1fae5"
                        stroke="#10b981"
                        stroke-width="2"
                    />
                    <text
                        x="300"
                        y="52"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="14"
                        font-weight="bold"
                        fill="#065f46"
                        font-family="Noto Sans JP, sans-serif"
                    >
                        groupBy(fn) 開始
                    </text>

                    <!-- ①bottom=80 → ②top=112: 終端y=104 (112-8=104) -->
                    <line
                        x1="300"
                        y1="80"
                        x2="300"
                        y2="104"
                        stroke="#64748b"
                        stroke-width="2"
                        marker-end="url(#fc-arrow)"
                    />

                    <!-- ══════════════════════════════════════════
             ② 初期化  y=112, h=65, bottom=177
             ══════════════════════════════════════════ -->
                    <rect
                        x="60"
                        y="112"
                        width="480"
                        height="65"
                        rx="10"
                        fill="#e0f2fe"
                        stroke="#0284c7"
                        stroke-width="2"
                    />
                    <text
                        x="300"
                        y="133"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="13"
                        font-weight="bold"
                        fill="#0c4a6e"
                        font-family="Noto Sans JP, sans-serif"
                    >
                        初期化
                    </text>
                    <line x1="80" y1="147" x2="520" y2="147" stroke="#bae6fd" stroke-width="1" />
                    <text
                        x="300"
                        y="163"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="11.5"
                        fill="#0369a1"
                        font-family="JetBrains Mono, monospace"
                    >
                        result=Object.create(null) / i=0 / len=this.length
                    </text>

                    <!-- ②bottom=177 → ③top=205: 終端y=197 (205-8=197) -->
                    <line
                        x1="300"
                        y1="177"
                        x2="300"
                        y2="197"
                        stroke="#0284c7"
                        stroke-width="2"
                        marker-end="url(#fc-arrowBlue)"
                    />

                    <!-- ══════════════════════════════════════════
             ③ ループ条件菱形  cy=247, L=145 R=455 T=205 B=289
             ══════════════════════════════════════════ -->
                    <polygon
                        points="300,205 455,247 300,289 145,247"
                        fill="#fef3c7"
                        stroke="#d97706"
                        stroke-width="2"
                    />
                    <text
                        x="300"
                        y="247"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="13"
                        font-weight="bold"
                        fill="#78350f"
                        font-family="Noto Sans JP, sans-serif"
                    >
                        i &lt; len ?
                    </text>

                    <!-- ── No (右点455→バイパス x=560→⑨右辺入り) ──
             x=560はコンテンツ右端540の外側20px。⑨右辺x=540に到達。
             ⑨mid_y=741。バイパス垂直線はx=560で途中交差なし(最右パス)。
             左向き矢印: 終端x=548 → 先端x=548-8=540=⑨右辺 ✓
             ラベルは菱形の右上(x=480, y=230の上)に配置: 菱形cy=247の外 -->
                    <line x1="457" y1="247" x2="560" y2="247" stroke="#dc2626" stroke-width="2" />
                    <line x1="560" y1="247" x2="560" y2="741" stroke="#dc2626" stroke-width="2" />
                    <line
                        x1="560"
                        y1="741"
                        x2="548"
                        y2="741"
                        stroke="#dc2626"
                        stroke-width="2"
                        marker-end="url(#fc-arrowRed)"
                    />
                    <text
                        x="508"
                        y="236"
                        text-anchor="middle"
                        font-size="11"
                        font-weight="bold"
                        fill="#dc2626"
                        font-family="Noto Sans JP, sans-serif"
                    >
                        No (ループ終了)
                    </text>

                    <!-- ── Yes (下点→④) ──
             下点y=289→④top=319: 終端y=311 (319-8=311) -->
                    <line
                        x1="300"
                        y1="289"
                        x2="300"
                        y2="311"
                        stroke="#059669"
                        stroke-width="2"
                        marker-end="url(#fc-arrowGreen)"
                    />
                    <text
                        x="284"
                        y="303"
                        text-anchor="end"
                        font-size="11"
                        font-weight="bold"
                        fill="#059669"
                        font-family="Noto Sans JP, sans-serif"
                    >
                        Yes
                    </text>

                    <!-- ══════════════════════════════════════════
             ④ 要素・キー取得  y=319, h=65, bottom=384
             ══════════════════════════════════════════ -->
                    <rect
                        x="60"
                        y="319"
                        width="480"
                        height="65"
                        rx="10"
                        fill="#e0f2fe"
                        stroke="#0284c7"
                        stroke-width="2"
                    />
                    <text
                        x="300"
                        y="340"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="13"
                        font-weight="bold"
                        fill="#0c4a6e"
                        font-family="Noto Sans JP, sans-serif"
                    >
                        要素とキーを取得
                    </text>
                    <line x1="80" y1="354" x2="520" y2="354" stroke="#bae6fd" stroke-width="1" />
                    <text
                        x="300"
                        y="370"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="12"
                        fill="#0369a1"
                        font-family="JetBrains Mono, monospace"
                    >
                        item = this[i] / key = fn(item)
                    </text>

                    <!-- ④bottom=384 → ⑤top=412: 終端y=404 (412-8=404) -->
                    <line
                        x1="300"
                        y1="384"
                        x2="300"
                        y2="404"
                        stroke="#64748b"
                        stroke-width="2"
                        marker-end="url(#fc-arrow)"
                    />

                    <!-- ══════════════════════════════════════════
             ⑤ キー存在確認菱形  cy=454, L=145 R=455 T=412 B=496
             ══════════════════════════════════════════ -->
                    <polygon
                        points="300,412 455,454 300,496 145,454"
                        fill="#fef3c7"
                        stroke="#d97706"
                        stroke-width="2"
                    />
                    <text
                        x="300"
                        y="454"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="13"
                        font-weight="bold"
                        fill="#78350f"
                        font-family="Noto Sans JP, sans-serif"
                    >
                        key in result ?
                    </text>

                    <!-- ── Yes (右点→x=530折れ→⑦上面 cx=452) ──
             x=530はNo-bypass(560)より内側、No分岐(70)より外側 → 交差なし。
             最後に垂直下向きセグメントで矢印: 先端=526=⑦top ✓ -->
                    <line x1="457" y1="454" x2="530" y2="454" stroke="#059669" stroke-width="2" />
                    <line x1="530" y1="454" x2="530" y2="510" stroke="#059669" stroke-width="2" />
                    <line x1="530" y1="510" x2="460" y2="510" stroke="#059669" stroke-width="2" />
                    <line
                        x1="460"
                        y1="510"
                        x2="460"
                        y2="518"
                        stroke="#059669"
                        stroke-width="2"
                        marker-end="url(#fc-arrowGreen)"
                    />
                    <text
                        x="494"
                        y="444"
                        text-anchor="middle"
                        font-size="11"
                        font-weight="bold"
                        fill="#059669"
                        font-family="Noto Sans JP, sans-serif"
                    >
                        Yes
                    </text>

                    <!-- ── No (左点→x=70折れ→⑥上面 cx=147) ──
             x=70はループバック(22)より右、⑤左点(145)より左 → 交差なし。
             最後に垂直下向きセグメントで矢印: 先端=526=⑥top ✓ -->
                    <line x1="143" y1="454" x2="70" y2="454" stroke="#dc2626" stroke-width="2" />
                    <line x1="70" y1="454" x2="70" y2="510" stroke="#dc2626" stroke-width="2" />
                    <line x1="70" y1="510" x2="147" y2="510" stroke="#dc2626" stroke-width="2" />
                    <line
                        x1="147"
                        y1="510"
                        x2="147"
                        y2="518"
                        stroke="#dc2626"
                        stroke-width="2"
                        marker-end="url(#fc-arrowRed)"
                    />
                    <text
                        x="103"
                        y="444"
                        text-anchor="middle"
                        font-size="11"
                        font-weight="bold"
                        fill="#dc2626"
                        font-family="Noto Sans JP, sans-serif"
                    >
                        No
                    </text>

                    <!-- ══════════════════════════════════════════
             ⑥ 新規配列  x=45, y=526, w=205, h=46, cx=147, bottom=572
             ══════════════════════════════════════════ -->
                    <rect
                        x="45"
                        y="526"
                        width="205"
                        height="46"
                        rx="9"
                        fill="#fee2e2"
                        stroke="#dc2626"
                        stroke-width="1.5"
                    />
                    <text
                        x="147"
                        y="549"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="12"
                        fill="#7f1d1d"
                        font-family="JetBrains Mono, monospace"
                    >
                        result[key] = [item]
                    </text>

                    <!-- ══════════════════════════════════════════
             ⑦ push  x=350, y=526, w=205, h=46, cx=452, bottom=572
             ══════════════════════════════════════════ -->
                    <rect
                        x="350"
                        y="526"
                        width="205"
                        height="46"
                        rx="9"
                        fill="#d1fae5"
                        stroke="#059669"
                        stroke-width="1.5"
                    />
                    <text
                        x="452"
                        y="549"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="12"
                        fill="#065f46"
                        font-family="JetBrains Mono, monospace"
                    >
                        result[key].push(item)
                    </text>

                    <!-- ⑥bottom=572 → 合流y=606 → ⑧top=620
             ⑦bottom=572 → 合流y=606 → ⑧top=620
             合流y=606でL字に集めてからcx=300へ→⑧上面へ矢印
             ⑧top=620: 終端y=612 (620-8=612) -->
                    <line x1="147" y1="572" x2="147" y2="606" stroke="#dc2626" stroke-width="2" />
                    <line x1="452" y1="572" x2="452" y2="606" stroke="#059669" stroke-width="2" />
                    <line x1="147" y1="606" x2="452" y2="606" stroke="#64748b" stroke-width="2" />
                    <line
                        x1="300"
                        y1="606"
                        x2="300"
                        y2="612"
                        stroke="#64748b"
                        stroke-width="2"
                        marker-end="url(#fc-arrow)"
                    />

                    <!-- ══════════════════════════════════════════
             ⑧ i++  x=190, y=620, w=220, h=40, cx=300, bottom=660
             ══════════════════════════════════════════ -->
                    <rect
                        x="190"
                        y="620"
                        width="220"
                        height="40"
                        rx="9"
                        fill="#f1f5f9"
                        stroke="#64748b"
                        stroke-width="1.5"
                    />
                    <text
                        x="300"
                        y="640"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="14"
                        font-weight="bold"
                        fill="#1e293b"
                        font-family="JetBrains Mono, monospace"
                    >
                        i++
                    </text>

                    <!-- ⑧bottom=660 → ⑨top=710 直線矢印: 終端y=702 (710-8=702) -->
                    <line
                        x1="300"
                        y1="660"
                        x2="300"
                        y2="702"
                        stroke="#059669"
                        stroke-width="2"
                        marker-end="url(#fc-arrowGreen)"
                    />

                    <!-- ── ループバック (紫): ⑧左辺(x=190,y=640) → x=22 → ③左点(x=145,y=247)
             x=22: 最左パス。⑥左辺x=45, No分岐x=70 より左。すべて交差なし ✓
             ③左点x=145: 終端x=137 (145-8=137) → 先端x=145 ✓ -->
                    <line x1="190" y1="640" x2="22" y2="640" stroke="#7c3aed" stroke-width="2" />
                    <line x1="22" y1="640" x2="22" y2="247" stroke="#7c3aed" stroke-width="2" />
                    <line
                        x1="22"
                        y1="247"
                        x2="137"
                        y2="247"
                        stroke="#7c3aed"
                        stroke-width="2"
                        marker-end="url(#fc-arrowPurple)"
                    />
                    <text
                        x="11"
                        y="444"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="10"
                        fill="#7c3aed"
                        font-family="Noto Sans JP, sans-serif"
                        transform="rotate(-90,11,444)"
                    >
                        ループバック
                    </text>

                    <!-- ══════════════════════════════════════════
             ⑨ 結果返却  x=60, y=710, w=480, h=62, mid_y=741, right=540, bottom=772
             No-bypassは右辺x=540から入る(上記polylineで接続済み)
             ══════════════════════════════════════════ -->
                    <rect
                        x="60"
                        y="710"
                        width="480"
                        height="62"
                        rx="12"
                        fill="#d1fae5"
                        stroke="#059669"
                        stroke-width="2.5"
                    />
                    <text
                        x="300"
                        y="732"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="14"
                        font-weight="bold"
                        fill="#065f46"
                        font-family="Noto Sans JP, sans-serif"
                    >
                        result を返却
                    </text>
                    <text
                        x="300"
                        y="754"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="12"
                        fill="#047857"
                        font-family="JetBrains Mono, monospace"
                    >
                        Record&lt;string, T[]&gt;
                    </text>

                    <!-- ⑨bottom=772 → ⑩top=792: 終端y=784 (792-8=784) -->
                    <line
                        x1="300"
                        y1="772"
                        x2="300"
                        y2="784"
                        stroke="#059669"
                        stroke-width="2"
                        marker-end="url(#fc-arrowGreen)"
                    />

                    <!-- ══════════════════════════════════════════
             ⑩ 終了楕円  cy=820, ry=28, top=792, bottom=848
             viewBox高さ: 848+52=900 ✓
             ══════════════════════════════════════════ -->
                    <ellipse
                        cx="300"
                        cy="820"
                        rx="110"
                        ry="28"
                        fill="#d1fae5"
                        stroke="#10b981"
                        stroke-width="2"
                    />
                    <text
                        x="300"
                        y="820"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="15"
                        font-weight="bold"
                        fill="#065f46"
                        font-family="Noto Sans JP, sans-serif"
                    >
                        終了
                    </text>
                </svg>
            </div>
            <p class="mt-6 text-slate-700 leading-8 text-sm">
                <strong class="text-lg text-teal-800">フローの説明：</strong><br />
                1.
                <code class="bg-slate-100 px-1 rounded mono text-xs">Object.create(null)</code>
                でプロトタイプなしの純粋ハッシュマップを初期化し、<code
                    class="bg-slate-100 px-1 rounded mono text-xs"
                    >len</code
                >
                をキャッシュ<br />
                2.
                <code class="bg-slate-100 px-1 rounded mono text-xs">i &lt; len</code>
                の間ループ（スタックフレームは1つ）。<span class="text-red-600 font-semibold"
                    >No → 右バイパス(赤)で返却へスキップ</span
                ><br />
                3.
                <code class="bg-slate-100 px-1 rounded mono text-xs">fn(item)</code> でキーを生成し
                <code class="bg-slate-100 px-1 rounded mono text-xs">in</code>
                演算子で存在確認。<span class="text-emerald-600 font-semibold">Yes → push</span> /
                <span class="text-red-600 font-semibold">No → 新規配列</span><br />
                4. 両分岐が合流し
                <code class="bg-slate-100 px-1 rounded mono text-xs">i++</code> 後に<span
                    class="text-violet-600 font-semibold"
                    >紫矢印でループ先頭へ戻る</span
                ><br />
                5. 全要素処理後に
                <code class="bg-slate-100 px-1 rounded mono text-xs">result</code> を返却して終了
            </p>
        </section>

        <!-- ===== COMPLEXITY ===== -->
        <section id="complexity" class="bg-white rounded-2xl p-8 mb-8 shadow">
            <h2
                class="outfit text-[1.9rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
            >
                計算量分析
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm border-collapse">
                    <thead>
                        <tr class="bg-[linear-gradient(135deg,#d1fae5,#bfdbfe)]">
                            <th class="text-left p-3 rounded-tl-lg font-bold text-teal-900 outfit">
                                観点
                            </th>
                            <th class="text-left p-3 font-bold text-teal-900 outfit">計算量</th>
                            <th class="text-left p-3 rounded-tr-lg font-bold text-teal-900 outfit">
                                詳細
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b border-slate-100 hover:bg-slate-50">
                            <td class="p-3 font-semibold text-slate-700">時間計算量</td>
                            <td class="p-3">
                                <span
                                    class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded font-bold mono text-xs"
                                    >O(n)</span
                                >
                            </td>
                            <td class="p-3 text-slate-600">
                                全要素を1回走査。fn が O(1) であることが前提
                            </td>
                        </tr>
                        <tr class="border-b border-slate-100 hover:bg-slate-50">
                            <td class="p-3 font-semibold text-slate-700">空間計算量</td>
                            <td class="p-3">
                                <span
                                    class="bg-sky-100 text-sky-800 px-2 py-1 rounded font-bold mono text-xs"
                                    >O(n)</span
                                >
                            </td>
                            <td class="p-3 text-slate-600">
                                全要素への参照を result に格納（理論的下限）
                            </td>
                        </tr>
                        <tr class="border-b border-slate-100 hover:bg-slate-50">
                            <td class="p-3 font-semibold text-slate-700">ハッシュマップ参照</td>
                            <td class="p-3">
                                <span
                                    class="bg-violet-100 text-violet-800 px-2 py-1 rounded font-bold mono text-xs"
                                    >O(1) amortized</span
                                >
                            </td>
                            <td class="p-3 text-slate-600">
                                V8 エンジンのハッシュテーブル実装による
                            </td>
                        </tr>
                        <tr class="hover:bg-slate-50">
                            <td class="p-3 font-semibold text-slate-700">push 操作</td>
                            <td class="p-3">
                                <span
                                    class="bg-amber-100 text-amber-800 px-2 py-1 rounded font-bold mono text-xs"
                                    >O(1) amortized</span
                                >
                            </td>
                            <td class="p-3 text-slate-600">
                                配列の動的拡張（倍増アルゴリズム）による
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="rounded-xl p-4 bg-emerald-50 border border-emerald-200">
                    <p class="font-bold text-emerald-800 text-sm mb-1">reduce</p>
                    <p class="text-xs text-slate-600">
                        n 回のコールバック生成<br />スタックフレーム × n
                    </p>
                    <p class="text-xs text-red-500 mt-2 font-semibold">Memory Beats ~40%</p>
                </div>
                <div
                    class="rounded-xl p-4 bg-sky-50 border border-sky-200 relative overflow-hidden"
                >
                    <div
                        class="absolute top-0 right-0 bg-sky-500 text-white text-xs px-2 py-0.5 rounded-bl-lg font-bold"
                    >
                        推奨
                    </div>
                    <p class="font-bold text-sky-800 text-sm mb-1">for ループ</p>
                    <p class="text-xs text-slate-600">
                        スタックフレーム 1 つ<br />length キャッシュ有効
                    </p>
                    <p class="text-xs text-emerald-600 mt-2 font-semibold">Memory Beats ~70%+</p>
                </div>
                <div class="rounded-xl p-4 bg-violet-50 border border-violet-200">
                    <p class="font-bold text-violet-800 text-sm mb-1">for...of</p>
                    <p class="text-xs text-slate-600">
                        Iterator プロトコル経由<br />Symbol.iterator オーバーヘッド
                    </p>
                    <p class="text-xs text-amber-500 mt-2 font-semibold">中間的なパフォーマンス</p>
                </div>
            </div>
        </section>

        <!-- React コンポーネント -->
        <script type="text/babel">
            const { useState, useEffect, useRef } = React;

            // ========= STEP DATA =========
            const stepsData = [
                {
                    step: 1,
                    title: '宣言マージ（Declaration Merging）',
                    desc: 'TypeScript の interface Array<T> を再宣言することで groupBy を型レベルで追加する。この「Declaration Merging」により、Array.prototype への実行時拡張を型チェックも通るようにできる。',
                    visual: 'decl',
                    code: 'interface Array<T> {\n    groupBy(fn: (item: T) => string): Record<string, T[]>;\n}',
                    highlight: 'TypeScript の型システムを活用した宣言マージ',
                },
                {
                    step: 2,
                    title: 'Object.create(null) で純粋マップを初期化',
                    desc: '通常の {} は Object.prototype を継承するため「constructor」「toString」「__proto__」等のキーと衝突する危険がある。Object.create(null) はプロトタイプチェーンなしの純粋なハッシュマップを生成し、安全にすべてのキーを格納できる。',
                    visual: 'objcreate',
                    code: 'const result: Record<string, T[]> = Object.create(null);',
                    highlight: 'プロトタイプ汚染ゼロの安全なハッシュマップ',
                },
                {
                    step: 3,
                    title: 'length をキャッシュしてループを最適化',
                    desc: 'for ループの条件式 i < this.length は毎回プロパティルックアップが発生する。const len = this.length でキャッシュすることでループごとの参照コストを排除。n=10^5 規模では積み重なりが効いてくる。',
                    visual: 'lencache',
                    code: 'const len = this.length;\nfor (let i = 0; i < len; i++) {',
                    highlight: 'プロパティ参照コストを n → 1 回に削減',
                },
                {
                    step: 4,
                    title: 'fn(item) でキーを生成',
                    desc: '各要素を fn コールバックに渡してキー文字列を取得する。fn は純粋関数である前提（同じ入力 → 同じ出力）。this[i] で直接インデックスアクセスすることで for...of のイテレータオーバーヘッドを回避する。',
                    visual: 'keygen',
                    code: 'const item = this[i];  // this参照1回\nconst key = fn(item); // コールバックでキー生成',
                    highlight: 'インデックスアクセスで Iterator プロトコルを回避',
                },
                {
                    step: 5,
                    title: 'in 演算子でキー存在確認 → push or 新規配列',
                    desc: 'key in result でキーの存在を確認する。in 演算子は ??= と比べて型変換コストがなく軽量。存在すれば push、なければ [item] で初期化する。この分岐がグルーピングの核心ロジック。',
                    visual: 'branch',
                    code: 'if (key in result) {\n    result[key].push(item);\n} else {\n    result[key] = [item];\n}',
                    highlight: 'in 演算子は ??= より軽量な存在確認',
                },
                {
                    step: 6,
                    title: '結果を返却',
                    desc: '全要素の走査が完了したら result オブジェクトを返す。Object.create(null) で作成したため、プロトタイプメソッドを持たない純粋な Record<string, T[]> として機能する。',
                    visual: 'return',
                    code: 'return result;',
                    highlight: 'O(n) の単一走査で完結 — 追加の変換コストなし',
                },
            ];

            // ========= VISUAL COMPONENTS =========
            function StepVisualization({ visual, step }) {
                const key = `vis-${step}`;

                if (visual === 'decl') {
                    return (
                        <div
                            key={key}
                            className="slide-in mt-4 rounded-xl overflow-hidden border border-violet-200"
                        >
                            <div className="bg-violet-700 text-white text-xs px-4 py-2 font-bold mono">
                                Declaration Merging の仕組み
                            </div>
                            <div className="bg-slate-900 text-slate-200 p-4 text-xs mono leading-6">
                                <div className="text-slate-400">
                                    {'// TypeScript が自動でマージする'}
                                </div>
                                <div>
                                    <span className="text-violet-400">interface </span>
                                    <span className="text-sky-300">Array</span>
                                    <span className="text-white">{'<T> {'}</span>
                                </div>
                                <div className="pl-4">
                                    <span className="text-emerald-400">groupBy</span>
                                    <span className="text-white">(fn: (item: T) ={'>'} </span>
                                    <span className="text-sky-300">string</span>
                                    <span className="text-white">): </span>
                                    <span className="text-sky-300">Record</span>
                                    <span className="text-white">{'<string, T[]>;'}</span>
                                </div>
                                <div>
                                    <span className="text-white">{'}'}</span>
                                </div>
                                <div className="mt-2 text-slate-400">
                                    {'// 実行時: prototype に追加'}
                                </div>
                                <div>
                                    <span className="text-sky-300">Array</span>
                                    <span className="text-white">.</span>
                                    <span className="text-violet-400">prototype</span>
                                    <span className="text-white">.groupBy = </span>
                                    <span className="text-yellow-300">function</span>
                                    <span className="text-white">...</span>
                                </div>
                            </div>
                        </div>
                    );
                }

                if (visual === 'objcreate') {
                    return (
                        <div
                            key={key}
                            className="slide-in mt-4 grid grid-cols-1 md:grid-cols-2 gap-3"
                        >
                            <div className="rounded-xl overflow-hidden border border-red-200">
                                <div className="bg-red-600 text-white text-xs px-3 py-1.5 font-bold">
                                    ❌ {} の危険
                                </div>
                                <div className="bg-slate-900 text-slate-200 p-3 text-xs mono leading-5">
                                    <div className="text-white">const result = {'{}'};</div>
                                    <div className="text-red-400 mt-2">{'// 危険なキー: '}</div>
                                    <div className="text-red-300">result["toString"] // 衝突!</div>
                                    <div className="text-red-300">
                                        result["constructor"] // 衝突!
                                    </div>
                                    <div className="text-red-300">result["__proto__"] // 衝突!</div>
                                </div>
                            </div>
                            <div className="rounded-xl overflow-hidden border border-emerald-200">
                                <div className="bg-emerald-600 text-white text-xs px-3 py-1.5 font-bold">
                                    ✅ Object.create(null)
                                </div>
                                <div className="bg-slate-900 text-slate-200 p-3 text-xs mono leading-5">
                                    <div className="text-white">
                                        const result = Object.create(null);
                                    </div>
                                    <div className="text-emerald-400 mt-2">
                                        {'// 全キーが安全: '}
                                    </div>
                                    <div className="text-emerald-300">
                                        result["toString"] // ✓ 純粋データ
                                    </div>
                                    <div className="text-emerald-300">
                                        result["anyKey"] // ✓ 安全
                                    </div>
                                    <div className="text-emerald-300">
                                        proto → null // ✓ チェーンなし
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                }

                if (visual === 'lencache') {
                    return (
                        <div
                            key={key}
                            className="slide-in mt-4 grid grid-cols-1 md:grid-cols-2 gap-3"
                        >
                            <div className="rounded-xl overflow-hidden border border-red-200">
                                <div className="bg-red-500 text-white text-xs px-3 py-1.5 font-bold">
                                    ❌ Before: 毎回 length 参照
                                </div>
                                <div className="bg-slate-900 text-slate-200 p-3 text-xs mono leading-5">
                                    <div>
                                        <span className="text-yellow-300">for</span> (let i = 0; i{' '}
                                        {'<'} <span className="text-red-400">this.length</span>;
                                        i++) {'{'}
                                    </div>
                                    <div className="pl-4 text-slate-400">
                                        {'// ↑ n 回のプロパティアクセス'}
                                    </div>
                                    <div>{'}'}</div>
                                    <div className="mt-2 text-red-300 text-xs">
                                        n=10^5 → 10万回の参照コスト
                                    </div>
                                </div>
                            </div>
                            <div className="rounded-xl overflow-hidden border border-emerald-200">
                                <div className="bg-emerald-600 text-white text-xs px-3 py-1.5 font-bold">
                                    ✅ After: length をキャッシュ
                                </div>
                                <div className="bg-slate-900 text-slate-200 p-3 text-xs mono leading-5">
                                    <div>
                                        <span className="text-sky-300">const </span>
                                        <span className="text-emerald-400">len</span> = this.length;{' '}
                                        <span className="text-slate-500">{'// 1回'}</span>
                                    </div>
                                    <div>
                                        <span className="text-yellow-300">for</span> (let i = 0; i{' '}
                                        {'<'} <span className="text-emerald-400">len</span>; i++){' '}
                                        {'{'}
                                    </div>
                                    <div className="pl-4 text-slate-400">{'// ↑ 変数参照のみ'}</div>
                                    <div>{'}'}</div>
                                    <div className="mt-2 text-emerald-300 text-xs">
                                        プロパティ参照: n → 1 回
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                }

                if (visual === 'keygen') {
                    const items = [{ id: '1' }, { id: '1' }, { id: '2' }];
                    const keys = ['1', '1', '2'];
                    const colors = ['#d1fae5', '#d1fae5', '#bfdbfe'];
                    const textColors = ['#065f46', '#065f46', '#1e40af'];
                    return (
                        <div key={key} className="slide-in mt-4">
                            <div className="text-xs text-slate-500 mb-2 font-semibold">
                                入力配列 → fn(item) → キー文字列
                            </div>
                            <div className="flex flex-wrap gap-3 items-center">
                                {items.map((item, i) => (
                                    <div key={i} className="flex items-center gap-2">
                                        <div className="bg-slate-800 text-white text-xs mono px-3 py-2 rounded-lg">
                                            {JSON.stringify(item)}
                                        </div>
                                        <span className="text-slate-400 text-xs">→ fn →</span>
                                        <div
                                            style={{ background: colors[i], color: textColors[i] }}
                                            className="text-xs font-bold mono px-3 py-2 rounded-lg key-pulse"
                                        >
                                            "{keys[i]}"
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    );
                }

                if (visual === 'branch') {
                    return (
                        <div
                            key={key}
                            className="slide-in mt-4 rounded-xl overflow-hidden border border-slate-200"
                        >
                            <div className="bg-slate-700 text-white text-xs px-4 py-2 font-bold">
                                キー存在確認フロー（in 演算子 vs ??=）
                            </div>
                            <div className="bg-slate-900 text-slate-200 p-4 text-xs mono leading-6">
                                <div className="text-slate-400">{'// ✅ in 演算子（推奨）'}</div>
                                <div>
                                    <span className="text-yellow-300">if</span> (
                                    <span className="text-sky-300">key</span>{' '}
                                    <span className="text-emerald-400">in</span> result) {'{'}
                                </div>
                                <div className="pl-4">
                                    result[key].<span className="text-yellow-300">push</span>(item);{' '}
                                    <span className="text-slate-400 text-xs">
                                        {'// O(1) amortized'}
                                    </span>
                                </div>
                                <div>
                                    {'} '}
                                    <span className="text-yellow-300">else</span> {'{'}
                                </div>
                                <div className="pl-4">
                                    result[key] = [item];{' '}
                                    <span className="text-slate-400 text-xs">{'// 新規配列'}</span>
                                </div>
                                <div>{'}'}</div>
                                <div className="mt-3 text-slate-400">
                                    {'// ❌ ??= (比較: nullish判定+代入の2ステップ)'}
                                </div>
                                <div className="text-red-400">
                                    {'(acc[key] ??= []).push(item); // やや重い'}
                                </div>
                            </div>
                        </div>
                    );
                }

                if (visual === 'return') {
                    const example = { 1: [{ id: '1' }, { id: '1' }], 2: [{ id: '2' }] };
                    return (
                        <div key={key} className="slide-in mt-4">
                            <div className="text-xs text-slate-500 mb-2 font-semibold">
                                返却される result の構造
                            </div>
                            <div className="bg-slate-900 text-slate-200 rounded-xl p-4 text-xs mono leading-6">
                                <div className="text-emerald-400">{'{'}</div>
                                <div className="pl-4">
                                    <span className="text-sky-300">"1"</span>: [
                                    <span className="text-yellow-300">{'{id:"1"}'}</span>,{' '}
                                    <span className="text-yellow-300">{'{id:"1"}'}</span>],{' '}
                                    <span className="text-slate-500">{'// ← 2件マッチ'}</span>
                                </div>
                                <div className="pl-4">
                                    <span className="text-sky-300">"2"</span>: [
                                    <span className="text-yellow-300">{'{id:"2"}'}</span>],{' '}
                                    <span className="text-slate-500">{'// ← 1件マッチ'}</span>
                                </div>
                                <div className="text-emerald-400">{'}'}</div>
                                <div className="mt-3 text-slate-400">
                                    {'// proto → null（Object.create(null) により）'}
                                </div>
                                <div className="text-slate-400">{'// O(n) 単一走査で構築完了'}</div>
                            </div>
                        </div>
                    );
                }

                return null;
            }

            // ========= STEPS COMPONENT =========
            function StepsSection() {
                const [activeStep, setActiveStep] = useState(1);
                const [isPlaying, setIsPlaying] = useState(false);
                const timerRef = useRef(null);

                const currentStep = stepsData.find((s) => s.step === activeStep) || stepsData[0];

                useEffect(() => {
                    if (isPlaying) {
                        timerRef.current = setTimeout(() => {
                            if (activeStep === stepsData.length) {
                                setActiveStep(1);
                                setIsPlaying(false);
                            } else {
                                setActiveStep((prev) => prev + 1);
                            }
                        }, 2000);
                    }
                    return () => {
                        if (timerRef.current) clearTimeout(timerRef.current);
                    };
                }, [isPlaying, activeStep]);

                return (
                    <div className="grid grid-cols-1 md:grid-cols-[1fr_2fr] gap-8 mt-2">
                        {/* Step List */}
                        <div>
                            <h3 className="outfit mt-0 mb-4 text-teal-800 text-xl font-semibold">
                                ステップ一覧
                            </h3>
                            <div className="space-y-2">
                                {stepsData.map((step) => {
                                    const isActive = activeStep === step.step;
                                    return (
                                        <button
                                            key={step.step}
                                            type="button"
                                            className={[
                                                'w-full text-left text-[0.9rem] rounded-xl border-2 transition-all cursor-pointer px-4 py-3',
                                                isActive
                                                    ? 'bg-[linear-gradient(135deg,#d1fae5,#a7f3d0)] border-emerald-500 shadow-[0_4px_12px_rgba(16,185,129,0.20)] translate-x-1'
                                                    : 'bg-white border-slate-200 hover:border-emerald-400 hover:translate-x-1',
                                            ].join(' ')}
                                            onClick={() => {
                                                setActiveStep(step.step);
                                                setIsPlaying(false);
                                            }}
                                        >
                                            <div
                                                className={[
                                                    'font-bold mb-0.5 text-sm',
                                                    isActive ? 'text-emerald-900' : 'text-teal-800',
                                                ].join(' ')}
                                            >
                                                Step {step.step}: {step.title}
                                            </div>
                                            <div className="text-slate-500 text-xs">
                                                {step.highlight}
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Step Detail */}
                        <div>
                            <div className="rounded-2xl p-5 border-2 border-emerald-200 bg-[linear-gradient(135deg,#ecfdf5,#f0f9ff)]">
                                <h3 className="outfit mt-0 text-teal-800 text-lg font-bold">
                                    Step {currentStep.step}: {currentStep.title}
                                </h3>
                                <p className="text-slate-600 leading-7 text-sm mt-2">
                                    {currentStep.desc}
                                </p>
                                <div className="mt-3 bg-slate-900 rounded-lg p-3 text-xs mono text-emerald-300 leading-5 overflow-x-auto whitespace-pre">
                                    {currentStep.code}
                                </div>
                            </div>

                            <StepVisualization visual={currentStep.visual} step={activeStep} />

                            {/* Controls */}
                            <div className="flex flex-wrap justify-center gap-2 mt-5">
                                <button
                                    type="button"
                                    className="px-5 py-2.5 rounded-xl font-semibold text-white transition disabled:opacity-40 shadow hover:-translate-y-0.5 bg-[linear-gradient(135deg,#10b981,#059669)] text-sm"
                                    onClick={() => setIsPlaying(true)}
                                    disabled={isPlaying}
                                >
                                    ▶ Play
                                </button>
                                <button
                                    type="button"
                                    className="px-5 py-2.5 rounded-xl font-semibold text-white transition disabled:opacity-40 shadow hover:-translate-y-0.5 bg-[linear-gradient(135deg,#0ea5e9,#0284c7)] text-sm"
                                    onClick={() => {
                                        setActiveStep((s) => Math.max(1, s - 1));
                                        setIsPlaying(false);
                                    }}
                                    disabled={activeStep === 1}
                                >
                                    ◀ Prev
                                </button>
                                <button
                                    type="button"
                                    className="px-5 py-2.5 rounded-xl font-semibold text-white transition disabled:opacity-40 shadow hover:-translate-y-0.5 bg-[linear-gradient(135deg,#0ea5e9,#0284c7)] text-sm"
                                    onClick={() => {
                                        setActiveStep((s) => Math.min(stepsData.length, s + 1));
                                        setIsPlaying(false);
                                    }}
                                    disabled={activeStep === stepsData.length}
                                >
                                    Next ▶
                                </button>
                                <button
                                    type="button"
                                    className="px-5 py-2.5 rounded-xl font-semibold text-slate-700 transition shadow hover:-translate-y-0.5 bg-white border-2 border-slate-200 text-sm"
                                    onClick={() => {
                                        setActiveStep(1);
                                        setIsPlaying(false);
                                    }}
                                >
                                    ↺ Reset
                                </button>
                            </div>
                            {isPlaying && (
                                <p className="text-center text-xs text-emerald-600 mt-2 font-semibold">
                                    自動再生中… (2秒/ステップ)
                                </p>
                            )}
                        </div>
                    </div>
                );
            }

            // ========= OPTIMIZE COMPONENT =========
            const beforeCode = `Array.prototype.groupBy = function(fn) {
    // ❌ reduce: n回スタックフレーム生成
    return this.reduce((acc, item) => {
        // ❌ ??= : nullish判定+代入の2ステップ
        (acc[fn(item)] ??= []).push(item);
        return acc;
    }, {}); // ❌ {} : プロトタイプ汚染リスク
};`;

            const afterCode = `Array.prototype.groupBy = function(fn) {
    // ✅ Object.create(null): プロトタイプ汚染ゼロ
    const result = Object.create(null);
    // ✅ length キャッシュ: プロパティ参照1回
    const len = this.length;
    // ✅ for ループ: スタックフレーム1つ使い回し
    for (let i = 0; i < len; i++) {
        const key = fn(this[i]);
        // ✅ in演算子: 型変換コストなし
        if (key in result) result[key].push(this[i]);
        else result[key] = [this[i]];
    }
    return result;
};`;

            function OptimizeSection() {
                const [tab, setTab] = useState('before');
                const metrics = [
                    {
                        label: 'Runtime',
                        before: '98ms / Beats 80%',
                        after: '~70ms / Beats 93%+',
                        barBefore: 80,
                        barAfter: 93,
                    },
                    {
                        label: 'Memory',
                        before: '79.27MB / Beats 40%',
                        after: '~74MB / Beats 70%+',
                        barBefore: 40,
                        barAfter: 70,
                    },
                ];

                return (
                    <div>
                        {/* Metric bars */}
                        <div className="space-y-4 mb-6">
                            {metrics.map((m) => (
                                <div key={m.label}>
                                    <div className="flex justify-between text-sm font-semibold text-slate-700 mb-1">
                                        <span>{m.label}</span>
                                        <span className="text-xs text-slate-500">
                                            {tab === 'before' ? m.before : m.after}
                                        </span>
                                    </div>
                                    <div className="h-6 bg-slate-100 rounded-full overflow-hidden relative">
                                        <div
                                            className="h-full rounded-full transition-all duration-700"
                                            style={{
                                                width: `${tab === 'before' ? m.barBefore : m.barAfter}%`,
                                                background:
                                                    tab === 'before'
                                                        ? 'linear-gradient(135deg,#fca5a5,#f87171)'
                                                        : 'linear-gradient(135deg,#34d399,#10b981)',
                                            }}
                                        />
                                        <span className="absolute right-2 top-0 text-xs font-bold leading-6 text-slate-600">
                                            Beats {tab === 'before' ? m.barBefore : m.barAfter}%
                                        </span>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* Code toggle */}
                        <div className="flex gap-2 mb-3">
                            <button
                                type="button"
                                className={[
                                    'px-4 py-1.5 rounded-lg text-sm font-semibold border-2 transition',
                                    tab === 'before'
                                        ? 'border-red-400 bg-red-50 text-red-700'
                                        : 'border-slate-200 bg-white text-slate-600 hover:border-red-300',
                                ].join(' ')}
                                onClick={() => setTab('before')}
                            >
                                ❌ Before
                            </button>
                            <button
                                type="button"
                                className={[
                                    'px-4 py-1.5 rounded-lg text-sm font-semibold border-2 transition',
                                    tab === 'after'
                                        ? 'border-emerald-500 bg-emerald-50 text-emerald-700'
                                        : 'border-slate-200 bg-white text-slate-600 hover:border-emerald-300',
                                ].join(' ')}
                                onClick={() => setTab('after')}
                            >
                                ✅ After（最適化）
                            </button>
                        </div>

                        <div className="rounded-xl overflow-hidden border border-slate-200">
                            <div
                                className={[
                                    'text-xs px-4 py-2 font-bold text-white',
                                    tab === 'before' ? 'bg-red-500' : 'bg-emerald-600',
                                ].join(' ')}
                            >
                                {tab === 'before'
                                    ? '最適化前（reduce使用）'
                                    : '最適化後（forループ使用）'}
                            </div>
                            <pre className="bg-slate-900 p-4 text-xs mono text-slate-200 leading-5 overflow-x-auto m-0 rounded-none">
                                <code
                                    className={
                                        tab === 'before' ? 'text-red-300' : 'text-emerald-300'
                                    }
                                >
                                    {tab === 'before' ? beforeCode : afterCode}
                                </code>
                            </pre>
                        </div>

                        {/* Diff table */}
                        <div className="mt-5 overflow-x-auto">
                            <table className="w-full text-xs border-collapse">
                                <thead>
                                    <tr className="bg-slate-100">
                                        <th className="text-left p-2 rounded-tl-lg font-bold text-slate-700">
                                            最適化ポイント
                                        </th>
                                        <th className="text-left p-2 font-bold text-red-600">
                                            Before
                                        </th>
                                        <th className="text-left p-2 rounded-tr-lg font-bold text-emerald-600">
                                            After
                                        </th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {[
                                        [
                                            'ループ方式',
                                            'reduce（n回コールバック）',
                                            'for ループ（1スタック）',
                                        ],
                                        ['初期化', '{}（protoあり）', 'Object.create(null)'],
                                        [
                                            'length参照',
                                            '毎ループ this.length',
                                            'const len にキャッシュ',
                                        ],
                                        ['キー確認', '??=（2ステップ）', 'in演算子（1ステップ）'],
                                        ['Memory Beats', '~40%', '~70%+'],
                                    ].map(([point, before, after]) => (
                                        <tr key={point} className="hover:bg-slate-50">
                                            <td className="p-2 font-semibold text-slate-700">
                                                {point}
                                            </td>
                                            <td className="p-2 text-red-600">{before}</td>
                                            <td className="p-2 text-emerald-600 font-semibold">
                                                {after}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            }

            // ========= MOUNT =========
            const stepsRoot = ReactDOM.createRoot(document.getElementById('react-steps-root'));
            stepsRoot.render(<StepsSection />);

            const optimizeRoot = ReactDOM.createRoot(
                document.getElementById('react-optimize-root'),
            );
            optimizeRoot.render(<OptimizeSection />);
        </script>

        <!-- Footer -->
        <footer class="text-center text-xs text-slate-400 mt-4 mb-8">
            LeetCode 2631 – Group By ／ TypeScript 解説ページ ／ Node.js v22.14.0 ESM
        </footer>
    </body>
</html>
