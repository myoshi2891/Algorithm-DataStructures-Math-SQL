# è§£æ³• Aï¼ˆæŽ¨å¥¨ï¼‰ï¼šROW_NUMBER ã®â€œå·®â€ã§é€£ç¶šåŒºé–“ã‚’æ¤œå‡ºï¼ˆGaps & Islandsï¼‰

```sql
-- 3å›žä»¥ä¸Šé€£ç¶šã—ãŸæ•°å€¤ã‚’1å›žãšã¤è¿”ã™
SELECT DISTINCT num AS "ConsecutiveNums"
FROM (
  SELECT
    num,
    ROW_NUMBER() OVER (ORDER BY id)
      - ROW_NUMBER() OVER (PARTITION BY num ORDER BY id) AS grp
  FROM Logs
) s
GROUP BY num, grp
HAVING COUNT(*) >= 3;
```

## ãƒã‚¤ãƒ³ãƒˆ 1

- `r_all = ROW_NUMBER() OVER (ORDER BY id)` ã¨
  `r_num = ROW_NUMBER() OVER (PARTITION BY num ORDER BY id)` ã®**å·®**ãŒåŒã˜è¡Œã¯ã€ŒåŒä¸€ã®é€£ç¶šãƒ©ãƒ³ã€ã«ãªã‚Šã¾ã™ã€‚
- ãã® `grp` å˜ä½ã§ `COUNT(*)` ãŒ **3 ä»¥ä¸Š**ã®ã‚‚ã®ã‚’æŽ¡ç”¨ã€‚
- é•·ã„é€£ç¶šï¼ˆä¾‹: åŒã˜ `num` ãŒ 100 é€£ç¶šï¼‰ã§ã‚‚**1 ã‚°ãƒ«ãƒ¼ãƒ—ã«ç•³ã‚ã‚‹**ãŸã‚å®‰å®šã€‚

---

## è§£æ³• Bï¼šLAG ã§ 3 é€£ç¶šã‚’ç›´æŽ¥åˆ¤å®šï¼ˆå®Ÿè£…ãŒç›´æ„Ÿçš„ï¼‰

```sql
SELECT DISTINCT num AS "ConsecutiveNums"
FROM (
  SELECT
    id,
    num,
    LAG(num, 1) OVER (ORDER BY id) AS n1,
    LAG(num, 2) OVER (ORDER BY id) AS n2
  FROM Logs
) t
WHERE num = n1 AND num = n2;
```

## ãƒã‚¤ãƒ³ãƒˆ 2

- ç¾åœ¨è¡Œã¨ 1 ã¤å‰ãƒ»2 ã¤å‰ãŒåŒã˜ `num` ãªã‚‰ 3 é€£ç¶šã€‚
- ç›´æ„Ÿçš„ã§çŸ­ã„ãŒã€é•·ã„é€£ç¶šãŒå¤šæ•°ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã§ã¯ãƒ’ãƒƒãƒˆè¡ŒãŒå¢—ãˆã‚„ã™ã„ï¼ˆ`DISTINCT` ã‚³ã‚¹ãƒˆãŒç›¸å¯¾çš„ã«å¢—ãˆã‚‹ã“ã¨ãŒã‚ã‚‹ï¼‰ã€‚

---

## å›³è§£ 1ï¼šè§£æ³• A ã®æµã‚Œï¼ˆROW_NUMBER ã®å·®ï¼‰

```mermaid
flowchart LR
  A["Order by id"] --> B["r_all = row_number() over order by id"]
  A --> C["r_num = row_number() over partition by num order by id"]
  B --> D["grp = r_all - r_num"]
  C --> D
  D --> E["group by num, grp"]
  E --> F{"count >= 3 ?"}
  F -- "Yes" --> G["collect num"]
  F -- "No" --> H["discard"]
  G --> I["distinct num as ConsecutiveNums"]
```

## å›³è§£ 2ï¼šè§£æ³• B ã®æµã‚Œï¼ˆLAG ã§ 3 é€£ç¶šï¼‰

```mermaid
flowchart LR
  A["Order by id"] --> B["compute lag1 and lag2 of num"]
  B --> C{"num = lag1 and num = lag2 ?"}
  C -- "Yes" --> D["record num"]
  C -- "No" --> E["skip"]
  D --> F["distinct num as ConsecutiveNums"]
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã®å®Ÿå‹™ Tipsï¼ˆPostgreSQLï¼‰

- ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é †åºã®ãŸã‚ã« **`id` ã® PK**ã¯å¿…é ˆï¼ˆæ—¢ã«ã‚ã‚‹æƒ³å®šï¼‰ã€‚
- ãƒ‡ãƒ¼ã‚¿é‡ãŒå¤§ãã `num` ã®ç¨®é¡žãŒå¤šã„å ´åˆã€**è§£æ³• A**ãŒå®‰å®šã—ã‚„ã™ã„ã§ã™ï¼ˆé•·ã„é€£ç¶šã‚’ 1 ã‚°ãƒ«ãƒ¼ãƒ—ã«ç•³ã‚ã‚‹ï¼‰ã€‚
- å®Ÿç’°å¢ƒã§ã¯ `EXPLAIN (ANALYZE, BUFFERS)` ã§**ã‚½ãƒ¼ãƒˆ/ãƒãƒƒãƒ•ã‚¡ I/O**ã‚’ç¢ºèªã—ã€ã‚ˆã‚Šé€Ÿã„æ–¹ã‚’æŽ¡ç”¨ã—ã¦ãã ã•ã„ã€‚
- æ–‡å­—åˆ—ã®ä¸æ•´åˆãŒå¿ƒé…ãªã‚‰ `num` ã‚’ `TRIM(num)` ã«ç½®ãæ›ãˆã‚‹ã®ã‚‚æ‰‹ã§ã™ï¼ˆèª²é¡Œã‚µã‚¤ãƒˆã§ã¯ä¸è¦ãªã“ã¨ãŒå¤šã„ï¼‰ã€‚

ã¨ã¦ã‚‚è‰¯ã„è³ªå•ã§ã™ï¼
SQL ã«ãŠã‘ã‚‹ `FROM Logs s` ã‚„ `FROM Logs t` ã®ã‚ˆã†ãª **ã€Œãƒ†ãƒ¼ãƒ–ãƒ«åˆ¥åï¼ˆã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼‰ã€** ã®æ„å‘³ã¨ä½¿ã„æ–¹ã‚’ã€PostgreSQL/MySQL ä¸¡æ–¹ã«å…±é€šã™ã‚‹è¦³ç‚¹ã§è©³ã—ãèª¬æ˜Žã—ã¾ã™ã€‚

---

## ðŸ”¹1. åŸºæœ¬æ§‹æ–‡ï¼šã€Œã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆaliasï¼‰ã€ã¨ã¯

`FROM Logs s` ã®ã‚ˆã†ã«æ›¸ãã¨ã€
**ãƒ†ãƒ¼ãƒ–ãƒ«å `Logs` ã«çŸ­ã„åˆ¥å `s` ã‚’ã¤ã‘ã¦ã„ã‚‹**ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

```sql
FROM Logs AS s
```

ä¸Šã®ã‚ˆã†ã« `AS` ã‚’æ˜Žç¤ºã—ã¦ã‚‚ãƒ»çœç•¥ã—ã¦ã‚‚åŒã˜æ„å‘³ã§ã™ï¼ˆã©ã¡ã‚‰ã‚‚ OKï¼‰ã€‚

---

### âœ… ç›®çš„

SQL ã®æ–‡ä¸­ã§ãã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çŸ­ãå‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã§ã™ã€‚

```sql
-- åˆ¥åãªã—ï¼ˆã‚„ã‚„å†—é•·ï¼‰
SELECT Logs.num, Logs.id
FROM Logs
WHERE Logs.id > 10;

-- åˆ¥åã‚ã‚Šï¼ˆçŸ­ãã¦èª­ã¿ã‚„ã™ã„ï¼‰
SELECT s.num, s.id
FROM Logs AS s
WHERE s.id > 10;
```

åˆ¥åã‚’ä½¿ã†ã¨ã€**åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½•åº¦ã‚‚å‚ç…§ã™ã‚‹å ´åˆï¼ˆè‡ªå·±çµåˆãªã©ï¼‰**ã«éžå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚

---

## ðŸ”¹2. ä»Šå›žã®ã‚±ãƒ¼ã‚¹ã§ã® `s` ã‚„ `t` ã®å½¹å‰²

### ä¾‹ Aï¼ˆROW_NUMBER ã®å·®ã‚’ä½¿ã†è§£æ³•ï¼‰

```sql
SELECT DISTINCT num AS "ConsecutiveNums"
FROM (
  SELECT
    num,
    ROW_NUMBER() OVER (ORDER BY id)
      - ROW_NUMBER() OVER (PARTITION BY num ORDER BY id) AS grp
  FROM Logs
) s
GROUP BY num, grp
HAVING COUNT(*) >= 3;
```

ã“ã“ã§ã® `s` ã¯â€•â€•
ðŸ”¸ **ã‚µãƒ–ã‚¯ã‚¨ãƒªï¼ˆå†…å´ã® SELECT ...ï¼‰å…¨ä½“ã«ä»˜ã‘ãŸåˆ¥å**ã§ã™ã€‚

### ã‚¤ãƒ¡ãƒ¼ã‚¸

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ (subquery result)          â”‚ â† ã“ã‚Œã«åå‰ s ã‚’ã¤ã‘ã¦å¤–å´ãŒå‚ç…§
â”‚ id | num | grp             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- `FROM Logs` â€¦ å…ƒã®ãƒ†ãƒ¼ãƒ–ãƒ«
- `) s` â€¦ ãã®çµæžœã‚»ãƒƒãƒˆã‚’ **ä»®æƒ³ãƒ†ãƒ¼ãƒ–ãƒ« s ã¨ã—ã¦æ‰±ã†**

ã“ã‚Œã«ã‚ˆã‚Šã€å¤–å´ã®ã‚¯ã‚¨ãƒªã§ `FROM s` ã®ã‚ˆã†ã«æ‰±ãˆã¾ã™ã€‚

---

### ä¾‹ Bï¼ˆLAG ã‚’ä½¿ã†è§£æ³•ï¼‰

```sql
SELECT DISTINCT num AS "ConsecutiveNums"
FROM (
  SELECT
    id,
    num,
    LAG(num, 1) OVER (ORDER BY id) AS n1,
    LAG(num, 2) OVER (ORDER BY id) AS n2
  FROM Logs
) t
WHERE num = n1 AND num = n2;
```

ã“ã“ã§ã¯ **åˆ¥å `t`** ãŒã‚µãƒ–ã‚¯ã‚¨ãƒªã®åˆ¥åã§ã™ã€‚
å½¹å‰²ã¯ `s` ã¨å…¨ãåŒã˜ã§ã€å˜ã« â€œtemporary table nameâ€ ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚

---

## ðŸ”¹3. åˆ¥åã‚’ä»˜ã‘ã‚‹ç†ç”±ã¾ã¨ã‚

| ç†ç”±               | å†…å®¹                                           | ä¾‹                     |
| ------------------ | ---------------------------------------------- | ---------------------- |
| â‘  å¯èª­æ€§å‘ä¸Š       | é•·ã„ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’çŸ­ãã§ãã‚‹                     | `Logs` â†’ `l`           |
| â‘¡ è‡ªå·±çµåˆã«å¿…é ˆ   | åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¤‡æ•°å›ž JOIN ã™ã‚‹å ´åˆã€åŒºåˆ¥ãŒå¿…è¦ | `Logs l1 JOIN Logs l2` |
| â‘¢ ã‚µãƒ–ã‚¯ã‚¨ãƒªã«å¿…é ˆ | ã‚µãƒ–ã‚¯ã‚¨ãƒªï¼ˆæ‹¬å¼§å†… SELECTï¼‰ã«ã¯å¿…ãšåˆ¥åãŒå¿…è¦  | `FROM (SELECT ...) s`  |

> **PostgreSQLãƒ»MySQL ã¨ã‚‚ã«** > `FROM (SELECT ...) [alias]` ã® `[alias]` ã¯ **å¿…é ˆ** ã§ã™ã€‚
> ã“ã‚ŒãŒãªã„ã¨ã€Œsyntax error near ')'ã€ã®ã‚ˆã†ãªæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

---

## ðŸ”¹4. å®Ÿè¡Œã‚¤ãƒ¡ãƒ¼ã‚¸å›³

```mermaid
flowchart TD
  A["Logs ãƒ†ãƒ¼ãƒ–ãƒ« (å…ƒãƒ‡ãƒ¼ã‚¿)"] --> B["ã‚µãƒ–ã‚¯ã‚¨ãƒª (åŠ å·¥å¾Œãƒ‡ãƒ¼ã‚¿)"]
  B --> C["åˆ¥å s ã¾ãŸã¯ t ã‚’ä»˜ã‘ã‚‹"]
  C --> D["å¤–å´ã®SELECTãŒ FROM s ã‚’å‚ç…§ã—ã¦æœ€çµ‚çµæžœã‚’ç”Ÿæˆ"]
```

---

## ðŸ”¹5. ã¾ã¨ã‚

| è¦ç´                 | èª¬æ˜Ž                                                |
| ------------------- | --------------------------------------------------- |
| `Logs`              | å…ƒã®ãƒ†ãƒ¼ãƒ–ãƒ«å                                      |
| `s` / `t`           | ä¸€æ™‚çš„ã«ä»˜ã‘ã‚‹**åˆ¥åï¼ˆaliasï¼‰**                     |
| å½¹å‰²                | ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚„åŒä¸€ãƒ†ãƒ¼ãƒ–ãƒ«å‚ç…§ã‚’ç°¡æ½”ã«æ‰±ã†ãŸã‚        |
| PostgreSQL ã®ãƒ«ãƒ¼ãƒ« | `FROM (SELECT ...) alias` ã® `alias` ã¯**çœç•¥ä¸å¯** |

---

ã‚‚ã—æ°—ã«ãªã‚‹å ´åˆã€è‹±èªžçš„ã«æ„å‘³ã‚’æŒãŸã›ã¦æ›¸ãã®ã‚‚ãŠã™ã™ã‚ã§ã™ ðŸ‘‡

```sql
FROM (SELECT ... ) AS sub
FROM (SELECT ... ) AS temp
FROM (SELECT ... ) AS grouped
```

---

ç´ æ™´ã‚‰ã—ã„ã§ã™ã­ ðŸ‘
ã§ã¯ã€ä»Šå›žã®ãƒ†ãƒ¼ãƒžã€Œ**SQL ã«ãŠã‘ã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆåˆ¥åï¼‰**ã€ã«ã¤ã„ã¦ã€
å®Ÿè·µçš„ãª 2 ã¤ã®é‡è¦ã‚±ãƒ¼ã‚¹ã‚’å›³è§£ä»˜ãã§è§£èª¬ã—ã¾ã™ã€‚

---

## ðŸ§© Part 1. è‡ªå·±çµåˆï¼ˆSelf Joinï¼‰ã«ãŠã‘ã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®ä½¿ã„æ–¹

---

## ðŸŽ¯ èƒŒæ™¯

åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¤‡æ•°å›žå‚ç…§ã™ã‚‹å ´åˆã€
ãƒ†ãƒ¼ãƒ–ãƒ«åãŒ 1 ã¤ã ã‘ã§ã¯ã©ã®åˆ—ã‚’æŒ‡ã—ã¦ã„ã‚‹ã®ã‹åˆ†ã‹ã‚‰ãªããªã‚Šã¾ã™ã€‚

â†’ ãã®ãŸã‚ã€**åŒä¸€ãƒ†ãƒ¼ãƒ–ãƒ«ã«åˆ¥åï¼ˆl1, l2, l3 ãªã©ï¼‰ã‚’ä»˜ã‘ã¦åŒºåˆ¥**ã—ã¾ã™ã€‚

---

## âœ… ä¾‹é¡Œï¼ˆLogs ãƒ†ãƒ¼ãƒ–ãƒ«ã§ 3 é€£ç¶šåˆ¤å®šï¼‰

```sql
SELECT DISTINCT l1.num AS "ConsecutiveNums"
FROM Logs l1
JOIN Logs l2 ON l2.id = l1.id + 1 AND l2.num = l1.num
JOIN Logs l3 ON l3.id = l2.id + 1 AND l3.num = l2.num;
```

---

### ðŸ“˜ è§£èª¬

| åˆ¥å | æŒ‡ã—ã¦ã„ã‚‹ã‚‚ã® | æ„å‘³                             |
| ---- | -------------- | -------------------------------- |
| `l1` | ç¾åœ¨è¡Œ         | 1 è¡Œç›®ãªã©åŸºæº–ã¨ãªã‚‹è¡Œ           |
| `l2` | æ¬¡ã®è¡Œ         | `id = l1.id + 1` ã§ 1 è¡Œå¾Œã‚’è¡¨ã™ |
| `l3` | ã•ã‚‰ã«æ¬¡ã®è¡Œ   | `id = l2.id + 1` ã§ 2 è¡Œå¾Œã‚’è¡¨ã™ |

---

## ðŸ§  å®Ÿè¡Œã‚¤ãƒ¡ãƒ¼ã‚¸

```mermaid
flowchart TD
  A["Logs as l1 (id=i, num=n)"] --> B["Logs as l2 (id=i+1)"]
  B --> C["Logs as l3 (id=i+2)"]
  A -. join by id+1 .-> B
  B -. join by id+1 .-> C
  C --> D{"l1.num = l2.num = l3.num ?"}
  D -- "Yes" --> E["Collect num"]
  D -- "No" --> F["Skip"]
```

---

### ðŸ§© çµæžœ

3 è¡Œé€£ç¶š (`l1`, `l2`, `l3`) ãŒåŒã˜ `num` ã®å ´åˆã®ã¿æŠ½å‡ºã•ã‚Œã¾ã™ã€‚
ã“ã“ã§ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ (`l1`, `l2`, `l3`) ã¯ã€ŒåŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ¥è¦–ç‚¹ã€ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚

---

## ðŸ§± Part 2. WITH å¥ï¼ˆCTEï¼‰ã«ãŠã‘ã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®ä½¿ã„æ–¹

---

### ðŸŽ¯ èƒŒæ™¯ 2

è¤‡é›‘ãªã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’åˆ†å‰²ã—ã¦è¦‹é€šã—ã‚’è‰¯ãã™ã‚‹ãŸã‚ã«
`WITH ... AS (...)` ã§åå‰ï¼ˆã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼‰ã‚’ä»˜ã‘ã¦å®šç¾©ã—ã¾ã™ã€‚

---

## âœ… ä¾‹ï¼ˆPostgreSQL æŽ¨å¥¨ã® CTE ç‰ˆï¼‰

```sql
WITH base AS (
  SELECT
    num,
    ROW_NUMBER() OVER (ORDER BY id)
    - ROW_NUMBER() OVER (PARTITION BY num ORDER BY id) AS grp
  FROM Logs
),
grouped AS (
  SELECT
    num,
    grp,
    COUNT(*) AS run_len
  FROM base
  GROUP BY num, grp
)
SELECT DISTINCT num AS "ConsecutiveNums"
FROM grouped
WHERE run_len >= 3;
```

---

### ðŸ“˜ è§£èª¬ 2

| ã‚¨ã‚¤ãƒªã‚¢ã‚¹  | å¯¾è±¡           | æ„å‘³                                                |
| ----------- | -------------- | --------------------------------------------------- |
| `base`      | æœ€åˆã®è¨ˆç®—çµæžœ | é€£ç¶šã‚°ãƒ«ãƒ¼ãƒ—ç•ªå· (`grp`) ã‚’ä»˜ä¸Žã—ãŸä¸­é–“çµæžœ         |
| `grouped`   | 2 æ®µç›®ã® CTE   | `num, grp` ã”ã¨ã«ã¾ã¨ã‚ã¦ `COUNT(*)` ã‚’ä»˜ä¸Žã—ãŸçµæžœ |
| æœ€çµ‚ SELECT | grouped ã‹ã‚‰   | é•·ã•ãŒ 3 ä»¥ä¸Šã®é€£ç¶šåŒºé–“ã ã‘ã‚’æŠ½å‡º                   |

---

## ðŸ§  å®Ÿè¡Œã‚¤ãƒ¡ãƒ¼ã‚¸ 2

```mermaid
flowchart TD
  A["Logs (å…ƒãƒ†ãƒ¼ãƒ–ãƒ«)"] --> B["base: add grp = row_numberå·®"]
  B --> C["grouped: group by num, grp & count(*)"]
  C --> D["SELECT WHERE run_len >= 3"]
  D --> E["å‡ºåŠ›: ConsecutiveNums"]
```

---

## ðŸ’¡ è£œè¶³ï¼šCTE ã®ãƒ¡ãƒªãƒƒãƒˆ

| åˆ©ç‚¹              | å†…å®¹                                                                  |
| ----------------- | --------------------------------------------------------------------- |
| å¯èª­æ€§            | è¤‡æ•°æ®µéšŽã®å‡¦ç†ã‚’ä¸Šã‹ã‚‰é †ã«èª¬æ˜Žçš„ã«æ›¸ã‘ã‚‹                              |
| å†åˆ©ç”¨æ€§          | åŒã˜ä¸­é–“çµæžœã‚’è¤‡æ•°å›žå‚ç…§ã§ãã‚‹                                        |
| ãƒ‡ãƒãƒƒã‚°æ€§        | å„ CTE ã‚’å˜ç‹¬ã§å®Ÿè¡Œã—ã¦å‹•ä½œç¢ºèªã§ãã‚‹                                 |
| PostgreSQL æœ€é©åŒ– | ä¸€éƒ¨ã® CTE ã¯æœ€é©åŒ–ã•ã‚Œã¦ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã•ã‚Œã‚‹ï¼ˆ`MATERIALIZED`ãƒ’ãƒ³ãƒˆå¯ï¼‰ |

---

## ðŸ§­ ã¾ã¨ã‚

| ä½¿ã„æ–¹         | ã‚¨ã‚¤ãƒªã‚¢ã‚¹        | ä¸»ãªç”¨é€”                           | æ³¨æ„ç‚¹                                     |
| -------------- | ----------------- | ---------------------------------- | ------------------------------------------ |
| **è‡ªå·±çµåˆ**   | `l1`, `l2`, `l3`  | åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¤‡æ•°å›ž JOIN ã—ã¦æ¯”è¼ƒ | å„ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’æ˜Žç¢ºã«æŒ‡å®šã—ãªã„ã¨æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ |
| **ã‚µãƒ–ã‚¯ã‚¨ãƒª** | `s`, `t`          | å†…éƒ¨ SELECT çµæžœã‚’å¤–éƒ¨ã§å‚ç…§       | ã‚µãƒ–ã‚¯ã‚¨ãƒªã®æœ«å°¾ã®åˆ¥åã¯å¿…é ˆ               |
| **CTE**        | `base`, `grouped` | åˆ†å‰²å®šç¾©ãƒ»å†åˆ©ç”¨                   | åå‰ã®ã‚¹ã‚³ãƒ¼ãƒ—ã¯ãã®ã‚¯ã‚¨ãƒªå†…ã®ã¿           |

---

## âœ… æœ€çµ‚ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼š3 ç¨®é¡žã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ä½ç½®ã¾ã¨ã‚

```mermaid
flowchart TB
  subgraph SelfJoin["è‡ªå·±çµåˆ"]
    A1["Logs as l1"]
    A2["Logs as l2"]
    A3["Logs as l3"]
  end
  subgraph Subquery["ã‚µãƒ–ã‚¯ã‚¨ãƒª"]
    B1["(SELECT ...) as s"]
  end
  subgraph CTE["WITHå¥"]
    C1["WITH base AS (SELECT ...)"]
    C2["grouped AS (SELECT ...)"]
  end
  A1 --> A2
  A2 --> A3
  B1 --> D1["SELECT FROM s"]
  C1 --> C2
  C2 --> D2["SELECT FROM grouped"]
```

---
