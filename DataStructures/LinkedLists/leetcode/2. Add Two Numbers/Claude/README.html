<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Add Two Numbers - 逆順連結リスト加算</title>

        <!-- React + ReactDOM + Babel -->
        <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
        ></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Prism.js -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css"
        />

        <!-- Google Fonts -->
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
            rel="stylesheet"
        />

        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body {
                font-family: 'Inter', system-ui, sans-serif;
            }

            :root {
                --code-lh: 1.6;
            }

            pre[class*='language-'],
            pre[class*='language-'] > code {
                line-height: var(--code-lh) !important;
                white-space: pre !important;
                word-break: normal !important;
                overflow-wrap: normal !important;
                font-family:
                    'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                    monospace;
            }

            pre.line-numbers {
                padding-left: 3.2em !important;
                border-radius: 12px;
                background: #1e293b !important;
            }

            .line-numbers .line-numbers-rows {
                width: 3.2em;
            }
            .line-numbers .line-numbers-rows > span {
                height: calc(var(--code-lh) * 1em);
            }

            div.code-toolbar > .toolbar {
                opacity: 1 !important;
            }

            div.code-toolbar > .toolbar .toolbar-item > button,
            div.code-toolbar > .toolbar .toolbar-item > a {
                background: #fff;
                border: 1px solid #e6e8ef;
                border-radius: 10px;
                padding: 6px 10px;
                font:
                    600 13px/1.2 Inter,
                    system-ui,
                    sans-serif;
                color: #334155;
                box-shadow: 0 2px 6px rgba(20, 32, 70, 0.06);
                transition:
                    transform 0.15s,
                    box-shadow 0.15s,
                    background 0.15s;
            }

            div.code-toolbar > .toolbar .toolbar-item > button:hover {
                transform: translateY(-1px);
                box-shadow: 0 10px 28px rgba(20, 32, 70, 0.08);
                background: linear-gradient(180deg, #d1fae5, #a7f3d0);
            }

            .step-btn {
                transition: all 0.2s;
            }

            .step-btn:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(16, 185, 129, 0.15);
            }

            .step-btn.active {
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
            }

            .control-btn {
                transition: all 0.2s;
            }

            .control-btn:hover:not(:disabled) {
                transform: translateY(-1px);
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            }

            .control-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            html {
                scroll-behavior: smooth;
            }

            @media (prefers-reduced-motion: reduce) {
                html {
                    scroll-behavior: auto;
                }
                * {
                    transition: none !important;
                }
            }
        </style>
    </head>
    <body class="bg-gradient-to-br from-emerald-50 via-white to-sky-50 min-h-screen">
        <!-- Header -->
        <header
            class="bg-white/80 backdrop-blur-sm border-b border-emerald-100 sticky top-0 z-50 shadow-sm"
        >
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <h1
                    class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-emerald-600 to-sky-600 bg-clip-text text-transparent mb-2"
                >
                    Add Two Numbers
                </h1>
                <p class="text-slate-600 text-sm sm:text-base">
                    LeetCode 2 - 逆順連結リスト加算（同時走査 + 繰り上がり伝搬）
                </p>

                <!-- Navigation -->
                <nav class="mt-6 flex flex-wrap gap-2" aria-label="ページ内ナビゲーション">
                    <a
                        href="#overview"
                        class="px-4 py-2 bg-white rounded-lg border border-emerald-200 text-emerald-700 font-semibold text-sm hover:bg-emerald-50 hover:shadow-md transition"
                        aria-label="概要セクションへ移動"
                        >概要</a
                    >
                    <a
                        href="#steps"
                        class="px-4 py-2 bg-white rounded-lg border border-sky-200 text-sky-700 font-semibold text-sm hover:bg-sky-50 hover:shadow-md transition"
                        aria-label="ステップ解説セクションへ移動"
                        >ステップ</a
                    >
                    <a
                        href="#code"
                        class="px-4 py-2 bg-white rounded-lg border border-slate-200 text-slate-700 font-semibold text-sm hover:bg-slate-50 hover:shadow-md transition"
                        aria-label="コードセクションへ移動"
                        >コード</a
                    >
                    <a
                        href="#diagram"
                        class="px-4 py-2 bg-white rounded-lg border border-violet-200 text-violet-700 font-semibold text-sm hover:bg-violet-50 hover:shadow-md transition"
                        aria-label="図解セクションへ移動"
                        >図解</a
                    >
                    <a
                        href="#complexity"
                        class="px-4 py-2 bg-white rounded-lg border border-amber-200 text-amber-700 font-semibold text-sm hover:bg-amber-50 hover:shadow-md transition"
                        aria-label="計算量セクションへ移動"
                        >計算量</a
                    >
                </nav>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 space-y-16">
            <!-- Overview Section -->
            <section id="overview" class="scroll-mt-24">
                <div class="bg-white rounded-xl shadow-lg border border-emerald-100 p-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <span
                            class="w-10 h-10 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-lg flex items-center justify-center text-white font-bold"
                            >1</span
                        >
                        概要
                    </h2>

                    <div class="space-y-4 text-slate-700 leading-relaxed">
                        <p class="text-lg">
                            <strong>問題:</strong>
                            2つの非空連結リストで表された非負整数を加算し、結果を連結リストで返す。各ノードは単一の桁を保持し、桁は<strong>逆順</strong>で格納されている。
                        </p>

                        <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 rounded-r-lg">
                            <p class="font-semibold text-emerald-900 mb-2">例:</p>
                            <code class="text-sm">l1 = [2,4,3], l2 = [5,6,4] → [7,0,8]</code>
                            <p class="text-sm text-emerald-700 mt-1">（342 + 465 = 807）</p>
                        </div>

                        <p>
                            <strong>アルゴリズム戦略:</strong>
                            2つのリストを<strong>同時走査</strong>し、各桁の和と繰り上がり（carry）を計算。番兵ノードとテールポインタでO(1)追加を実現。
                        </p>

                        <ul class="list-disc list-inside space-y-2 ml-4">
                            <li><strong>時間計算量:</strong> O(n) - n = max(len(l1), len(l2))</li>
                            <li><strong>空間計算量:</strong> O(1) - 出力ノードを除く補助空間</li>
                            <li><strong>データ構造:</strong> ListNode（単方向連結リスト）</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Steps Section (Interactive) -->
            <section id="steps" class="scroll-mt-24">
                <div class="bg-white rounded-xl shadow-lg border border-sky-100 p-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <span
                            class="w-10 h-10 bg-gradient-to-br from-sky-400 to-sky-600 rounded-lg flex items-center justify-center text-white font-bold"
                            >2</span
                        >
                        ステップバイステップ解説
                    </h2>

                    <div id="interactive-demo"></div>
                </div>
            </section>

            <!-- Code Section -->
            <section id="code" class="scroll-mt-24">
                <div class="bg-white rounded-xl shadow-lg border border-slate-100 p-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <span
                            class="w-10 h-10 bg-gradient-to-br from-slate-400 to-slate-600 rounded-lg flex items-center justify-center text-white font-bold"
                            >3</span
                        >
                        Python実装（LeetCode形式）
                    </h2>

                    <div class="bg-slate-50 rounded-lg p-4 mb-4">
                        <p class="text-sm text-slate-600">
                            <strong>ポイント:</strong>
                            番兵ノードで先頭処理を簡潔化、テールポインタでO(1)追加、非破壊的な実装
                        </p>
                    </div>

                    <pre
                        class="line-numbers"
                    ><code class="language-python">from __future__ import annotations
from typing import Optional, TYPE_CHECKING

if TYPE_CHECKING:
    class ListNode:
        val: int
        next: Optional[ListNode]
        def __init__(self, val: int = 0, next: Optional[ListNode] = None) -> None: ...
else:
    try:
        from leetcode_structures import ListNode  # type: ignore
    except (ImportError, ModuleNotFoundError):
        class ListNode:
            __slots__ = ("val", "next")
            def __init__(self, val: int = 0, next: Optional[ListNode] = None) -> None:
                self.val = val
                self.next = next


class Solution:
    """
    LeetCode 2: Add Two Numbers

    2つの逆順連結リストで表された非負整数を加算し、
    結果を逆順連結リストで返す。

    時間計算量: O(n) - n = max(len(l1), len(l2))
    空間計算量: O(1) - 出力ノードを除く補助空間
    """

    def addTwoNumbers(
        self,
        l1: Optional[ListNode],
        l2: Optional[ListNode]
    ) -> Optional[ListNode]:
        """
        2つの逆順リストの和を逆順リストで返す。

        Args:
            l1: 第1の数の逆順連結リスト（最下位桁が先頭）
            l2: 第2の数の逆順連結リスト（最下位桁が先頭）

        Returns:
            和を表す逆順連結リスト
        """
        # 番兵ノード: 先頭ノードの特別処理を排除
        dummy: ListNode = ListNode(0)
        tail: ListNode = dummy

        # 走査ポインタと繰り上がり
        p: Optional[ListNode] = l1
        q: Optional[ListNode] = l2
        carry: int = 0

        # いずれかのリストが残るか、繰り上がりが残る限り処理
        while p is not None or q is not None or carry != 0:
            # 現在の桁の値を取得（リストが終了していれば0）
            x: int = p.val if p is not None else 0
            y: int = q.val if q is not None else 0

            # 桁の和 + 繰り上がりを計算
            sum_: int = x + y + carry
            carry = sum_ // 10  # 新しい繰り上がり
            digit: int = sum_ % 10  # 現在の桁の値

            # 結果ノードを生成して末尾に追加
            tail.next = ListNode(digit)
            tail = tail.next

            # ポインタを前進（存在する場合のみ）
            if p is not None:
                p = p.next
            if q is not None:
                q = q.next

        # 番兵の次が実際の結果の先頭
        return dummy.next</code></pre>
                </div>
            </section>

            <!-- Diagram Section -->
            <section id="diagram" class="scroll-mt-24">
                <div class="bg-white rounded-xl shadow-lg border border-violet-100 p-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <span
                            class="w-10 h-10 bg-gradient-to-br from-violet-400 to-violet-600 rounded-lg flex items-center justify-center text-white font-bold"
                            >4</span
                        >
                        アルゴリズムフローチャート
                    </h2>

                    <div class="bg-gradient-to-br from-violet-50 to-sky-50 rounded-lg p-8">
                        <svg
                            viewBox="0 0 800 900"
                            class="w-full max-w-3xl mx-auto"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <!-- 開始 -->
                            <rect
                                x="300"
                                y="20"
                                width="200"
                                height="60"
                                rx="30"
                                fill="#10b981"
                                stroke="#059669"
                                stroke-width="2"
                            />
                            <text
                                x="400"
                                y="55"
                                text-anchor="middle"
                                fill="white"
                                font-family="Inter"
                                font-weight="600"
                                font-size="16"
                            >
                                開始
                            </text>

                            <!-- 矢印 -->
                            <path
                                d="M 400 80 L 400 120"
                                stroke="#334155"
                                stroke-width="2"
                                fill="none"
                                marker-end="url(#arrowhead)"
                            />

                            <!-- 初期化 -->
                            <rect
                                x="250"
                                y="120"
                                width="300"
                                height="80"
                                rx="12"
                                fill="#fff"
                                stroke="#10b981"
                                stroke-width="2"
                            />
                            <text
                                x="400"
                                y="150"
                                text-anchor="middle"
                                font-family="Inter"
                                font-weight="600"
                                font-size="14"
                                fill="#334155"
                            >
                                初期化
                            </text>
                            <text
                                x="400"
                                y="172"
                                text-anchor="middle"
                                font-family="Inter"
                                font-size="12"
                                fill="#64748b"
                            >
                                dummy, tail, p=l1, q=l2
                            </text>
                            <text
                                x="400"
                                y="190"
                                text-anchor="middle"
                                font-family="Inter"
                                font-size="12"
                                fill="#64748b"
                            >
                                carry=0
                            </text>

                            <!-- 矢印 -->
                            <path
                                d="M 400 200 L 400 240"
                                stroke="#334155"
                                stroke-width="2"
                                fill="none"
                                marker-end="url(#arrowhead)"
                            />

                            <!-- ループ条件 -->
                            <path
                                d="M 400 240 L 500 290 L 400 340 L 300 290 Z"
                                fill="#fef3c7"
                                stroke="#f59e0b"
                                stroke-width="2"
                            />
                            <text
                                x="400"
                                y="285"
                                text-anchor="middle"
                                font-family="Inter"
                                font-weight="600"
                                font-size="13"
                                fill="#92400e"
                            >
                                p or q or
                            </text>
                            <text
                                x="400"
                                y="302"
                                text-anchor="middle"
                                font-family="Inter"
                                font-weight="600"
                                font-size="13"
                                fill="#92400e"
                            >
                                carry?
                            </text>

                            <!-- Noの分岐 -->
                            <path
                                d="M 500 290 L 600 290 L 600 850 L 500 850"
                                stroke="#334155"
                                stroke-width="2"
                                fill="none"
                                marker-end="url(#arrowhead)"
                            />
                            <text x="560" y="285" font-family="Inter" font-size="12" fill="#64748b">
                                いいえ
                            </text>

                            <!-- Yesの分岐 -->
                            <path
                                d="M 400 340 L 400 380"
                                stroke="#334155"
                                stroke-width="2"
                                fill="none"
                                marker-end="url(#arrowhead)"
                            />
                            <text x="360" y="365" font-family="Inter" font-size="12" fill="#64748b">
                                はい
                            </text>

                            <!-- 値を取得 -->
                            <rect
                                x="250"
                                y="380"
                                width="300"
                                height="60"
                                rx="12"
                                fill="#fff"
                                stroke="#0ea5e9"
                                stroke-width="2"
                            />
                            <text
                                x="400"
                                y="405"
                                text-anchor="middle"
                                font-family="Inter"
                                font-weight="600"
                                font-size="14"
                                fill="#334155"
                            >
                                値を取得
                            </text>
                            <text
                                x="400"
                                y="424"
                                text-anchor="middle"
                                font-family="Inter"
                                font-size="12"
                                fill="#64748b"
                            >
                                x = p.val または 0, y = q.val または 0
                            </text>

                            <!-- 矢印 -->
                            <path
                                d="M 400 440 L 400 480"
                                stroke="#334155"
                                stroke-width="2"
                                fill="none"
                                marker-end="url(#arrowhead)"
                            />

                            <!-- 合計を計算 -->
                            <rect
                                x="250"
                                y="480"
                                width="300"
                                height="60"
                                rx="12"
                                fill="#fff"
                                stroke="#8b5cf6"
                                stroke-width="2"
                            />
                            <text
                                x="400"
                                y="505"
                                text-anchor="middle"
                                font-family="Inter"
                                font-weight="600"
                                font-size="14"
                                fill="#334155"
                            >
                                計算
                            </text>
                            <text
                                x="400"
                                y="524"
                                text-anchor="middle"
                                font-family="Inter"
                                font-size="12"
                                fill="#64748b"
                            >
                                sum = x + y + carry
                            </text>

                            <!-- 矢印 -->
                            <path
                                d="M 400 540 L 400 580"
                                stroke="#334155"
                                stroke-width="2"
                                fill="none"
                                marker-end="url(#arrowhead)"
                            />

                            <!-- 分割 -->
                            <rect
                                x="250"
                                y="580"
                                width="300"
                                height="60"
                                rx="12"
                                fill="#fff"
                                stroke="#ec4899"
                                stroke-width="2"
                            />
                            <text
                                x="400"
                                y="605"
                                text-anchor="middle"
                                font-family="Inter"
                                font-weight="600"
                                font-size="14"
                                fill="#334155"
                            >
                                分割
                            </text>
                            <text
                                x="400"
                                y="624"
                                text-anchor="middle"
                                font-family="Inter"
                                font-size="12"
                                fill="#64748b"
                            >
                                carry = sum // 10, digit = sum % 10
                            </text>

                            <!-- 矢印 -->
                            <path
                                d="M 400 640 L 400 680"
                                stroke="#334155"
                                stroke-width="2"
                                fill="none"
                                marker-end="url(#arrowhead)"
                            />

                            <!-- ノードを作成 -->
                            <rect
                                x="250"
                                y="680"
                                width="300"
                                height="60"
                                rx="12"
                                fill="#fff"
                                stroke="#10b981"
                                stroke-width="2"
                            />
                            <text
                                x="400"
                                y="705"
                                text-anchor="middle"
                                font-family="Inter"
                                font-weight="600"
                                font-size="14"
                                fill="#334155"
                            >
                                作成と追加
                            </text>
                            <text
                                x="400"
                                y="724"
                                text-anchor="middle"
                                font-family="Inter"
                                font-size="12"
                                fill="#64748b"
                            >
                                tail.next = ListNode(digit)
                            </text>

                            <!-- 矢印 -->
                            <path
                                d="M 250 710 L 200 710 L 200 290 L 300 290"
                                stroke="#334155"
                                stroke-width="2"
                                fill="none"
                                marker-end="url(#arrowhead)"
                            />

                            <!-- 返却 -->
                            <rect
                                x="300"
                                y="820"
                                width="200"
                                height="60"
                                rx="30"
                                fill="#10b981"
                                stroke="#059669"
                                stroke-width="2"
                            />
                            <text
                                x="400"
                                y="845"
                                text-anchor="middle"
                                fill="white"
                                font-family="Inter"
                                font-weight="600"
                                font-size="16"
                            >
                                返却
                            </text>
                            <text
                                x="400"
                                y="863"
                                text-anchor="middle"
                                fill="white"
                                font-family="Inter"
                                font-size="12"
                            >
                                dummy.next
                            </text>

                            <!-- 矢印マーカー -->
                            <defs>
                                <marker
                                    id="arrowhead"
                                    markerWidth="10"
                                    markerHeight="10"
                                    refX="9"
                                    refY="3"
                                    orient="auto"
                                >
                                    <polygon points="0 0, 10 3, 0 6" fill="#334155" />
                                </marker>
                            </defs>
                        </svg>
                    </div>
                    <p class="text-sm text-slate-600 mt-6 text-center">
                        ループ条件でいずれかのポインタまたはcarryが存在する限り処理を継続。各反復で桁を計算し、新ノードを追加してポインタを前進。
                    </p>
                </div>
            </section>

            <!-- Complexity Section -->
            <section id="complexity" class="scroll-mt-24">
                <div class="bg-white rounded-xl shadow-lg border border-amber-100 p-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <span
                            class="w-10 h-10 bg-gradient-to-br from-amber-400 to-amber-600 rounded-lg flex items-center justify-center text-white font-bold"
                            >5</span
                        >
                        計算量分析
                    </h2>

                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Time Complexity -->
                        <div
                            class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-lg p-6 border-l-4 border-emerald-500"
                        >
                            <h3 class="text-xl font-bold text-emerald-900 mb-3">時間計算量</h3>
                            <p class="text-3xl font-bold text-emerald-700 mb-2">O(n)</p>
                            <p class="text-sm text-emerald-800 leading-relaxed">
                                n = max(len(l1), len(l2))<br />
                                各ノードを1回ずつ訪問し、定数時間の演算のみ実行。
                            </p>
                        </div>

                        <!-- Space Complexity -->
                        <div
                            class="bg-gradient-to-br from-sky-50 to-sky-100 rounded-lg p-6 border-l-4 border-sky-500"
                        >
                            <h3 class="text-xl font-bold text-sky-900 mb-3">空間計算量</h3>
                            <p class="text-3xl font-bold text-sky-700 mb-2">O(1)</p>
                            <p class="text-sm text-sky-800 leading-relaxed">
                                出力ノードを除く補助空間。番兵ノード、ポインタ変数のみ使用。入力リストは変更しない。
                            </p>
                        </div>
                    </div>

                    <div class="mt-8 bg-slate-50 rounded-lg p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">効率性のポイント</h3>
                        <ul class="space-y-2 text-slate-700">
                            <li class="flex items-start gap-2">
                                <span class="text-emerald-500 font-bold mt-1">✓</span>
                                <span><strong>単一パス:</strong> 1回の走査で全処理完了</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-emerald-500 font-bold mt-1">✓</span>
                                <span><strong>定数空間:</strong> 追加の配列やスタック不要</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-emerald-500 font-bold mt-1">✓</span>
                                <span
                                    ><strong>非破壊的:</strong> 入力リストを変更しないため安全</span
                                >
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-emerald-500 font-bold mt-1">✓</span>
                                <span><strong>スケーラブル:</strong> 桁数が増えても線形に対応</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>
        </main>

        <footer class="bg-slate-800 text-white py-8 mt-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <p class="text-sm text-slate-400">
                    LeetCode 2: Add Two Numbers - Algorithm Visualization
                </p>
                <p class="text-xs text-slate-500 mt-2">
                    Created with React 18 + Tailwind CSS + Prism.js
                </p>
            </div>
        </footer>

        <!-- Prism.js Scripts -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

        <!-- React Component -->
        <script type="text/babel">
            const { useState, useEffect, useRef } = React;

            const STEP_AUTO_ADVANCE_DELAY = 2000;
            const INITIAL_STEP = 1;

            const stepsData = [
                {
                    step: 1,
                    title: '初期化',
                    desc: '番兵ノード（dummy）とテールポインタを準備。p=l1、q=l2、carry=0に設定。',
                    visual: {
                        type: 'init',
                        l1: [2, 4, 3],
                        l2: [5, 6, 4],
                        carry: 0,
                    },
                },
                {
                    step: 2,
                    title: '第1桁の加算',
                    desc: 'p.val=2、q.val=5 を取得。sum=2+5+0=7。carry=0、digit=7。新ノード[7]を作成。',
                    visual: {
                        type: 'iteration',
                        l1: [2, 4, 3],
                        l2: [5, 6, 4],
                        p: 0,
                        q: 0,
                        carry: 0,
                        digit: 7,
                        result: [7],
                    },
                },
                {
                    step: 3,
                    title: '第2桁の加算',
                    desc: 'p.val=4、q.val=6 を取得。sum=4+6+0=10。carry=1、digit=0。新ノード[0]を追加。',
                    visual: {
                        type: 'iteration',
                        l1: [2, 4, 3],
                        l2: [5, 6, 4],
                        p: 1,
                        q: 1,
                        carry: 1,
                        digit: 0,
                        result: [7, 0],
                    },
                },
                {
                    step: 4,
                    title: '第3桁の加算',
                    desc: 'p.val=3、q.val=4 を取得。sum=3+4+1=8。carry=0、digit=8。新ノード[8]を追加。',
                    visual: {
                        type: 'iteration',
                        l1: [2, 4, 3],
                        l2: [5, 6, 4],
                        p: 2,
                        q: 2,
                        carry: 0,
                        digit: 8,
                        result: [7, 0, 8],
                    },
                },
                {
                    step: 5,
                    title: '完了',
                    desc: '両リストが終了し、carry=0。ループ終了。dummy.nextを返す。',
                    visual: {
                        type: 'result',
                        result: [7, 0, 8],
                    },
                },
            ];

            function StepVisualization({ stepInfo }) {
                const { visual } = stepInfo;

                if (visual.type === 'init') {
                    return (
                        <svg viewBox="0 0 700 320" className="w-full mx-auto">
                            {/* L1 List */}
                            <text
                                x="130"
                                y="40"
                                fontFamily="Inter"
                                fontWeight="600"
                                fontSize="18"
                                fill="#334155"
                            >
                                l1:
                            </text>
                            {visual.l1.map((val, i) => (
                                <g key={`l1-${i}`}>
                                    <rect
                                        x={200 + i * 90}
                                        y="20"
                                        width="70"
                                        height="45"
                                        rx="8"
                                        fill="#dbeafe"
                                        stroke="#3b82f6"
                                        strokeWidth="2"
                                    />
                                    <text
                                        x={235 + i * 90}
                                        y="48"
                                        textAnchor="middle"
                                        fontFamily="Inter"
                                        fontWeight="600"
                                        fontSize="20"
                                        fill="#1e40af"
                                    >
                                        {val}
                                    </text>
                                    {i < visual.l1.length - 1 && (
                                        <path
                                            d={`M ${270 + i * 90} 42 L ${200 + (i + 1) * 90} 42`}
                                            stroke="#64748b"
                                            strokeWidth="2"
                                            markerEnd="url(#arrow)"
                                        />
                                    )}
                                </g>
                            ))}

                            {/* L2 List */}
                            <text
                                x="130"
                                y="125"
                                fontFamily="Inter"
                                fontWeight="600"
                                fontSize="18"
                                fill="#334155"
                            >
                                l2:
                            </text>
                            {visual.l2.map((val, i) => (
                                <g key={`l2-${i}`}>
                                    <rect
                                        x={200 + i * 90}
                                        y="105"
                                        width="70"
                                        height="45"
                                        rx="8"
                                        fill="#fef3c7"
                                        stroke="#f59e0b"
                                        strokeWidth="2"
                                    />
                                    <text
                                        x={235 + i * 90}
                                        y="133"
                                        textAnchor="middle"
                                        fontFamily="Inter"
                                        fontWeight="600"
                                        fontSize="20"
                                        fill="#92400e"
                                    >
                                        {val}
                                    </text>
                                    {i < visual.l2.length - 1 && (
                                        <path
                                            d={`M ${270 + i * 90} 127 L ${200 + (i + 1) * 90} 127`}
                                            stroke="#64748b"
                                            strokeWidth="2"
                                            markerEnd="url(#arrow)"
                                        />
                                    )}
                                </g>
                            ))}

                            {/* Pointers */}
                            <text
                                x="235"
                                y="85"
                                textAnchor="middle"
                                fontFamily="Inter"
                                fontSize="16"
                                fill="#10b981"
                                fontWeight="700"
                            >
                                ポインタ p
                            </text>
                            <text
                                x="235"
                                y="170"
                                textAnchor="middle"
                                fontFamily="Inter"
                                fontSize="16"
                                fill="#f59e0b"
                                fontWeight="700"
                            >
                                ポインタ q
                            </text>

                            {/* Carry */}
                            <g>
                                <rect
                                    x="130"
                                    y="200"
                                    width="140"
                                    height="55"
                                    rx="8"
                                    fill="#f0fdf4"
                                    stroke="#10b981"
                                    strokeWidth="2"
                                />
                                <text
                                    x="200"
                                    y="222"
                                    textAnchor="middle"
                                    fontFamily="Inter"
                                    fontSize="16"
                                    fill="#166534"
                                    fontWeight="600"
                                >
                                    繰り上がり
                                </text>
                                <text
                                    x="200"
                                    y="245"
                                    textAnchor="middle"
                                    fontFamily="Inter"
                                    fontWeight="700"
                                    fontSize="22"
                                    fill="#10b981"
                                >
                                    {visual.carry}
                                </text>
                            </g>

                            {/* Dummy */}
                            <g>
                                <rect
                                    x="130"
                                    y="270"
                                    width="110"
                                    height="45"
                                    rx="8"
                                    fill="#e2e8f0"
                                    stroke="#64748b"
                                    strokeWidth="2"
                                />
                                <text
                                    x="185"
                                    y="297"
                                    textAnchor="middle"
                                    fontFamily="Inter"
                                    fontWeight="600"
                                    fontSize="17"
                                    fill="#475569"
                                >
                                    番兵ノード
                                </text>
                            </g>

                            <defs>
                                <marker
                                    id="arrow"
                                    markerWidth="10"
                                    markerHeight="10"
                                    refX="9"
                                    refY="3"
                                    orient="auto"
                                >
                                    <polygon points="0 0, 10 3, 0 6" fill="#64748b" />
                                </marker>
                            </defs>
                        </svg>
                    );
                }

                if (visual.type === 'iteration') {
                    return (
                        <svg viewBox="0 0 750 440" className="w-full mx-auto">
                            {/* L1 List */}
                            <text
                                x="130"
                                y="40"
                                fontFamily="Inter"
                                fontWeight="600"
                                fontSize="18"
                                fill="#334155"
                            >
                                l1:
                            </text>
                            {visual.l1.map((val, i) => (
                                <g key={`l1-${i}`}>
                                    <rect
                                        x={200 + i * 90}
                                        y="20"
                                        width="70"
                                        height="45"
                                        rx="8"
                                        fill={i === visual.p ? '#bfdbfe' : '#dbeafe'}
                                        stroke={i === visual.p ? '#2563eb' : '#3b82f6'}
                                        strokeWidth={i === visual.p ? '3' : '2'}
                                    />
                                    <text
                                        x={235 + i * 90}
                                        y="48"
                                        textAnchor="middle"
                                        fontFamily="Inter"
                                        fontWeight="600"
                                        fontSize="20"
                                        fill="#1e40af"
                                    >
                                        {val}
                                    </text>
                                    {i < visual.l1.length - 1 && (
                                        <path
                                            d={`M ${270 + i * 90} 42 L ${200 + (i + 1) * 90} 42`}
                                            stroke="#64748b"
                                            strokeWidth="2"
                                            markerEnd="url(#arrow2)"
                                        />
                                    )}
                                </g>
                            ))}

                            {/* L2 List */}
                            <text
                                x="130"
                                y="125"
                                fontFamily="Inter"
                                fontWeight="600"
                                fontSize="18"
                                fill="#334155"
                            >
                                l2:
                            </text>
                            {visual.l2.map((val, i) => (
                                <g key={`l2-${i}`}>
                                    <rect
                                        x={200 + i * 90}
                                        y="105"
                                        width="70"
                                        height="45"
                                        rx="8"
                                        fill={i === visual.q ? '#fde68a' : '#fef3c7'}
                                        stroke={i === visual.q ? '#d97706' : '#f59e0b'}
                                        strokeWidth={i === visual.q ? '3' : '2'}
                                    />
                                    <text
                                        x={235 + i * 90}
                                        y="133"
                                        textAnchor="middle"
                                        fontFamily="Inter"
                                        fontWeight="600"
                                        fontSize="20"
                                        fill="#92400e"
                                    >
                                        {val}
                                    </text>
                                    {i < visual.l2.length - 1 && (
                                        <path
                                            d={`M ${270 + i * 90} 127 L ${200 + (i + 1) * 90} 127`}
                                            stroke="#64748b"
                                            strokeWidth="2"
                                            markerEnd="url(#arrow2)"
                                        />
                                    )}
                                </g>
                            ))}

                            {/* Pointers */}
                            <text
                                x={235 + visual.p * 90}
                                y="85"
                                textAnchor="middle"
                                fontFamily="Inter"
                                fontSize="16"
                                fill="#2563eb"
                                fontWeight="700"
                            >
                                ↑ p
                            </text>
                            <text
                                x={235 + visual.q * 90}
                                y="170"
                                textAnchor="middle"
                                fontFamily="Inter"
                                fontSize="16"
                                fill="#d97706"
                                fontWeight="700"
                            >
                                ↑ q
                            </text>

                            {/* Calculation */}
                            <g>
                                <rect
                                    x="130"
                                    y="200"
                                    width="400"
                                    height="90"
                                    rx="8"
                                    fill="#f0f9ff"
                                    stroke="#0ea5e9"
                                    strokeWidth="2"
                                />
                                <text
                                    x="330"
                                    y="230"
                                    textAnchor="middle"
                                    fontFamily="Inter"
                                    fontSize="17"
                                    fill="#0c4a6e"
                                    fontWeight="600"
                                >
                                    合計 = {visual.l1[visual.p]} + {visual.l2[visual.q]} +{' '}
                                    {visual.carry - (visual.digit >= 10 ? 1 : 0)} ={' '}
                                    {visual.l1[visual.p] +
                                        visual.l2[visual.q] +
                                        (visual.carry - (visual.digit >= 10 ? 1 : 0))}
                                </text>
                                <text
                                    x="330"
                                    y="260"
                                    textAnchor="middle"
                                    fontFamily="Inter"
                                    fontSize="17"
                                    fill="#0c4a6e"
                                    fontWeight="600"
                                >
                                    繰り上がり = {visual.carry}、桁 = {visual.digit}
                                </text>
                            </g>

                            {/* Result List */}
                            <text
                                x="130"
                                y="335"
                                fontFamily="Inter"
                                fontWeight="600"
                                fontSize="18"
                                fill="#334155"
                            >
                                結果:
                            </text>
                            {visual.result.map((val, i) => (
                                <g key={`result-${i}`}>
                                    <rect
                                        x={200 + i * 90}
                                        y="315"
                                        width="70"
                                        height="45"
                                        rx="8"
                                        fill={
                                            i === visual.result.length - 1 ? '#bbf7d0' : '#d1fae5'
                                        }
                                        stroke={
                                            i === visual.result.length - 1 ? '#059669' : '#10b981'
                                        }
                                        strokeWidth={i === visual.result.length - 1 ? '3' : '2'}
                                    />
                                    <text
                                        x={235 + i * 90}
                                        y="343"
                                        textAnchor="middle"
                                        fontFamily="Inter"
                                        fontWeight="600"
                                        fontSize="20"
                                        fill="#065f46"
                                    >
                                        {val}
                                    </text>
                                    {i < visual.result.length - 1 && (
                                        <path
                                            d={`M ${270 + i * 90} 337 L ${200 + (i + 1) * 90} 337`}
                                            stroke="#64748b"
                                            strokeWidth="2"
                                            markerEnd="url(#arrow2)"
                                        />
                                    )}
                                </g>
                            ))}

                            {visual.result.length > 0 && (
                                <text
                                    x={235 + (visual.result.length - 1) * 90}
                                    y="390"
                                    textAnchor="middle"
                                    fontFamily="Inter"
                                    fontSize="15"
                                    fill="#059669"
                                    fontWeight="600"
                                >
                                    ↑ 新しいノード
                                </text>
                            )}

                            <defs>
                                <marker
                                    id="arrow2"
                                    markerWidth="10"
                                    markerHeight="10"
                                    refX="9"
                                    refY="3"
                                    orient="auto"
                                >
                                    <polygon points="0 0, 10 3, 0 6" fill="#64748b" />
                                </marker>
                            </defs>
                        </svg>
                    );
                }

                if (visual.type === 'result') {
                    return (
                        <svg viewBox="0 0 700 220" className="w-full mx-auto">
                            <text
                                x="350"
                                y="45"
                                textAnchor="middle"
                                fontFamily="Inter"
                                fontWeight="600"
                                fontSize="19"
                                fill="#334155"
                            >
                                最終結果:
                            </text>

                            {visual.result.map((val, i) => (
                                <g key={`final-${i}`}>
                                    <rect
                                        x={205 + i * 90}
                                        y="70"
                                        width="70"
                                        height="55"
                                        rx="10"
                                        fill="#d1fae5"
                                        stroke="#10b981"
                                        strokeWidth="3"
                                    />
                                    <text
                                        x={240 + i * 90}
                                        y="105"
                                        textAnchor="middle"
                                        fontFamily="Inter"
                                        fontWeight="700"
                                        fontSize="23"
                                        fill="#065f46"
                                    >
                                        {val}
                                    </text>
                                    {i < visual.result.length - 1 && (
                                        <path
                                            d={`M ${275 + i * 90} 97 L ${205 + (i + 1) * 90} 97`}
                                            stroke="#10b981"
                                            strokeWidth="3"
                                            markerEnd="url(#arrow3)"
                                        />
                                    )}
                                </g>
                            ))}

                            <text
                                x="350"
                                y="170"
                                textAnchor="middle"
                                fontFamily="Inter"
                                fontSize="17"
                                fill="#059669"
                                fontWeight="600"
                            >
                                342 + 465 = 807 ✓
                            </text>

                            <defs>
                                <marker
                                    id="arrow3"
                                    markerWidth="10"
                                    markerHeight="10"
                                    refX="9"
                                    refY="3"
                                    orient="auto"
                                >
                                    <polygon points="0 0, 10 3, 0 6" fill="#10b981" />
                                </marker>
                            </defs>
                        </svg>
                    );
                }

                return null;
            }
            function VisualizerComponent() {
                const [activeStep, setActiveStep] = useState(INITIAL_STEP);
                const [isPlaying, setIsPlaying] = useState(false);
                const timerRef = useRef(null);

                const totalSteps = stepsData.length;
                const currentStepInfo =
                    stepsData.find((s) => s.step === activeStep) || stepsData[0];

                useEffect(() => {
                    if (!isPlaying) return;

                    timerRef.current = setTimeout(() => {
                        setActiveStep((prev) => {
                            const nextStep = prev + 1;
                            if (nextStep > totalSteps) {
                                setIsPlaying(false);
                                return INITIAL_STEP;
                            }
                            return nextStep;
                        });
                    }, STEP_AUTO_ADVANCE_DELAY);

                    return () => {
                        if (timerRef.current) {
                            clearTimeout(timerRef.current);
                        }
                    };
                }, [isPlaying, activeStep, totalSteps]);

                const handlePlay = () => {
                    if (isPlaying) return;
                    setActiveStep(INITIAL_STEP);
                    setIsPlaying(true);
                };

                const handleReset = () => {
                    setIsPlaying(false);
                    setActiveStep(INITIAL_STEP);
                    if (timerRef.current) {
                        clearTimeout(timerRef.current);
                    }
                };

                const handlePrev = () => {
                    if (activeStep > 1) {
                        setIsPlaying(false);
                        setActiveStep(activeStep - 1);
                    }
                };

                const handleNext = () => {
                    if (activeStep < totalSteps) {
                        setIsPlaying(false);
                        setActiveStep(activeStep + 1);
                    }
                };

                const handleStepClick = (step) => {
                    setIsPlaying(false);
                    setActiveStep(step);
                };

                return (
                    <div className="space-y-6">
                        {/* Controls */}
                        <div className="flex flex-wrap gap-3 justify-center">
                            <button
                                type="button"
                                onClick={handlePlay}
                                disabled={isPlaying}
                                className="control-btn px-6 py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-semibold rounded-lg shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                                aria-label="自動再生"
                            >
                                {isPlaying ? '再生中...' : '▶ Play'}
                            </button>

                            <button
                                type="button"
                                onClick={handleReset}
                                className="control-btn px-6 py-3 bg-gradient-to-r from-slate-500 to-slate-600 text-white font-semibold rounded-lg shadow-md"
                                aria-label="リセット"
                            >
                                ⟲ Reset
                            </button>

                            <button
                                type="button"
                                onClick={handlePrev}
                                disabled={activeStep === 1}
                                className="control-btn px-6 py-3 bg-white text-slate-700 font-semibold rounded-lg shadow-md border border-slate-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                aria-label="前のステップ"
                            >
                                ← Prev
                            </button>

                            <button
                                type="button"
                                onClick={handleNext}
                                disabled={activeStep === totalSteps}
                                className="control-btn px-6 py-3 bg-white text-slate-700 font-semibold rounded-lg shadow-md border border-slate-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                aria-label="次のステップ"
                            >
                                Next →
                            </button>
                        </div>

                        {/* Step Progress */}
                        <div className="flex justify-center items-center gap-2 flex-wrap">
                            {stepsData.map((step) => (
                                <button
                                    key={step.step}
                                    type="button"
                                    onClick={() => handleStepClick(step.step)}
                                    className={`step-btn px-4 py-2 rounded-lg font-semibold text-sm ${
                                        activeStep === step.step
                                            ? 'active'
                                            : 'bg-white text-slate-600 border border-slate-300 hover:bg-slate-50'
                                    }`}
                                    aria-label={`ステップ${step.step}に移動`}
                                    aria-current={activeStep === step.step ? 'step' : undefined}
                                >
                                    Step {step.step}
                                </button>
                            ))}
                        </div>

                        {/* Main Content Area */}
                        <div className="grid lg:grid-cols-2 gap-8">
                            {/* Step Description */}
                            <div className="bg-gradient-to-br from-sky-50 to-white rounded-lg p-6 border border-sky-200">
                                <div className="flex items-center gap-3 mb-4">
                                    <span className="w-12 h-12 bg-gradient-to-br from-sky-400 to-sky-600 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">
                                        {currentStepInfo.step}
                                    </span>
                                    <h3 className="text-xl font-bold text-slate-800">
                                        {currentStepInfo.title}
                                    </h3>
                                </div>

                                <p className="text-slate-700 leading-relaxed">
                                    {currentStepInfo.desc}
                                </p>

                                <div className="mt-4 pt-4 border-t border-sky-200">
                                    <p className="text-sm text-slate-500">
                                        ステップ {activeStep} / {totalSteps}
                                    </p>
                                </div>
                            </div>

                            {/* Visualization */}
                            <div className="bg-gradient-to-br from-violet-50 to-white rounded-lg p-6 border border-violet-200 flex items-center justify-center min-h-[300px]">
                                <StepVisualization stepInfo={currentStepInfo} />
                            </div>
                        </div>
                    </div>
                );
            }

            // Mount component
            const container = document.getElementById('interactive-demo');
            if (container) {
                const root = ReactDOM.createRoot(container);
                root.render(<VisualizerComponent />);
            }
        </script>
    </body>
</html>
