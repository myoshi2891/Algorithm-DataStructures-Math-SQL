<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LeetCode 99: Recover Binary Search Tree - 中順走査によるBST修復</title>

        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Source+Code+Pro:wght@400;500;600&display=swap"
            rel="stylesheet"
        />

        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Prism.js -->
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css"
            rel="stylesheet"
        />

        <!-- React 18 -->
        <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
        <script
            src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
            crossorigin
        ></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

        <style>
            html {
                scroll-behavior: smooth;
            }

            code[class*='language-'],
            pre[class*='language-'] {
                font-family: 'JetBrains Mono', 'Source Code Pro', monospace;
                font-size: 0.95rem;
            }

            div.code-toolbar > .toolbar {
                opacity: 1;
            }

            div.code-toolbar > .toolbar .toolbar-item > button,
            div.code-toolbar > .toolbar .toolbar-item > a {
                background: #fff;
                border: 1px solid #e6e8ef;
                border-radius: 10px;
                padding: 1rem 1.5rem;
                margin: 1rem 1rem 0 0;
                font:
                    600 13px/1.2 Inter,
                    system-ui,
                    sans-serif;
                color: #334155;
                box-shadow: 0 2px 6px rgba(20, 32, 70, 0.06);
                transition:
                    transform 0.15s,
                    box-shadow 0.15s,
                    background 0.15s;
            }

            div.code-toolbar > .toolbar .toolbar-item > button:hover {
                transform: translateY(-1px);
                box-shadow: 0 10px 28px rgba(20, 32, 70, 0.08);
                background: linear-gradient(180deg, #e8fff6, #c8f1e1);
            }
        </style>
    </head>
    <body
        class="min-h-screen p-8 sm:p-6 font-[Inter] text-slate-800 leading-relaxed bg-[linear-gradient(135deg,#f0fdf4_0%,#dbeafe_100%)]"
    >
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <header
                id="header"
                class="mb-8 rounded-2xl p-8 shadow-[0_10px_30px_rgba(16,185,129,0.10)] bg-[linear-gradient(135deg,#d1fae5,#bfdbfe)]"
            >
                <h1 class="text-[2.5rem] font-bold text-teal-800 mb-2">
                    Recover Binary Search Tree
                </h1>
                <p class="text-xl text-cyan-700 font-semibold mt-2">
                    中順走査（In-order Traversal）による O(n) 実装
                </p>
                <nav class="flex flex-wrap gap-4 mt-6">
                    <a
                        href="#overview"
                        class="inline-block px-5 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_10px_20px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-700"
                        >概要</a
                    >
                    <a
                        href="#steps"
                        class="inline-block px-5 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_10px_20px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-700"
                        >ステップ解説</a
                    >
                    <a
                        href="#code"
                        class="inline-block px-5 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_10px_20px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-700"
                        >コード</a
                    >
                    <a
                        href="#diagram"
                        class="inline-block px-5 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_10px_20px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-700"
                        >フローチャート</a
                    >
                    <a
                        href="#complexity"
                        class="inline-block px-5 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_10px_20px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-700"
                        >計算量</a
                    >
                </nav>
            </header>

            <!-- Overview -->
            <section id="overview" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="text-[2rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    アルゴリズム概要
                </h2>

                <h3 class="text-xl font-semibold text-teal-800 mt-6 mb-3">問題</h3>
                <p class="text-slate-700 leading-7 mb-4">
                    二分探索木（BST）において、<strong class="text-slate-800"
                        >ちょうど2つのノードの値が誤って入れ替わっている</strong
                    >。 木の構造を変更せずに、値のスワップのみでBSTを修復する。
                </p>

                <h3 class="text-xl font-semibold text-teal-800 mt-6 mb-3">入出力例</h3>
                <pre
                    class="bg-slate-100 p-4 rounded-lg overflow-x-auto text-sm text-slate-800"
                ><code>入力: root = [3,1,4,null,null,2]  (3と2が入れ替わっている)
出力: [2,1,4,null,null,3]

      3*              2
     / \    →       / \
    1   4          1   4
       /              /
      2*             3</code></pre>

                <h3 class="text-xl font-semibold text-teal-800 mt-6 mb-3">戦略</h3>
                <ul class="list-disc list-inside text-slate-700 space-y-2">
                    <li>
                        <strong class="text-slate-800">中順走査</strong>でBSTを走査すると<strong
                            class="text-slate-800"
                            >昇順列</strong
                        >が得られる
                    </li>
                    <li>
                        2ノード入れ替えにより、昇順列に<strong class="text-slate-800"
                            >1〜2箇所の違反</strong
                        >（prev &gt; curr）が発生
                    </li>
                    <li>違反箇所から入れ替わったノードを特定し、値をスワップして修復</li>
                </ul>

                <h3 class="text-xl font-semibold text-teal-800 mt-6 mb-3">違反パターン</h3>
                <div class="overflow-x-auto bg-white rounded-lg border border-slate-200">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-emerald-50">
                                <th
                                    class="border border-slate-300 px-4 py-2 text-left text-slate-800"
                                >
                                    ケース
                                </th>
                                <th
                                    class="border border-slate-300 px-4 py-2 text-left text-slate-800"
                                >
                                    正しい順序
                                </th>
                                <th
                                    class="border border-slate-300 px-4 py-2 text-left text-slate-800"
                                >
                                    入れ替え後
                                </th>
                                <th
                                    class="border border-slate-300 px-4 py-2 text-left text-slate-800"
                                >
                                    違反回数
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white">
                                <td class="border border-slate-300 px-4 py-2 text-slate-700">
                                    隣接ノード
                                </td>
                                <td class="border border-slate-300 px-4 py-2 text-slate-700">
                                    [1,2,3,4]
                                </td>
                                <td class="border border-slate-300 px-4 py-2 text-slate-700">
                                    [1,3,2,4]
                                </td>
                                <td class="border border-slate-300 px-4 py-2 text-slate-700">
                                    1回 (3&gt;2)
                                </td>
                            </tr>
                            <tr class="bg-slate-50">
                                <td class="border border-slate-300 px-4 py-2 text-slate-700">
                                    非隣接ノード
                                </td>
                                <td class="border border-slate-300 px-4 py-2 text-slate-700">
                                    [1,2,3,4]
                                </td>
                                <td class="border border-slate-300 px-4 py-2 text-slate-700">
                                    [1,4,3,2]
                                </td>
                                <td class="border border-slate-300 px-4 py-2 text-slate-700">
                                    2回 (4&gt;3, 3&gt;2)
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Steps (React Component) -->
            <section id="steps" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="text-[2rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    ステップバイステップ解説
                </h2>
                <div id="steps-root"></div>
            </section>

            <!-- Code -->
            <section id="code" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="text-[2rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    Python実装
                </h2>
                <div class="bg-[#1e1e1e] rounded-xl p-1">
                    <pre class="line-numbers"><code class="language-python">class Solution:
    def recoverTree(self, root: Optional[TreeNode]) -> None:
        """
        BST修復（再帰版）
        Time: O(n), Space: O(h)
        """
        self.first = self.second = self.prev = None
        self._inorder(root)
        # 値のスワップ
        self.first.val, self.second.val = self.second.val, self.first.val

    def _inorder(self, node: Optional[TreeNode]) -> None:
        if not node:
            return

        # 左部分木を走査
        self._inorder(node.left)

        # 違反チェック: prev > curr はBST違反
        if self.prev and self.prev.val > node.val:
            if not self.first:
                self.first = self.prev  # 最初の違反
            self.second = node  # 常に更新

        self.prev = node

        # 右部分木を走査
        self._inorder(node.right)</code></pre>
                </div>
            </section>

            <!-- Flowchart -->
            <section id="diagram" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="text-[2rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    フローチャート
                </h2>
                <div class="mt-5 overflow-x-auto">
                    <svg
                        viewBox="0 0 700 850"
                        className="max-w-full h-auto"
                        role="img"
                        aria-label="Recover BST flowchart"
                    >
                        viewBox="0 0 700 850"
                        style="max-width: 100%; height: auto"
                        role="img"
                        aria-label="Recover BST flowchart"
                    >
                        <!-- 背景（ダークモード対応） -->
                        <rect x="0" y="0" width="700" height="850" fill="#ffffff" rx="12" />

                        <defs>
                            <marker
                                id="arrow"
                                markerWidth="10"
                                markerHeight="10"
                                refX="8"
                                refY="3"
                                orient="auto"
                                markerUnits="strokeWidth"
                            >
                                <path d="M0,0 L0,6 L9,3 z" fill="#475569" />
                            </marker>
                            <marker
                                id="arrowGreen"
                                markerWidth="10"
                                markerHeight="10"
                                refX="8"
                                refY="3"
                                orient="auto"
                                markerUnits="strokeWidth"
                            >
                                <path d="M0,0 L0,6 L9,3 z" fill="#059669" />
                            </marker>
                            <marker
                                id="arrowRed"
                                markerWidth="10"
                                markerHeight="10"
                                refX="8"
                                refY="3"
                                orient="auto"
                                markerUnits="strokeWidth"
                            >
                                <path d="M0,0 L0,6 L9,3 z" fill="#dc2626" />
                            </marker>
                            <marker
                                id="arrowPurple"
                                markerWidth="10"
                                markerHeight="10"
                                refX="8"
                                refY="3"
                                orient="auto"
                                markerUnits="strokeWidth"
                            >
                                <path d="M0,0 L0,6 L9,3 z" fill="#7c3aed" />
                            </marker>
                        </defs>

                        <!-- ===== 1. 開始 ===== -->
                        <ellipse
                            cx="350"
                            cy="40"
                            rx="70"
                            ry="28"
                            fill="#d1fae5"
                            stroke="#10b981"
                            stroke-width="2"
                        />
                        <text
                            x="350"
                            y="40"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="16"
                            font-weight="600"
                            fill="#065f46"
                        >
                            開始
                        </text>

                        <!-- 矢印: 開始 → 初期化 -->
                        <path
                            d="M 350 68 L 350 92"
                            stroke="#475569"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrow)"
                        />

                        <!-- ===== 2. 初期化 ===== -->
                        <rect
                            x="200"
                            y="100"
                            width="300"
                            height="50"
                            rx="8"
                            fill="#e0f2fe"
                            stroke="#0284c7"
                            stroke-width="2"
                        />
                        <text
                            x="350"
                            y="125"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="600"
                            fill="#0c4a6e"
                        >
                            first, second, prev = None
                        </text>

                        <!-- 矢印: 初期化 → ノード確認 -->
                        <path
                            d="M 350 150 L 350 178"
                            stroke="#475569"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrow)"
                        />

                        <!-- ===== 3. ノード確認（条件分岐） ===== -->
                        <path
                            d="M 350 185 L 440 230 L 350 275 L 260 230 Z"
                            fill="#fef3c7"
                            stroke="#f59e0b"
                            stroke-width="2"
                        />
                        <text
                            x="350"
                            y="230"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="600"
                            fill="#92400e"
                        >
                            node is None?
                        </text>

                        <!-- 矢印: はい → return -->
                        <path
                            d="M 440 230 L 550 230"
                            stroke="#059669"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowGreen)"
                        />
                        <rect x="475" y="215" width="40" height="18" fill="#ffffff" />
                        <text
                            x="495"
                            y="224"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="12"
                            font-weight="600"
                            fill="#059669"
                        >
                            はい
                        </text>

                        <!-- return ノード -->
                        <rect
                            x="558"
                            y="205"
                            width="90"
                            height="50"
                            rx="8"
                            fill="#dcfce7"
                            stroke="#16a34a"
                            stroke-width="2"
                        />
                        <text
                            x="603"
                            y="230"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="600"
                            fill="#166534"
                        >
                            return
                        </text>

                        <!-- 矢印: いいえ → 左部分木 -->
                        <path
                            d="M 350 275 L 350 308"
                            stroke="#dc2626"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowRed)"
                        />
                        <rect x="330" y="278" width="50" height="18" fill="#ffffff" />
                        <text
                            x="355"
                            y="287"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="12"
                            font-weight="600"
                            fill="#dc2626"
                        >
                            いいえ
                        </text>

                        <!-- ===== 4. 左部分木走査 ===== -->
                        <rect
                            x="200"
                            y="315"
                            width="300"
                            height="50"
                            rx="8"
                            fill="#e0f2fe"
                            stroke="#0284c7"
                            stroke-width="2"
                        />
                        <text
                            x="350"
                            y="340"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="600"
                            fill="#0c4a6e"
                        >
                            inorder(node.left)
                        </text>

                        <!-- 矢印: 左部分木 → 違反チェック -->
                        <path
                            d="M 350 365 L 350 398"
                            stroke="#475569"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrow)"
                        />

                        <!-- ===== 5. 違反チェック（条件分岐） ===== -->
                        <path
                            d="M 350 405 L 460 460 L 350 515 L 240 460 Z"
                            fill="#fef3c7"
                            stroke="#f59e0b"
                            stroke-width="2"
                        />
                        <text
                            x="350"
                            y="450"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="13"
                            font-weight="600"
                            fill="#92400e"
                        >
                            <tspan x="350" dy="-10">prev and</tspan>
                            <tspan x="350" dy="20">prev.val &gt; node.val?</tspan>
                        </text>

                        <!-- 矢印: 違反あり（はい） → first確認 -->
                        <path
                            d="M 460 460 L 530 460"
                            stroke="#059669"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowGreen)"
                        />
                        <rect x="468" y="445" width="40" height="18" fill="#ffffff" />
                        <text
                            x="488"
                            y="454"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="12"
                            font-weight="600"
                            fill="#059669"
                        >
                            はい
                        </text>

                        <!-- ===== 6. first確認（小さい条件分岐） ===== -->
                        <path
                            d="M 570 430 L 620 460 L 570 490 L 520 460 Z"
                            fill="#fef3c7"
                            stroke="#f59e0b"
                            stroke-width="2"
                        />
                        <text
                            x="570"
                            y="460"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="12"
                            font-weight="600"
                            fill="#92400e"
                        >
                            first?
                        </text>

                        <!-- 矢印: first is None → first = prev -->
                        <path
                            d="M 570 430 L 570 385"
                            stroke="#dc2626"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowRed)"
                        />
                        <rect x="575" y="398" width="50" height="18" fill="#ffffff" />
                        <text
                            x="600"
                            y="407"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="11"
                            font-weight="600"
                            fill="#dc2626"
                        >
                            None
                        </text>

                        <!-- first = prev ノード -->
                        <rect
                            x="505"
                            y="340"
                            width="130"
                            height="38"
                            rx="6"
                            fill="#e0f2fe"
                            stroke="#0284c7"
                            stroke-width="2"
                        />
                        <text
                            x="570"
                            y="359"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="13"
                            font-weight="600"
                            fill="#0c4a6e"
                        >
                            first = prev
                        </text>

                        <!-- 矢印: first = prev → second = node へ合流 -->
                        <path
                            d="M 570 340 L 570 320 L 650 320 L 650 530 L 605 530"
                            stroke="#475569"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrow)"
                        />

                        <!-- 矢印: first exists → second = node -->
                        <path
                            d="M 570 490 L 570 515"
                            stroke="#475569"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrow)"
                        />

                        <!-- second = node ノード -->
                        <rect
                            x="505"
                            y="522"
                            width="130"
                            height="38"
                            rx="6"
                            fill="#e0f2fe"
                            stroke="#0284c7"
                            stroke-width="2"
                        />
                        <text
                            x="570"
                            y="541"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="13"
                            font-weight="600"
                            fill="#0c4a6e"
                        >
                            second = node
                        </text>

                        <!-- 矢印: second = node → prev = node へ合流 -->
                        <path
                            d="M 505 541 L 450 541 L 450 610 L 405 610"
                            stroke="#475569"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrow)"
                        />

                        <!-- 矢印: 違反なし（いいえ） → prev = node -->
                        <path
                            d="M 350 515 L 350 585"
                            stroke="#dc2626"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowRed)"
                        />
                        <rect x="330" y="530" width="50" height="18" fill="#ffffff" />
                        <text
                            x="355"
                            y="539"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="12"
                            font-weight="600"
                            fill="#dc2626"
                        >
                            いいえ
                        </text>

                        <!-- ===== 7. prev更新 ===== -->
                        <rect
                            x="250"
                            y="592"
                            width="200"
                            height="45"
                            rx="8"
                            fill="#e0f2fe"
                            stroke="#0284c7"
                            stroke-width="2"
                        />
                        <text
                            x="350"
                            y="615"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="600"
                            fill="#0c4a6e"
                        >
                            prev = node
                        </text>

                        <!-- 矢印: prev更新 → 右部分木 -->
                        <path
                            d="M 350 637 L 350 668"
                            stroke="#475569"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrow)"
                        />

                        <!-- ===== 8. 右部分木走査 ===== -->
                        <rect
                            x="200"
                            y="675"
                            width="300"
                            height="50"
                            rx="8"
                            fill="#e0f2fe"
                            stroke="#0284c7"
                            stroke-width="2"
                        />
                        <text
                            x="350"
                            y="700"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="600"
                            fill="#0c4a6e"
                        >
                            inorder(node.right)
                        </text>

                        <!-- 矢印: 右部分木 → 再帰終了（ループバック） -->
                        <path
                            d="M 200 700 L 80 700 L 80 230 L 255 230"
                            stroke="#7c3aed"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowPurple)"
                        />
                        <rect x="55" y="450" width="60" height="22" fill="#f3e8ff" rx="4" />
                        <text
                            x="85"
                            y="461"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="11"
                            font-weight="600"
                            fill="#7c3aed"
                        >
                            再帰
                        </text>

                        <!-- 矢印: return → 終了 -->
                        <path
                            d="M 603 255 L 603 790 L 380 790"
                            stroke="#059669"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowGreen)"
                        />

                        <!-- 矢印: 右部分木 → 終了 -->
                        <path
                            d="M 350 725 L 350 768"
                            stroke="#475569"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrow)"
                        />

                        <!-- ===== 9. 終了 ===== -->
                        <ellipse
                            cx="350"
                            cy="800"
                            rx="70"
                            ry="28"
                            fill="#d1fae5"
                            stroke="#10b981"
                            stroke-width="2"
                        />
                        <text
                            x="350"
                            y="800"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="16"
                            font-weight="600"
                            fill="#065f46"
                        >
                            終了
                        </text>
                    </svg>
                </div>

                <p class="mt-8 text-slate-600 leading-7">
                    <strong class="text-lg text-teal-800">フローの説明：</strong><br /><br />
                    <span
                        class="inline-block w-6 h-6 rounded-full bg-emerald-100 text-emerald-700 text-center font-bold mr-2"
                        >1</span
                    >初期化: first, second, prev を None に設定<br /><br />
                    <span
                        class="inline-block w-6 h-6 rounded-full bg-emerald-100 text-emerald-700 text-center font-bold mr-2"
                        >2</span
                    >ノードがNoneなら即座にreturn（基底条件）<br /><br />
                    <span
                        class="inline-block w-6 h-6 rounded-full bg-emerald-100 text-emerald-700 text-center font-bold mr-2"
                        >3</span
                    >左部分木を再帰的に走査（中順走査の「左」）<br /><br />
                    <span
                        class="inline-block w-6 h-6 rounded-full bg-emerald-100 text-emerald-700 text-center font-bold mr-2"
                        >4</span
                    >違反チェック: prev.val &gt; node.val ならBST違反<br /><br />
                    <span
                        class="inline-block w-6 h-6 rounded-full bg-emerald-100 text-emerald-700 text-center font-bold mr-2"
                        >5</span
                    >最初の違反で first = prev を設定<br /><br />
                    <span
                        class="inline-block w-6 h-6 rounded-full bg-emerald-100 text-emerald-700 text-center font-bold mr-2"
                        >6</span
                    >常に second = node を更新（隣接/非隣接両対応）<br /><br />
                    <span
                        class="inline-block w-6 h-6 rounded-full bg-emerald-100 text-emerald-700 text-center font-bold mr-2"
                        >7</span
                    >prev を現在のノードに更新<br /><br />
                    <span
                        class="inline-block w-6 h-6 rounded-full bg-emerald-100 text-emerald-700 text-center font-bold mr-2"
                        >8</span
                    >右部分木を再帰的に走査（中順走査の「右」）<br /><br />
                    <span
                        class="inline-block w-6 h-6 rounded-full bg-emerald-100 text-emerald-700 text-center font-bold mr-2"
                        >9</span
                    >全走査完了後、first と second の値をスワップして修復完了
                </p>
            </section>

            <!-- Complexity -->
            <section id="complexity" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="text-[2rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    計算量分析
                </h2>

                <div class="overflow-x-auto bg-white rounded-lg border border-slate-200">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-emerald-50">
                                <th
                                    class="border border-slate-300 px-4 py-3 text-left text-slate-800"
                                >
                                    方式
                                </th>
                                <th
                                    class="border border-slate-300 px-4 py-3 text-left text-slate-800"
                                >
                                    時間計算量
                                </th>
                                <th
                                    class="border border-slate-300 px-4 py-3 text-left text-slate-800"
                                >
                                    空間計算量
                                </th>
                                <th
                                    class="border border-slate-300 px-4 py-3 text-left text-slate-800"
                                >
                                    特徴
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white">
                                <td
                                    class="border border-slate-300 px-4 py-3 font-semibold text-slate-800"
                                >
                                    再帰版
                                </td>
                                <td class="border border-slate-300 px-4 py-3 text-slate-700">
                                    O(n)
                                </td>
                                <td class="border border-slate-300 px-4 py-3 text-slate-700">
                                    O(h)
                                </td>
                                <td class="border border-slate-300 px-4 py-3 text-slate-700">
                                    最も可読性が高い
                                </td>
                            </tr>
                            <tr class="bg-slate-50">
                                <td
                                    class="border border-slate-300 px-4 py-3 font-semibold text-slate-800"
                                >
                                    Morris版
                                </td>
                                <td class="border border-slate-300 px-4 py-3 text-slate-700">
                                    O(n)
                                </td>
                                <td class="border border-slate-300 px-4 py-3 text-slate-700">
                                    O(1)
                                </td>
                                <td class="border border-slate-300 px-4 py-3 text-slate-700">
                                    Follow-up要件を満たす
                                </td>
                            </tr>
                            <tr class="bg-white">
                                <td
                                    class="border border-slate-300 px-4 py-3 font-semibold text-slate-800"
                                >
                                    配列保存版
                                </td>
                                <td class="border border-slate-300 px-4 py-3 text-slate-700">
                                    O(n)
                                </td>
                                <td class="border border-slate-300 px-4 py-3 text-slate-700">
                                    O(n)
                                </td>
                                <td class="border border-slate-300 px-4 py-3 text-slate-700">
                                    理解しやすい
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="text-xl font-semibold text-teal-800 mt-6 mb-3">詳細分析</h3>
                <ul class="list-disc list-inside text-slate-700 space-y-2">
                    <li>
                        <strong class="text-slate-800">時間 O(n)</strong>:
                        全ノードを1回走査（Morris版は最大2回）
                    </li>
                    <li>
                        <strong class="text-slate-800">空間 O(h)</strong>:
                        再帰コールスタックの深さ（hは木の高さ）
                    </li>
                    <li>
                        <strong class="text-slate-800">空間 O(1)</strong>:
                        Morris版はスレッディングで追加メモリ不要
                    </li>
                    <li>
                        <strong class="text-slate-800">スワップ</strong>:
                        最後に1回の値交換のみ（O(1)）
                    </li>
                </ul>
            </section>
        </div>

        <!-- Prism.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

        <!-- React Component -->
        <script type="text/babel">
            const { useState, useEffect, useRef } = React;

            const stepsData = [
                {
                    step: 1,
                    title: '入力BSTの確認',
                    desc: 'root = [3,1,4,null,null,2] を例とする。3と2が入れ替わっており、中順走査すると [1,3,2,4] となり、3>2 の違反がある。',
                    visual: {
                        type: 'init',
                        highlight: null,
                        first: null,
                        second: null,
                        prev: null,
                        current: null,
                    },
                },
                {
                    step: 2,
                    title: '左部分木の走査',
                    desc: '中順走査を開始。まず左端のノード1を訪問。prev=Noneなので違反チェックはスキップ。prev=1に更新。',
                    visual: {
                        type: 'traverse',
                        highlight: 1,
                        first: null,
                        second: null,
                        prev: null,
                        current: 1,
                    },
                },
                {
                    step: 3,
                    title: 'ルートノード訪問',
                    desc: 'ノード3を訪問。prev(1) < curr(3) なので違反なし。prev=3に更新。',
                    visual: {
                        type: 'traverse',
                        highlight: 3,
                        first: null,
                        second: null,
                        prev: 1,
                        current: 3,
                    },
                },
                {
                    step: 4,
                    title: '違反検出！',
                    desc: 'ノード2を訪問。prev(3) > curr(2) で違反発見！first=3（最初の違反の大きい方）、second=2（違反の小さい方）を設定。',
                    visual: {
                        type: 'violation',
                        highlight: 2,
                        first: 3,
                        second: 2,
                        prev: 3,
                        current: 2,
                    },
                },
                {
                    step: 5,
                    title: '走査継続',
                    desc: 'ノード4を訪問。prev(2) < curr(4) なので違反なし。secondは更新されない。',
                    visual: {
                        type: 'traverse',
                        highlight: 4,
                        first: 3,
                        second: 2,
                        prev: 2,
                        current: 4,
                    },
                },
                {
                    step: 6,
                    title: '走査完了',
                    desc: '全ノードの走査が完了。first=3, second=2 が特定された。中順列 [1,3,2,4] で違反は1箇所。',
                    visual: {
                        type: 'complete',
                        highlight: null,
                        first: 3,
                        second: 2,
                        prev: 4,
                        current: null,
                    },
                },
                {
                    step: 7,
                    title: '値のスワップ',
                    desc: 'first(3)とsecond(2)の値をスワップ。これでBSTが修復される。',
                    visual: {
                        type: 'swap',
                        highlight: null,
                        first: 3,
                        second: 2,
                        prev: null,
                        current: null,
                    },
                },
                {
                    step: 8,
                    title: '修復完了',
                    desc: '修復後の中順走査は [1,2,3,4] となり、正しい昇順列に。BST条件を満たす木が復元された。',
                    visual: {
                        type: 'result',
                        highlight: null,
                        first: null,
                        second: null,
                        prev: null,
                        current: null,
                    },
                },
            ];

            function StepVisualization({ visual }) {
                const nodePositions = {
                    3: { x: 300, y: 80 },
                    1: { x: 180, y: 170 },
                    4: { x: 420, y: 170 },
                    2: { x: 360, y: 260 },
                };

                const swappedPositions = {
                    2: { x: 300, y: 80 },
                    1: { x: 180, y: 170 },
                    4: { x: 420, y: 170 },
                    3: { x: 360, y: 260 },
                };

                const isResult = visual.type === 'result';
                const isSwap = visual.type === 'swap';
                const positions = isResult ? swappedPositions : nodePositions;
                const nodes = isResult ? [2, 1, 4, 3] : [3, 1, 4, 2];
                const rootVal = isResult ? 2 : 3;
                const rightChildVal = isResult ? 3 : 2;

                const getNodeColor = (val) => {
                    if (
                        visual.type === 'violation' &&
                        (val === visual.first || val === visual.second)
                    ) {
                        return { fill: '#fee2e2', stroke: '#dc2626', text: '#991b1b' };
                    }
                    if (visual.type === 'swap' && (val === visual.first || val === visual.second)) {
                        return { fill: '#fef3c7', stroke: '#f59e0b', text: '#92400e' };
                    }
                    if (val === visual.highlight) {
                        return { fill: '#dbeafe', stroke: '#2563eb', text: '#1e40af' };
                    }
                    if (val === visual.first) {
                        return { fill: '#fee2e2', stroke: '#dc2626', text: '#991b1b' };
                    }
                    if (val === visual.second) {
                        return { fill: '#fef3c7', stroke: '#f59e0b', text: '#92400e' };
                    }
                    return { fill: '#d1fae5', stroke: '#10b981', text: '#065f46' };
                };

                return (
                    <svg
                        viewBox="0 0 600 380"
                        style={{ maxWidth: '100%', height: 'auto', marginTop: '20px' }}
                    >
                        {/* 背景（ダークモード対応） */}
                        <rect x="0" y="0" width="600" height="380" fill="#ffffff" rx="12" />

                        <defs>
                            <marker
                                id="edgeArrow"
                                markerWidth="8"
                                markerHeight="8"
                                refX="6"
                                refY="3"
                                orient="auto"
                            >
                                <path d="M0,0 L0,6 L6,3 z" fill="#64748b" />
                            </marker>
                            <marker
                                id="swapArrow"
                                markerWidth="8"
                                markerHeight="8"
                                refX="6"
                                refY="3"
                                orient="auto"
                            >
                                <path d="M0,0 L0,6 L6,3 z" fill="#dc2626" />
                            </marker>
                        </defs>

                        {/* タイトル */}
                        <text
                            x="300"
                            y="30"
                            textAnchor="middle"
                            fontSize="16"
                            fontWeight="600"
                            fill="#0f172a"
                        >
                            {isResult ? '修復後のBST' : isSwap ? '値をスワップ中' : 'BST構造'}
                        </text>

                        {/* エッジ */}
                        <line
                            x1={positions[rootVal].x}
                            y1={positions[rootVal].y + 28}
                            x2={positions[1].x}
                            y2={positions[1].y - 28}
                            stroke="#475569"
                            strokeWidth="2"
                        />
                        <line
                            x1={positions[rootVal].x}
                            y1={positions[rootVal].y + 28}
                            x2={positions[4].x}
                            y2={positions[4].y - 28}
                            stroke="#475569"
                            strokeWidth="2"
                        />
                        <line
                            x1={positions[4].x}
                            y1={positions[4].y + 28}
                            x2={positions[rightChildVal].x}
                            y2={positions[rightChildVal].y - 28}
                            stroke="#475569"
                            strokeWidth="2"
                        />

                        {/* ノード */}
                        {nodes.map((val) => {
                            const pos = positions[val];
                            const colors = getNodeColor(val);
                            return (
                                <g key={val}>
                                    <circle
                                        cx={pos.x}
                                        cy={pos.y}
                                        r="28"
                                        fill={colors.fill}
                                        stroke={colors.stroke}
                                        strokeWidth="3"
                                    />
                                    <text
                                        x={pos.x}
                                        y={pos.y}
                                        textAnchor="middle"
                                        dominantBaseline="middle"
                                        fontSize="20"
                                        fontWeight="700"
                                        fill={colors.text}
                                    >
                                        {val}
                                    </text>
                                </g>
                            );
                        })}

                        {/* 中順走査の順序表示 */}
                        <rect x="100" y="310" width="400" height="30" fill="#f1f5f9" rx="6" />
                        <text
                            x="300"
                            y="325"
                            textAnchor="middle"
                            dominantBaseline="middle"
                            fontSize="15"
                            fontWeight="500"
                            fill="#334155"
                        >
                            中順走査: [{isResult ? '1, 2, 3, 4' : '1, 3, 2, 4'}]
                            {visual.type === 'violation' && ' ← 違反: 3 > 2'}
                            {isResult && ' ✓ 正しい昇順'}
                        </text>

                        {/* ポインタ表示 */}
                        {visual.prev !== null && !isSwap && !isResult && (
                            <g>
                                <rect
                                    x={nodePositions[visual.prev].x - 25}
                                    y={nodePositions[visual.prev].y - 60}
                                    width="50"
                                    height="22"
                                    fill="#f3e8ff"
                                    rx="4"
                                />
                                <text
                                    x={nodePositions[visual.prev].x}
                                    y={nodePositions[visual.prev].y - 49}
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="13"
                                    fontWeight="600"
                                    fill="#7c3aed"
                                >
                                    prev
                                </text>
                            </g>
                        )}
                        {visual.current !== null && (
                            <g>
                                <rect
                                    x={nodePositions[visual.current].x + 35}
                                    y={nodePositions[visual.current].y - 11}
                                    width="55"
                                    height="22"
                                    fill="#dbeafe"
                                    rx="4"
                                />
                                <text
                                    x={nodePositions[visual.current].x + 62}
                                    y={nodePositions[visual.current].y}
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="13"
                                    fontWeight="600"
                                    fill="#1d4ed8"
                                >
                                    ← curr
                                </text>
                            </g>
                        )}

                        {/* first/second表示 */}
                        {visual.first !== null && visual.type !== 'result' && (
                            <g>
                                <rect x="20" y="50" width="100" height="26" fill="#fee2e2" rx="4" />
                                <text
                                    x="70"
                                    y="63"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="13"
                                    fontWeight="600"
                                    fill="#b91c1c"
                                >
                                    first = {visual.first}
                                </text>
                            </g>
                        )}
                        {visual.second !== null && visual.type !== 'result' && (
                            <g>
                                <rect x="20" y="82" width="110" height="26" fill="#fef3c7" rx="4" />
                                <text
                                    x="75"
                                    y="95"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="13"
                                    fontWeight="600"
                                    fill="#b45309"
                                >
                                    second = {visual.second}
                                </text>
                            </g>
                        )}

                        {/* スワップ矢印 */}
                        {isSwap && (
                            <g>
                                <path
                                    d="M 270 70 C 250 30, 350 30, 370 250"
                                    stroke="#dc2626"
                                    strokeWidth="3"
                                    fill="none"
                                    markerEnd="url(#swapArrow)"
                                    strokeDasharray="8,4"
                                />
                                <path
                                    d="M 390 270 C 410 310, 310 310, 290 90"
                                    stroke="#dc2626"
                                    strokeWidth="3"
                                    fill="none"
                                    markerEnd="url(#swapArrow)"
                                    strokeDasharray="8,4"
                                />
                                <rect
                                    x="265"
                                    y="150"
                                    width="70"
                                    height="26"
                                    fill="#fee2e2"
                                    rx="6"
                                />
                                <text
                                    x="300"
                                    y="163"
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                    fontSize="14"
                                    fontWeight="700"
                                    fill="#b91c1c"
                                >
                                    SWAP!
                                </text>
                            </g>
                        )}
                    </svg>
                );
            }

            function StepsComponent() {
                const [activeStep, setActiveStep] = useState(1);
                const [isPlaying, setIsPlaying] = useState(false);
                const timerRef = useRef(null);

                useEffect(() => {
                    if (isPlaying) {
                        if (activeStep >= stepsData.length) {
                            setIsPlaying(false);
                            setActiveStep(1);
                            return;
                        }
                        timerRef.current = setTimeout(() => {
                            setActiveStep((prev) => prev + 1);
                        }, 1800);
                    }
                    return () => {
                        if (timerRef.current) clearTimeout(timerRef.current);
                    };
                }, [isPlaying, activeStep]);

                const handlePlay = () => {
                    if (isPlaying) return;
                    setActiveStep(1);
                    setIsPlaying(true);
                };

                const handlePrev = () => {
                    setIsPlaying(false);
                    setActiveStep((prev) => Math.max(1, prev - 1));
                };

                const handleNext = () => {
                    setIsPlaying(false);
                    setActiveStep((prev) => Math.min(stepsData.length, prev + 1));
                };

                const handleReset = () => {
                    setIsPlaying(false);
                    setActiveStep(1);
                };

                const handleStepClick = (step) => {
                    setIsPlaying(false);
                    setActiveStep(step);
                };

                const currentStepData = stepsData[activeStep - 1];

                return (
                    <div className="grid grid-cols-1 md:grid-cols-[1fr_2fr] gap-8 mt-2">
                        <div>
                            <h3 className="mt-0 mb-4 text-teal-800 text-xl font-semibold">
                                ステップ一覧
                            </h3>
                            <div className="space-y-2">
                                {stepsData.map((step) => {
                                    const isActive = activeStep === step.step;
                                    return (
                                        <button
                                            key={step.step}
                                            type="button"
                                            className={[
                                                'w-full text-left text-[0.95rem] rounded-xl border-2 transition cursor-pointer px-4 py-3',
                                                'bg-white border-slate-200 hover:border-emerald-500 hover:translate-x-1',
                                                isActive
                                                    ? 'bg-[linear-gradient(135deg,#d1fae5,#a7f3d0)] border-emerald-500 shadow-[0_4px_12px_rgba(16,185,129,0.20)]'
                                                    : '',
                                            ].join(' ')}
                                            onClick={() => handleStepClick(step.step)}
                                            aria-label={`ステップ${step.step}: ${step.title}`}
                                            aria-current={isActive ? 'step' : undefined}
                                        >
                                            <div
                                                className={[
                                                    'font-bold mb-1',
                                                    isActive ? 'text-emerald-900' : 'text-teal-800',
                                                ].join(' ')}
                                            >
                                                Step {step.step}: {step.title}
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="my-auto">
                            <div className="rounded-2xl p-6 border-2 border-emerald-200 bg-[linear-gradient(135deg,#ecfdf5,#f0f9ff)]">
                                <h3 className="mt-0 text-teal-800 text-xl font-semibold">
                                    Step {currentStepData.step}: {currentStepData.title}
                                </h3>
                                <p className="text-slate-600 leading-7 mt-2">
                                    {currentStepData.desc}
                                </p>
                            </div>

                            <StepVisualization visual={currentStepData.visual} />

                            <div className="flex flex-wrap justify-center gap-2 mt-4">
                                <button
                                    type="button"
                                    className="px-6 py-3 rounded-xl font-semibold text-white transition disabled:opacity-50 shadow hover:-translate-y-0.5 hover:shadow-[0_8px_16px_rgba(16,185,129,0.30)] bg-[linear-gradient(135deg,#10b981,#059669)]"
                                    onClick={handlePlay}
                                    disabled={isPlaying}
                                    aria-label="自動再生"
                                >
                                    ▶ Play
                                </button>
                                <button
                                    type="button"
                                    className="px-6 py-3 rounded-xl font-semibold text-white transition disabled:opacity-50 shadow hover:-translate-y-0.5 hover:shadow-[0_8px_16px_rgba(16,185,129,0.30)] bg-[linear-gradient(135deg,#0ea5e9,#0284c7)]"
                                    onClick={handlePrev}
                                    disabled={activeStep <= 1}
                                    aria-label="前のステップ"
                                >
                                    ◀ Prev
                                </button>
                                <button
                                    type="button"
                                    className="px-6 py-3 rounded-xl font-semibold text-white transition disabled:opacity-50 shadow hover:-translate-y-0.5 hover:shadow-[0_8px_16px_rgba(16,185,129,0.30)] bg-[linear-gradient(135deg,#0ea5e9,#0284c7)]"
                                    onClick={handleNext}
                                    disabled={activeStep >= stepsData.length}
                                    aria-label="次のステップ"
                                >
                                    Next ▶
                                </button>
                                <button
                                    type="button"
                                    className="px-6 py-3 rounded-xl font-semibold text-white transition shadow hover:-translate-y-0.5 hover:shadow-[0_8px_16px_rgba(16,185,129,0.30)] bg-[linear-gradient(135deg,#64748b,#475569)]"
                                    onClick={handleReset}
                                    aria-label="リセット"
                                >
                                    ↺ Reset
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('steps-root'));
            root.render(<StepsComponent />);
        </script>
    </body>
</html>
