<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LeetCode 98: Validate Binary Search Tree</title>

        <!-- Tailwind CSS -->
        <script src="/vendor/tailwindcss/script.js"></script>

        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
            rel="stylesheet"
        />

        <!-- Prism.js for Syntax Highlighting -->
        <link
            href="/vendor/prismjs/themes/prism.css"
            rel="stylesheet"
        />
        <link
            href="/vendor/prismjs/plugins/line-numbers/prism-line-numbers.css"
            rel="stylesheet"
        />
        <link
            href="/vendor/prismjs/plugins/toolbar/prism-toolbar.css"
            rel="stylesheet"
        />

        <style>
            html {
                scroll-behavior: smooth;
            }

            code[class*='language-'],
            pre[class*='language-'] {
                font-family: 'JetBrains Mono', 'Source Code Pro', monospace;
                font-size: 0.95rem;
            }

            div.code-toolbar > .toolbar {
                opacity: 1;
            }

            div.code-toolbar > .toolbar .toolbar-item > button,
            div.code-toolbar > .toolbar .toolbar-item > a {
                background: #fff;
                border: 1px solid #e6e8ef;
                border-radius: 10px;
                padding: 1rem 1.5rem;
                margin: 1rem 1rem 0 0;
                font:
                    600 13px/1.2 Inter,
                    system-ui,
                    sans-serif;
                color: #334155;
                box-shadow: 0 2px 6px rgba(20, 32, 70, 0.06);
                transition:
                    transform 0.15s,
                    box-shadow 0.15s,
                    background 0.15s;
            }

            div.code-toolbar > .toolbar .toolbar-item > button:hover {
                transform: translateY(-1px);
                box-shadow: 0 10px 28px rgba(20, 32, 70, 0.08);
                background: linear-gradient(180deg, #e8fff6, #c8f1e1);
            }
        </style>
    </head>
    <body
        class="min-h-screen p-8 sm:p-6 font-[Inter] text-slate-800 leading-relaxed bg-[linear-gradient(135deg,#f0fdf4_0%,#dbeafe_100%)]"
    >
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <header
                id="header"
                class="mb-8 rounded-2xl p-8 shadow-[0_10px_30px_rgba(16,185,129,0.10)] bg-[linear-gradient(135deg,#d1fae5,#bfdbfe)]"
            >
                <h1 class="text-[2.5rem] font-bold text-teal-800 mb-2">
                    Validate Binary Search Tree
                </h1>
                <p class="text-xl text-cyan-700 font-semibold mt-2">中順巡回反復による O(n) 実装</p>
                <nav class="flex flex-wrap gap-4 mt-6">
                    <a
                        href="#overview"
                        class="inline-block px-5 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_10px_20px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-700"
                    >
                        概要
                    </a>
                    <a
                        href="#steps"
                        class="inline-block px-5 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_10px_20px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-700"
                    >
                        ステップ解説
                    </a>
                    <a
                        href="#code"
                        class="inline-block px-5 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_10px_20px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-700"
                    >
                        コード
                    </a>
                    <a
                        href="#diagram"
                        class="inline-block px-5 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_10px_20px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-700"
                    >
                        フローチャート
                    </a>
                    <a
                        href="#complexity"
                        class="inline-block px-5 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_10px_20px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-700"
                    >
                        計算量
                    </a>
                </nav>
            </header>

            <!-- Overview Section -->
            <section id="overview" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="text-[2rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    アルゴリズム概要
                </h2>

                <h3 class="text-xl font-semibold text-teal-800 mt-6 mb-3">問題の説明</h3>
                <p class="mb-4 leading-7">
                    二分木の根ノードが与えられたとき、それが<strong
                        >有効なBST（Binary Search Tree）</strong
                    >であるかを判定します。
                </p>

                <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 mb-4">
                    <p class="font-semibold text-emerald-800">BST の定義：</p>
                    <ul class="list-disc list-inside mt-2 space-y-1 text-slate-700">
                        <li>
                            各ノードの<strong>左部分木</strong>には、そのノードより<strong>厳密に小さい値</strong>のノードのみが含まれる
                        </li>
                        <li>
                            各ノードの<strong>右部分木</strong>には、そのノードより<strong>厳密に大きい値</strong>のノードのみが含まれる
                        </li>
                        <li>左右の部分木もそれぞれBSTである</li>
                    </ul>
                </div>

                <h3 class="text-xl font-semibold text-teal-800 mt-6 mb-3">入出力例</h3>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <p class="font-semibold text-slate-700 mb-2">Example 1:</p>
                        <pre class="text-sm"><code>Input: root = [2,1,3]
    2
   / \
  1   3
Output: true</code></pre>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <p class="font-semibold text-slate-700 mb-2">Example 2:</p>
                        <pre class="text-sm"><code>Input: root = [5,1,4,null,null,3,6]
      5
     / \
    1   4
       / \
      3   6
Output: false (4は5より小さいべき)</code></pre>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-teal-800 mt-6 mb-3">制約条件</h3>
                <ul class="list-disc list-inside space-y-2 text-slate-700 mb-4">
                    <li>
                        ノード数: <code class="bg-slate-100 px-2 py-1 rounded">1 ≤ n ≤ 10^4</code>
                    </li>
                    <li>
                        ノード値:
                        <code class="bg-slate-100 px-2 py-1 rounded"
                            >-2^31 ≤ Node.val ≤ 2^31 - 1</code
                        >
                    </li>
                </ul>

                <h3 class="text-xl font-semibold text-teal-800 mt-6 mb-3">戦略</h3>
                <div class="bg-sky-50 border-l-4 border-sky-500 p-4">
                    <p class="font-semibold text-sky-800 mb-2">核心アイデア：</p>
                    <p class="text-slate-700 leading-7">
                        BSTの<strong>中順巡回（Inorder Traversal）</strong
                        >は<strong>厳密単調増加列</strong>を生成します（必要十分条件）。
                        スタックを使った反復的な巡回で全ノードを訪問し、<code
                            class="bg-slate-100 px-2 py-1 rounded"
                            >prev</code
                        >（直前の値）と比較して
                        <code class="bg-slate-100 px-2 py-1 rounded">node.val &gt; prev</code>
                        を確認します。
                    </p>
                </div>

                <h3 class="text-xl font-semibold text-teal-800 mt-6 mb-3">主要ポイント</h3>
                <ul class="list-disc list-inside space-y-2 text-slate-700">
                    <li><strong>時間計算量</strong>: O(n) - 全ノードを1回ずつ訪問</li>
                    <li>
                        <strong>空間計算量</strong>: O(h) -
                        スタックの深さは木の高さ（最悪O(n)、平衡木でO(log n)）
                    </li>
                    <li>
                        <strong>最適化</strong>: 全要素を配列に格納せず、<code
                            class="bg-slate-100 px-2 py-1 rounded"
                            >prev</code
                        >のみで比較
                    </li>
                    <li>
                        <strong>安全性</strong>:
                        再帰を使わないため、深い木でもスタックオーバーフローなし
                    </li>
                </ul>
            </section>

            <!-- Steps Section (React) -->
            <section id="steps" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="text-[2rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    ステップバイステップ解説
                </h2>
                <div id="react-root"></div>
            </section>

            <!-- Code Section -->
            <section id="code" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="text-[2rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    Python実装
                </h2>
                <pre
                    class="line-numbers"
                ><code class="language-python">from typing import Optional, List

class TreeNode:
    def __init__(self, val=0, left=None, right=None):
        self.val = val
        self.left = left
        self.right = right

class Solution:
    def isValidBST(self, root: Optional[TreeNode]) -> bool:
        """
        反復的な中順巡回でBSTを検証

        時間計算量: O(n)
        空間計算量: O(h) where h is tree height
        """
        stack: List[TreeNode] = []
        cur: Optional[TreeNode] = root
        prev: Optional[int] = None

        # ローカル束縛による最適化
        push = stack.append
        pop = stack.pop

        while cur is not None or stack:
            # 左部分木を全てスタックに積む
            while cur is not None:
                push(cur)
                cur = cur.left

            # 最左端のノードを取り出す
            node = pop()
            val = node.val

            # 厳密単調増加チェック
            if prev is not None and val <= prev:
                return False

            # prev を更新
            prev = val

            # 右部分木へ移動
            cur = node.right

        return True</code></pre>
            </section>

            <!-- Diagram Section -->
            <section id="diagram" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="text-[2rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    フローチャート
                </h2>
                <div class="mt-[20px] overflow-x-auto">
                    <svg
                        viewBox="0 0 900 1000"
                        style="max-width: 100%; height: auto; color: #333"
                        role="img"
                        aria-label="Validate BST flowchart"
                    >
                        <defs>
                            <marker
                                id="arrow"
                                markerWidth="10"
                                markerHeight="10"
                                refX="9"
                                refY="3"
                                orient="auto"
                                markerUnits="strokeWidth"
                            >
                                <path d="M0,0 L0,6 L9,3 z" fill="#64748b" />
                            </marker>
                            <marker
                                id="arrowGreen"
                                markerWidth="10"
                                markerHeight="10"
                                refX="9"
                                refY="3"
                                orient="auto"
                                markerUnits="strokeWidth"
                            >
                                <path d="M0,0 L0,6 L9,3 z" fill="#059669" />
                            </marker>
                            <marker
                                id="arrowRed"
                                markerWidth="10"
                                markerHeight="10"
                                refX="9"
                                refY="3"
                                orient="auto"
                                markerUnits="strokeWidth"
                            >
                                <path d="M0,0 L0,6 L9,3 z" fill="#dc2626" />
                            </marker>
                            <marker
                                id="arrowPurple"
                                markerWidth="10"
                                markerHeight="10"
                                refX="9"
                                refY="3"
                                orient="auto"
                                markerUnits="strokeWidth"
                            >
                                <path d="M0,0 L0,6 L9,3 z" fill="#a855f7" />
                            </marker>
                        </defs>

                        <!-- 開始 -->
                        <ellipse
                            cx="450"
                            cy="50"
                            rx="100"
                            ry="35"
                            fill="#d1fae5"
                            stroke="#10b981"
                            stroke-width="2"
                        />
                        <text
                            x="450"
                            y="50"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="18"
                            font-weight="600"
                        >
                            開始
                        </text>

                        <!-- 初期化 -->
                        <path
                            d="M 450 85 L 450 140"
                            stroke="#64748b"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrow)"
                        />
                        <rect
                            x="350"
                            y="140"
                            width="200"
                            height="60"
                            rx="8"
                            fill="#e0f2fe"
                            stroke="#0284c7"
                            stroke-width="2"
                        />
                        <text
                            x="450"
                            y="170"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="16"
                            font-weight="600"
                        >
                            <tspan x="450" dy="-8">初期化</tspan>
                            <tspan x="450" dy="18">stack=[], cur=root, prev=None</tspan>
                        </text>

                        <!-- ループチェック -->
                        <path
                            d="M 450 200 L 450 260"
                            stroke="#64748b"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrow)"
                        />
                        <path
                            d="M 450 260 L 550 310 L 450 360 L 350 310 Z"
                            fill="#fef3c7"
                            stroke="#f59e0b"
                            stroke-width="2"
                        />
                        <text
                            x="450"
                            y="310"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="16"
                            font-weight="600"
                        >
                            <tspan x="450" dy="-8">cur≠None or</tspan>
                            <tspan x="450" dy="18">stack≠空?</tspan>
                        </text>

                        <!-- いいえ → True返却 -->
                        <path
                            d="M 550 310 L 720 310 L 720 920"
                            stroke="#059669"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowGreen)"
                        />
                        <text
                            x="635"
                            y="305"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="600"
                            fill="#059669"
                        >
                            いいえ
                        </text>
                        <rect
                            x="620"
                            y="920"
                            width="200"
                            height="50"
                            rx="8"
                            fill="#d1fae5"
                            stroke="#10b981"
                            stroke-width="2"
                        />
                        <text
                            x="720"
                            y="945"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="16"
                            font-weight="600"
                            fill="#059669"
                        >
                            True を返却
                        </text>

                        <!-- はい → 左部分木探索 -->
                        <path
                            d="M 450 360 L 450 420"
                            stroke="#059669"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowGreen)"
                        />
                        <text
                            x="470"
                            y="390"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="600"
                            fill="#059669"
                        >
                            はい
                        </text>
                        <path
                            d="M 450 420 L 550 470 L 450 520 L 350 470 Z"
                            fill="#fef3c7"
                            stroke="#f59e0b"
                            stroke-width="2"
                        />
                        <text
                            x="450"
                            y="470"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="16"
                            font-weight="600"
                        >
                            cur≠None?
                        </text>

                        <!-- はい → スタックに積む -->
                        <path
                            d="M 550 470 L 720 470"
                            stroke="#059669"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowGreen)"
                        />
                        <text
                            x="635"
                            y="465"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="600"
                            fill="#059669"
                        >
                            はい
                        </text>
                        <rect
                            x="720"
                            y="440"
                            width="150"
                            height="60"
                            rx="8"
                            fill="#e0f2fe"
                            stroke="#0284c7"
                            stroke-width="2"
                        />
                        <text
                            x="795"
                            y="470"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="16"
                            font-weight="600"
                        >
                            <tspan x="795" dy="-8">push(cur)</tspan>
                            <tspan x="795" dy="18">cur = cur.left</tspan>
                        </text>

                        <!-- ループバック（左探索継続） -->
                        <path
                            d="M 795 440 L 795 380 L 200 380 L 200 310 L 350 310"
                            stroke="#a855f7"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowPurple)"
                        />
                        <text
                            x="250"
                            y="375"
                            text-anchor="start"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="600"
                            fill="#a855f7"
                        >
                            左探索ループ
                        </text>

                        <!-- いいえ → ノード取り出し -->
                        <path
                            d="M 450 520 L 450 600"
                            stroke="#dc2626"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowRed)"
                        />
                        <text
                            x="470"
                            y="560"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="600"
                            fill="#dc2626"
                        >
                            いいえ
                        </text>
                        <rect
                            x="350"
                            y="600"
                            width="200"
                            height="60"
                            rx="8"
                            fill="#e0f2fe"
                            stroke="#0284c7"
                            stroke-width="2"
                        />
                        <text
                            x="450"
                            y="630"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="16"
                            font-weight="600"
                        >
                            <tspan x="450" dy="-8">node = pop()</tspan>
                            <tspan x="450" dy="18">val = node.val</tspan>
                        </text>

                        <!-- 値チェック -->
                        <path
                            d="M 450 660 L 450 720"
                            stroke="#64748b"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrow)"
                        />
                        <path
                            d="M 450 720 L 550 770 L 450 820 L 350 770 Z"
                            fill="#fef3c7"
                            stroke="#f59e0b"
                            stroke-width="2"
                        />
                        <text
                            x="450"
                            y="770"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="16"
                            font-weight="600"
                        >
                            <tspan x="450" dy="-8">prev≠None and</tspan>
                            <tspan x="450" dy="18">val≤prev?</tspan>
                        </text>

                        <!-- はい → False返却 -->
                        <path
                            d="M 350 770 L 180 770 L 180 920"
                            stroke="#dc2626"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowRed)"
                        />
                        <text
                            x="265"
                            y="765"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="600"
                            fill="#dc2626"
                        >
                            はい
                        </text>
                        <rect
                            x="80"
                            y="920"
                            width="200"
                            height="50"
                            rx="8"
                            fill="#fee2e2"
                            stroke="#dc2626"
                            stroke-width="2"
                        />
                        <text
                            x="180"
                            y="945"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="16"
                            font-weight="600"
                            fill="#dc2626"
                        >
                            False を返却
                        </text>

                        <!-- いいえ → prev更新と右部分木へ -->
                        <path
                            d="M 450 820 L 450 880"
                            stroke="#059669"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowGreen)"
                        />
                        <text
                            x="470"
                            y="850"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="600"
                            fill="#059669"
                        >
                            いいえ
                        </text>
                        <rect
                            x="350"
                            y="880"
                            width="200"
                            height="60"
                            rx="8"
                            fill="#e0f2fe"
                            stroke="#0284c7"
                            stroke-width="2"
                        />
                        <text
                            x="450"
                            y="910"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="16"
                            font-weight="600"
                        >
                            <tspan x="450" dy="-8">prev = val</tspan>
                            <tspan x="450" dy="18">cur = node.right</tspan>
                        </text>

                        <!-- ループバック（メインループへ戻る） -->
                        <path
                            d="M 350 910 L 100 910 L 100 310 L 350 310"
                            stroke="#a855f7"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowPurple)"
                        />
                        <text
                            x="110"
                            y="610"
                            text-anchor="start"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="600"
                            fill="#a855f7"
                        >
                            次のノードへ
                        </text>
                    </svg>
                </div>

                <p class="mt-8 font-[Source_Code_Pro] text-[20px] font-semibold leading-relaxed">
                    <strong class="text-2xl">フローの説明：</strong><br />
                    1. スタック、cur、prevを初期化<br />
                    2.
                    <span class="text-emerald-600">緑の矢印（はい）</span
                    >：curがNoneでないかスタックに要素があればループ継続<br />
                    3.
                    <span class="text-emerald-600">左部分木探索</span
                    >：curがNoneでない限りスタックに積み、左へ移動<br />
                    4.
                    <span class="text-red-600">赤の矢印（いいえ）</span
                    >：最左端到達後、ノードを取り出す<br />
                    5. <span class="text-red-600">BST違反チェック</span>：val ≤ prev
                    なら即座にFalse返却<br />
                    6.
                    <span class="text-purple-600">紫の矢印（ループバック）</span
                    >：prevを更新後、右部分木へ移動してループ再開<br />
                    7. 全ノード通過で<span class="text-emerald-600">True</span>を返却
                </p>
            </section>

            <!-- Complexity Section -->
            <section id="complexity" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="text-[2rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    計算量分析
                </h2>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-emerald-100">
                                <th
                                    class="border border-emerald-300 px-4 py-3 text-left font-semibold"
                                >
                                    項目
                                </th>
                                <th
                                    class="border border-emerald-300 px-4 py-3 text-left font-semibold"
                                >
                                    計算量
                                </th>
                                <th
                                    class="border border-emerald-300 px-4 py-3 text-left font-semibold"
                                >
                                    説明
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white">
                                <td class="border border-slate-200 px-4 py-3 font-semibold">
                                    時間計算量
                                </td>
                                <td class="border border-slate-200 px-4 py-3">
                                    <code class="bg-emerald-50 px-2 py-1 rounded text-emerald-700"
                                        >O(n)</code
                                    >
                                </td>
                                <td class="border border-slate-200 px-4 py-3">
                                    全ノードを1回ずつ訪問。各ノードでの処理はO(1)
                                </td>
                            </tr>
                            <tr class="bg-slate-50">
                                <td class="border border-slate-200 px-4 py-3 font-semibold">
                                    空間計算量
                                </td>
                                <td class="border border-slate-200 px-4 py-3">
                                    <code class="bg-sky-50 px-2 py-1 rounded text-sky-700"
                                        >O(h)</code
                                    >
                                </td>
                                <td class="border border-slate-200 px-4 py-3">
                                    スタックの最大深さは木の高さh。最悪（一本道）でO(n)、平衡木でO(log
                                    n)
                                </td>
                            </tr>
                            <tr class="bg-white">
                                <td class="border border-slate-200 px-4 py-3 font-semibold">
                                    追加メモリ
                                </td>
                                <td class="border border-slate-200 px-4 py-3">
                                    <code class="bg-emerald-50 px-2 py-1 rounded text-emerald-700"
                                        >O(1)</code
                                    >
                                </td>
                                <td class="border border-slate-200 px-4 py-3">
                                    prev変数のみ（整数1つ）
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="text-xl font-semibold text-teal-800 mt-8 mb-4">代替手法との比較</h3>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-sky-100">
                                <th class="border border-sky-300 px-4 py-3 text-left font-semibold">
                                    手法
                                </th>
                                <th class="border border-sky-300 px-4 py-3 text-left font-semibold">
                                    時間
                                </th>
                                <th class="border border-sky-300 px-4 py-3 text-left font-semibold">
                                    空間
                                </th>
                                <th class="border border-sky-300 px-4 py-3 text-left font-semibold">
                                    備考
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-emerald-50">
                                <td class="border border-slate-200 px-4 py-3 font-semibold">
                                    本実装（Inorder反復）
                                </td>
                                <td class="border border-slate-200 px-4 py-3">O(n)</td>
                                <td class="border border-slate-200 px-4 py-3">O(h)</td>
                                <td class="border border-slate-200 px-4 py-3">
                                    <strong>✓ 最適</strong>。メモリ効率が高い
                                </td>
                            </tr>
                            <tr class="bg-white">
                                <td class="border border-slate-200 px-4 py-3">Inorder配列化</td>
                                <td class="border border-slate-200 px-4 py-3">O(n)</td>
                                <td class="border border-slate-200 px-4 py-3">O(n)</td>
                                <td class="border border-slate-200 px-4 py-3">
                                    全要素を配列に格納。無駄が多い
                                </td>
                            </tr>
                            <tr class="bg-white">
                                <td class="border border-slate-200 px-4 py-3">
                                    再帰DFS（範囲チェック）
                                </td>
                                <td class="border border-slate-200 px-4 py-3">O(n)</td>
                                <td class="border border-slate-200 px-4 py-3">O(h)</td>
                                <td class="border border-slate-200 px-4 py-3">
                                    Pythonでは深い木で再帰限界リスク
                                </td>
                            </tr>
                            <tr class="bg-white">
                                <td class="border border-slate-200 px-4 py-3">Morris Traversal</td>
                                <td class="border border-slate-200 px-4 py-3">O(n)</td>
                                <td class="border border-slate-200 px-4 py-3">O(1)</td>
                                <td class="border border-slate-200 px-4 py-3">
                                    木を一時改変。業務では避けがち
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="bg-sky-50 border-l-4 border-sky-500 p-4 mt-6">
                    <p class="font-semibold text-sky-800 mb-2">最適化のポイント：</p>
                    <ul class="list-disc list-inside space-y-1 text-slate-700">
                        <li>
                            全要素を配列に格納せず、<code class="bg-slate-100 px-2 py-1 rounded"
                                >prev</code
                            >のみで比較
                        </li>
                        <li>
                            ローカル変数束縛（<code class="bg-slate-100 px-2 py-1 rounded"
                                >push = stack.append</code
                            >）でCPython最適化
                        </li>
                        <li>違反検出時の早期リターンで無駄な探索を回避</li>
                        <li>再帰を使わないため、任意の深さに対応可能</li>
                    </ul>
                </div>
            </section>
        </div>

        <!-- React, ReactDOM, Babel -->
        <script crossorigin src="/vendor/react/react.development.js"></script>
        <script
            crossorigin
            src="/vendor/react-dom/react-dom.development.js"
        ></script>
        <script src="/vendor/babel/babel.min.js"></script>

        <!-- Prism.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

        <!-- React Component -->
        <script type="text/babel">
            const { useState, useEffect, useRef } = React;

            const stepsData = [
                {
                    step: 1,
                    title: '初期化',
                    desc: '木構造 [5,1,4,null,null,3,6] を例に、スタック、cur、prevを初期化します。',
                    visual: {
                        type: 'init',
                        tree: [5, 1, 4, null, null, 3, 6],
                        stackContent: [],
                        cur: 5,
                        prev: null,
                    },
                },
                {
                    step: 2,
                    title: '左部分木探索（5→1）',
                    desc: 'curが5のとき、スタックに5を積み、cur.left（1）へ移動します。',
                    visual: {
                        type: 'pushLeft',
                        tree: [5, 1, 4, null, null, 3, 6],
                        stackContent: [5],
                        cur: 1,
                        prev: null,
                        highlight: [5],
                    },
                },
                {
                    step: 3,
                    title: '左部分木探索（1→null）',
                    desc: 'curが1のとき、スタックに1を積み、cur.left（null）へ移動します。',
                    visual: {
                        type: 'pushLeft',
                        tree: [5, 1, 4, null, null, 3, 6],
                        stackContent: [5, 1],
                        cur: null,
                        prev: null,
                        highlight: [5, 1],
                    },
                },
                {
                    step: 4,
                    title: 'ノード1を取り出し',
                    desc: 'curがnullなのでスタックから1を取り出します。prev=null, val=1 → OK。prevを1に更新。',
                    visual: {
                        type: 'popAndCheck',
                        tree: [5, 1, 4, null, null, 3, 6],
                        stackContent: [5],
                        cur: null,
                        prev: null,
                        node: 1,
                        valid: true,
                        newPrev: 1,
                    },
                },
                {
                    step: 5,
                    title: '右部分木へ（1の右はnull）',
                    desc: '1の右子はnullなので、curはnullのままループ継続。',
                    visual: {
                        type: 'moveRight',
                        tree: [5, 1, 4, null, null, 3, 6],
                        stackContent: [5],
                        cur: null,
                        prev: 1,
                    },
                },
                {
                    step: 6,
                    title: 'ノード5を取り出し',
                    desc: 'スタックから5を取り出します。prev=1, val=5 → 5 > 1 OK。prevを5に更新。',
                    visual: {
                        type: 'popAndCheck',
                        tree: [5, 1, 4, null, null, 3, 6],
                        stackContent: [],
                        cur: null,
                        prev: 1,
                        node: 5,
                        valid: true,
                        newPrev: 5,
                    },
                },
                {
                    step: 7,
                    title: '右部分木へ（5→4）',
                    desc: '5の右子は4なので、curは4に移動します。',
                    visual: {
                        type: 'moveRight',
                        tree: [5, 1, 4, null, null, 3, 6],
                        stackContent: [],
                        cur: 4,
                        prev: 5,
                        highlight: [4],
                    },
                },
                {
                    step: 8,
                    title: '左部分木探索（4→3）',
                    desc: 'curが4のとき、スタックに4を積み、cur.left（3）へ移動します。',
                    visual: {
                        type: 'pushLeft',
                        tree: [5, 1, 4, null, null, 3, 6],
                        stackContent: [4],
                        cur: 3,
                        prev: 5,
                        highlight: [4, 3],
                    },
                },
                {
                    step: 9,
                    title: '左部分木探索（3→null）',
                    desc: 'curが3のとき、スタックに3を積み、cur.left（null）へ移動します。',
                    visual: {
                        type: 'pushLeft',
                        tree: [5, 1, 4, null, null, 3, 6],
                        stackContent: [4, 3],
                        cur: null,
                        prev: 5,
                        highlight: [4, 3],
                    },
                },
                {
                    step: 10,
                    title: 'ノード3を取り出し',
                    desc: 'スタックから3を取り出します。prev=5, val=3 → 3 ≤ 5 NG！ BST違反を検出。',
                    visual: {
                        type: 'popAndCheck',
                        tree: [5, 1, 4, null, null, 3, 6],
                        stackContent: [4],
                        cur: null,
                        prev: 5,
                        node: 3,
                        valid: false,
                        newPrev: null,
                    },
                },
                {
                    step: 11,
                    title: 'False返却',
                    desc: '厳密単調増加が破られたため、即座にFalseを返します。',
                    visual: {
                        type: 'result',
                        tree: [5, 1, 4, null, null, 3, 6],
                        result: false,
                        reason: '3 ≤ 5 (BST違反)',
                    },
                },
            ];

            function StepVisualization({ visual }) {
                if (visual.type === 'init') {
                    return (
                        <svg
                            viewBox="0 0 600 400"
                            style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            role="img"
                            aria-label="初期状態"
                        >
                            <defs>
                                <marker
                                    id="arrowPurple"
                                    markerWidth="10"
                                    markerHeight="10"
                                    refX="9"
                                    refY="3"
                                    orient="auto"
                                    markerUnits="strokeWidth"
                                >
                                    <path d="M0,0 L0,6 L9,3 z" fill="#a855f7" />
                                </marker>
                            </defs>

                            <text
                                x="300"
                                y="30"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                                fill="#0f766e"
                            >
                                初期状態
                            </text>

                            {/* Tree */}
                            <ellipse
                                cx="300"
                                cy="90"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="300"
                                y="90"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                5
                            </text>

                            <line
                                x1="285"
                                y1="110"
                                x2="220"
                                y2="145"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="200"
                                cy="160"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="200"
                                y="160"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                1
                            </text>

                            <line
                                x1="315"
                                y1="110"
                                x2="380"
                                y2="145"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="400"
                                cy="160"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="400"
                                y="160"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                4
                            </text>

                            <line
                                x1="385"
                                y1="180"
                                x2="340"
                                y2="215"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="320"
                                cy="230"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="320"
                                y="230"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                3
                            </text>

                            <line
                                x1="415"
                                y1="180"
                                x2="460"
                                y2="215"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="480"
                                cy="230"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="480"
                                y="230"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                6
                            </text>

                            {/* State */}
                            <rect
                                x="50"
                                y="290"
                                width="500"
                                height="80"
                                rx="8"
                                fill="#f1f5f9"
                                stroke="#64748b"
                                strokeWidth="2"
                            />
                            <text
                                x="70"
                                y="315"
                                textAnchor="start"
                                dominantBaseline="middle"
                                fontSize="16"
                                fontWeight="600"
                                fill="#475569"
                            >
                                スタック: [ ]
                            </text>
                            <text
                                x="70"
                                y="345"
                                textAnchor="start"
                                dominantBaseline="middle"
                                fontSize="16"
                                fontWeight="600"
                                fill="#a855f7"
                            >
                                cur: 5
                            </text>
                            <text
                                x="70"
                                y="360"
                                textAnchor="start"
                                dominantBaseline="middle"
                                fontSize="16"
                                fontWeight="600"
                                fill="#64748b"
                            >
                                prev: None
                            </text>
                        </svg>
                    );
                }

                if (visual.type === 'pushLeft') {
                    const highlightNodes = visual.highlight || [];
                    return (
                        <svg
                            viewBox="0 0 600 400"
                            style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            role="img"
                            aria-label="左部分木探索"
                        >
                            <defs>
                                <marker
                                    id="arrowPurple"
                                    markerWidth="10"
                                    markerHeight="10"
                                    refX="9"
                                    refY="3"
                                    orient="auto"
                                    markerUnits="strokeWidth"
                                >
                                    <path d="M0,0 L0,6 L9,3 z" fill="#a855f7" />
                                </marker>
                            </defs>

                            <text
                                x="300"
                                y="30"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                                fill="#0f766e"
                            >
                                左部分木探索
                            </text>

                            {/* Tree */}
                            <ellipse
                                cx="300"
                                cy="90"
                                rx="30"
                                ry="25"
                                fill={highlightNodes.includes(5) ? '#d1fae5' : '#e0f2fe'}
                                stroke={highlightNodes.includes(5) ? '#10b981' : '#0284c7'}
                                strokeWidth="2"
                            />
                            <text
                                x="300"
                                y="90"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                5
                            </text>

                            <line
                                x1="285"
                                y1="110"
                                x2="220"
                                y2="145"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="200"
                                cy="160"
                                rx="30"
                                ry="25"
                                fill={highlightNodes.includes(1) ? '#d1fae5' : '#e0f2fe'}
                                stroke={highlightNodes.includes(1) ? '#10b981' : '#0284c7'}
                                strokeWidth="2"
                            />
                            <text
                                x="200"
                                y="160"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                1
                            </text>

                            <line
                                x1="315"
                                y1="110"
                                x2="380"
                                y2="145"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="400"
                                cy="160"
                                rx="30"
                                ry="25"
                                fill={highlightNodes.includes(4) ? '#d1fae5' : '#e0f2fe'}
                                stroke={highlightNodes.includes(4) ? '#10b981' : '#0284c7'}
                                strokeWidth="2"
                            />
                            <text
                                x="400"
                                y="160"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                4
                            </text>

                            <line
                                x1="385"
                                y1="180"
                                x2="340"
                                y2="215"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="320"
                                cy="230"
                                rx="30"
                                ry="25"
                                fill={highlightNodes.includes(3) ? '#d1fae5' : '#e0f2fe'}
                                stroke={highlightNodes.includes(3) ? '#10b981' : '#0284c7'}
                                strokeWidth="2"
                            />
                            <text
                                x="320"
                                y="230"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                3
                            </text>

                            <line
                                x1="415"
                                y1="180"
                                x2="460"
                                y2="215"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="480"
                                cy="230"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="480"
                                y="230"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                6
                            </text>

                            {/* State */}
                            <rect
                                x="50"
                                y="290"
                                width="500"
                                height="80"
                                rx="8"
                                fill="#f1f5f9"
                                stroke="#64748b"
                                strokeWidth="2"
                            />
                            <text
                                x="70"
                                y="315"
                                textAnchor="start"
                                dominantBaseline="middle"
                                fontSize="16"
                                fontWeight="600"
                                fill="#475569"
                            >
                                スタック: [ {visual.stackContent.join(', ')} ]
                            </text>
                            <text
                                x="70"
                                y="345"
                                textAnchor="start"
                                dominantBaseline="middle"
                                fontSize="16"
                                fontWeight="600"
                                fill="#a855f7"
                            >
                                cur: {visual.cur === null ? 'null' : visual.cur}
                            </text>
                            <text
                                x="70"
                                y="360"
                                textAnchor="start"
                                dominantBaseline="middle"
                                fontSize="16"
                                fontWeight="600"
                                fill="#64748b"
                            >
                                prev: {visual.prev === null ? 'None' : visual.prev}
                            </text>
                        </svg>
                    );
                }

                if (visual.type === 'popAndCheck') {
                    return (
                        <svg
                            viewBox="0 0 600 450"
                            style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            role="img"
                            aria-label="ノード取り出しと検証"
                        >
                            <defs>
                                <marker
                                    id="arrowGreen"
                                    markerWidth="10"
                                    markerHeight="10"
                                    refX="9"
                                    refY="3"
                                    orient="auto"
                                    markerUnits="strokeWidth"
                                >
                                    <path d="M0,0 L0,6 L9,3 z" fill="#059669" />
                                </marker>
                                <marker
                                    id="arrowRed"
                                    markerWidth="10"
                                    markerHeight="10"
                                    refX="9"
                                    refY="3"
                                    orient="auto"
                                    markerUnits="strokeWidth"
                                >
                                    <path d="M0,0 L0,6 L9,3 z" fill="#dc2626" />
                                </marker>
                            </defs>

                            <text
                                x="300"
                                y="30"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                                fill="#0f766e"
                            >
                                ノード取り出しと検証
                            </text>

                            {/* Tree */}
                            <ellipse
                                cx="300"
                                cy="90"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="300"
                                y="90"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                5
                            </text>

                            <line
                                x1="285"
                                y1="110"
                                x2="220"
                                y2="145"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="200"
                                cy="160"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="200"
                                y="160"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                1
                            </text>

                            <line
                                x1="315"
                                y1="110"
                                x2="380"
                                y2="145"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="400"
                                cy="160"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="400"
                                y="160"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                4
                            </text>

                            <line
                                x1="385"
                                y1="180"
                                x2="340"
                                y2="215"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="320"
                                cy="230"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="320"
                                y="230"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                3
                            </text>

                            <line
                                x1="415"
                                y1="180"
                                x2="460"
                                y2="215"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="480"
                                cy="230"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="480"
                                y="230"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                6
                            </text>

                            {/* Current Node */}
                            <ellipse
                                cx="300"
                                cy="290"
                                rx="35"
                                ry="30"
                                fill={visual.valid ? '#d1fae5' : '#fee2e2'}
                                stroke={visual.valid ? '#10b981' : '#dc2626'}
                                strokeWidth="3"
                            />
                            <text
                                x="300"
                                y="290"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="20"
                                fontWeight="700"
                            >
                                {visual.node}
                            </text>

                            {/* Check */}
                            <rect
                                x="50"
                                y="340"
                                width="500"
                                height="90"
                                rx="8"
                                fill="#f1f5f9"
                                stroke="#64748b"
                                strokeWidth="2"
                            />
                            <text
                                x="70"
                                y="365"
                                textAnchor="start"
                                dominantBaseline="middle"
                                fontSize="16"
                                fontWeight="600"
                                fill="#475569"
                            >
                                スタック: [ {visual.stackContent.join(', ')} ]
                            </text>
                            <text
                                x="70"
                                y="390"
                                textAnchor="start"
                                dominantBaseline="middle"
                                fontSize="16"
                                fontWeight="600"
                                fill="#475569"
                            >
                                prev={visual.prev === null ? 'None' : visual.prev}, val=
                                {visual.node}
                            </text>
                            <text
                                x="70"
                                y="415"
                                textAnchor="start"
                                dominantBaseline="middle"
                                fontSize="16"
                                fontWeight="700"
                                fill={visual.valid ? '#059669' : '#dc2626'}
                            >
                                {visual.valid
                                    ? `✓ ${visual.node} > ${visual.prev} OK → prev=${visual.newPrev}`
                                    : `✗ ${visual.node} ≤ ${visual.prev} NG (BST違反)`}
                            </text>
                        </svg>
                    );
                }

                if (visual.type === 'moveRight') {
                    const highlightNodes = visual.highlight || [];
                    return (
                        <svg
                            viewBox="0 0 600 400"
                            style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            role="img"
                            aria-label="右部分木へ移動"
                        >
                            <defs>
                                <marker
                                    id="arrowPurple"
                                    markerWidth="10"
                                    markerHeight="10"
                                    refX="9"
                                    refY="3"
                                    orient="auto"
                                    markerUnits="strokeWidth"
                                >
                                    <path d="M0,0 L0,6 L9,3 z" fill="#a855f7" />
                                </marker>
                            </defs>

                            <text
                                x="300"
                                y="30"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                                fill="#0f766e"
                            >
                                右部分木へ移動
                            </text>

                            {/* Tree */}
                            <ellipse
                                cx="300"
                                cy="90"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="300"
                                y="90"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                5
                            </text>

                            <line
                                x1="285"
                                y1="110"
                                x2="220"
                                y2="145"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="200"
                                cy="160"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="200"
                                y="160"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                1
                            </text>

                            <line
                                x1="315"
                                y1="110"
                                x2="380"
                                y2="145"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="400"
                                cy="160"
                                rx="30"
                                ry="25"
                                fill={highlightNodes.includes(4) ? '#d1fae5' : '#e0f2fe'}
                                stroke={highlightNodes.includes(4) ? '#10b981' : '#0284c7'}
                                strokeWidth="2"
                            />
                            <text
                                x="400"
                                y="160"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                4
                            </text>

                            <line
                                x1="385"
                                y1="180"
                                x2="340"
                                y2="215"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="320"
                                cy="230"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="320"
                                y="230"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                3
                            </text>

                            <line
                                x1="415"
                                y1="180"
                                x2="460"
                                y2="215"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="480"
                                cy="230"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="480"
                                y="230"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                6
                            </text>

                            {/* State */}
                            <rect
                                x="50"
                                y="290"
                                width="500"
                                height="80"
                                rx="8"
                                fill="#f1f5f9"
                                stroke="#64748b"
                                strokeWidth="2"
                            />
                            <text
                                x="70"
                                y="315"
                                textAnchor="start"
                                dominantBaseline="middle"
                                fontSize="16"
                                fontWeight="600"
                                fill="#475569"
                            >
                                スタック: [ {visual.stackContent.join(', ')} ]
                            </text>
                            <text
                                x="70"
                                y="345"
                                textAnchor="start"
                                dominantBaseline="middle"
                                fontSize="16"
                                fontWeight="600"
                                fill="#a855f7"
                            >
                                cur: {visual.cur === null ? 'null' : visual.cur}
                            </text>
                            <text
                                x="70"
                                y="360"
                                textAnchor="start"
                                dominantBaseline="middle"
                                fontSize="16"
                                fontWeight="600"
                                fill="#64748b"
                            >
                                prev: {visual.prev}
                            </text>
                        </svg>
                    );
                }

                if (visual.type === 'result') {
                    return (
                        <svg
                            viewBox="0 0 600 350"
                            style={{ marginTop: '20px', maxWidth: '100%', height: 'auto' }}
                            role="img"
                            aria-label="結果"
                        >
                            <text
                                x="300"
                                y="40"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="22"
                                fontWeight="700"
                                fill={visual.result ? '#059669' : '#dc2626'}
                            >
                                結果: {visual.result ? 'True' : 'False'}
                            </text>

                            {/* Tree */}
                            <ellipse
                                cx="300"
                                cy="120"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="300"
                                y="120"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                5
                            </text>

                            <line
                                x1="285"
                                y1="140"
                                x2="220"
                                y2="175"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="200"
                                cy="190"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="200"
                                y="190"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                1
                            </text>

                            <line
                                x1="315"
                                y1="140"
                                x2="380"
                                y2="175"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="400"
                                cy="190"
                                rx="30"
                                ry="25"
                                fill="#fee2e2"
                                stroke="#dc2626"
                                strokeWidth="3"
                            />
                            <text
                                x="400"
                                y="190"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                4
                            </text>

                            <line
                                x1="385"
                                y1="210"
                                x2="340"
                                y2="245"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="320"
                                cy="260"
                                rx="30"
                                ry="25"
                                fill="#fee2e2"
                                stroke="#dc2626"
                                strokeWidth="3"
                            />
                            <text
                                x="320"
                                y="260"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                3
                            </text>

                            <line
                                x1="415"
                                y1="210"
                                x2="460"
                                y2="245"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                            />
                            <ellipse
                                cx="480"
                                cy="260"
                                rx="30"
                                ry="25"
                                fill="#e0f2fe"
                                stroke="#0284c7"
                                strokeWidth="2"
                            />
                            <text
                                x="480"
                                y="260"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="18"
                                fontWeight="600"
                            >
                                6
                            </text>

                            <rect
                                x="50"
                                y="300"
                                width="500"
                                height="40"
                                rx="8"
                                fill={visual.result ? '#d1fae5' : '#fee2e2'}
                                stroke={visual.result ? '#10b981' : '#dc2626'}
                                strokeWidth="2"
                            />
                            <text
                                x="300"
                                y="320"
                                textAnchor="middle"
                                dominantBaseline="middle"
                                fontSize="16"
                                fontWeight="600"
                                fill={visual.result ? '#059669' : '#dc2626'}
                            >
                                {visual.reason}
                            </text>
                        </svg>
                    );
                }

                return null;
            }

            function InteractiveSteps() {
                const [activeStep, setActiveStep] = useState(1);
                const [isPlaying, setIsPlaying] = useState(false);
                const timerRef = useRef(null);

                useEffect(() => {
                    if (isPlaying) {
                        if (activeStep >= stepsData.length) {
                            setIsPlaying(false);
                            setActiveStep(1);
                            return;
                        }
                        timerRef.current = setTimeout(() => {
                            setActiveStep((prev) => prev + 1);
                        }, 2000);
                    }
                    return () => {
                        if (timerRef.current) clearTimeout(timerRef.current);
                    };
                }, [isPlaying, activeStep]);

                const handlePlay = () => {
                    if (isPlaying) return;
                    setIsPlaying(true);
                    if (activeStep >= stepsData.length) {
                        setActiveStep(1);
                    }
                };

                const handlePrev = () => {
                    setIsPlaying(false);
                    if (activeStep > 1) {
                        setActiveStep((prev) => prev - 1);
                    }
                };

                const handleNext = () => {
                    setIsPlaying(false);
                    if (activeStep < stepsData.length) {
                        setActiveStep((prev) => prev + 1);
                    }
                };

                const handleReset = () => {
                    setIsPlaying(false);
                    setActiveStep(1);
                };

                const handleStepClick = (step) => {
                    setIsPlaying(false);
                    setActiveStep(step);
                };

                const currentStepData =
                    stepsData.find((s) => s.step === activeStep) || stepsData[0];

                return (
                    <div className="grid grid-cols-1 md:grid-cols-[1fr_2fr] gap-8 mt-2">
                        <div>
                            <h3 className="mt-0 mb-4 text-teal-800 text-xl font-semibold">
                                ステップ一覧
                            </h3>
                            <div className="space-y-2">
                                {stepsData.map((step) => {
                                    const isActive = activeStep === step.step;
                                    return (
                                        <button
                                            key={step.step}
                                            type="button"
                                            className={[
                                                'w-full text-left text-[0.95rem] rounded-xl border-2 transition cursor-pointer px-4 py-4',
                                                'bg-white border-slate-200 hover:border-emerald-500 hover:translate-x-1',
                                                isActive
                                                    ? 'bg-[linear-gradient(135deg,#d1fae5,#a7f3d0)] border-emerald-500 shadow-[0_4px_12px_rgba(16,185,129,0.20)]'
                                                    : '',
                                            ].join(' ')}
                                            onClick={() => handleStepClick(step.step)}
                                            aria-label={`ステップ${step.step}: ${step.title}`}
                                            aria-current={isActive ? 'step' : undefined}
                                        >
                                            <div
                                                className={[
                                                    'font-bold mb-1',
                                                    isActive ? 'text-emerald-900' : 'text-teal-800',
                                                ].join(' ')}
                                            >
                                                Step {step.step}: {step.title}
                                            </div>
                                            <div className="text-slate-500 text-sm mt-1">
                                                {step.desc.substring(0, 50)}
                                                {step.desc.length > 50 ? '...' : ''}
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="my-auto">
                            <div className="rounded-2xl p-8 mt-10 border-2 border-emerald-200 bg-[linear-gradient(135deg,#ecfdf5,#f0f9ff)]">
                                <h3 className="mt-0 text-teal-800 text-xl font-semibold">
                                    Step {currentStepData.step}: {currentStepData.title}
                                </h3>
                                <p className="text-slate-600 leading-7">{currentStepData.desc}</p>
                            </div>

                            <StepVisualization visual={currentStepData.visual} />

                            <div className="flex flex-wrap justify-center gap-2 mt-1">
                                <button
                                    type="button"
                                    className="px-6 py-3 rounded-xl font-semibold text-white transition disabled:opacity-50 shadow hover:-translate-y-0.5 hover:shadow-[0_8px_16px_rgba(16,185,129,0.30)] bg-[linear-gradient(135deg,#10b981,#059669)]"
                                    onClick={handlePlay}
                                    disabled={isPlaying}
                                    aria-label="自動再生"
                                >
                                    ▶ Play
                                </button>
                                <button
                                    type="button"
                                    className="px-6 py-3 rounded-xl font-semibold text-white transition disabled:opacity-50 shadow hover:-translate-y-0.5 hover:shadow-[0_8px_16px_rgba(16,185,129,0.30)] bg-[linear-gradient(135deg,#0ea5e9,#0284c7)]"
                                    onClick={handlePrev}
                                    disabled={activeStep <= 1}
                                    aria-label="前のステップ"
                                >
                                    ◀ Prev
                                </button>
                                <button
                                    type="button"
                                    className="px-6 py-3 rounded-xl font-semibold text-white transition disabled:opacity-50 shadow hover:-translate-y-0.5 hover:shadow-[0_8px_16px_rgba(16,185,129,0.30)] bg-[linear-gradient(135deg,#0ea5e9,#0284c7)]"
                                    onClick={handleNext}
                                    disabled={activeStep >= stepsData.length}
                                    aria-label="次のステップ"
                                >
                                    Next ▶
                                </button>
                                <button
                                    type="button"
                                    className="px-6 py-3 rounded-xl font-semibold text-white transition shadow hover:-translate-y-0.5 hover:shadow-[0_8px_16px_rgba(16,185,129,0.30)] bg-[linear-gradient(135deg,#64748b,#475569)]"
                                    onClick={handleReset}
                                    aria-label="リセット"
                                >
                                    ↺ Reset
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('react-root'));
            root.render(<InteractiveSteps />);
        </script>
    </body>
</html>
