<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Unique BSTs II - 分割統治＋区間メモ化</title>

        <!-- React + ReactDOM + Babel -->
        <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
        ></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Prism.js -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css"
        />

        <!-- Google Fonts -->
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap"
            rel="stylesheet"
        />

        <style>
            :root {
                --code-lh: 1.6;
                --primary: #10b981;
                --primary-light: #d1fae5;
                --secondary: #0ea5e9;
                --secondary-light: #e0f2fe;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    'Inter',
                    system-ui,
                    -apple-system,
                    sans-serif;
                line-height: 1.6;
                color: #1e293b;
            }

            /* Code Styles */
            pre[class*='language-'],
            pre[class*='language-'] > code {
                line-height: var(--code-lh) !important;
                white-space: pre !important;
                word-break: normal !important;
                overflow-wrap: normal !important;
                font-family:
                    'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                    monospace;
                font-size: 14px;
            }

            pre.line-numbers {
                padding-left: 3.2em !important;
                border-radius: 12px;
                background: #1e293b !important;
            }

            .line-numbers .line-numbers-rows {
                width: 3.2em;
                border-right: 1px solid #475569;
            }

            .line-numbers .line-numbers-rows > span {
                height: calc(var(--code-lh) * 1em);
            }

            /* Prism Toolbar */
            div.code-toolbar > .toolbar {
                opacity: 1;
            }

            div.code-toolbar > .toolbar .toolbar-item > button,
            div.code-toolbar > .toolbar .toolbar-item > a {
                background: #fff;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 6px 12px;
                font:
                    600 13px/1.2 Inter,
                    system-ui,
                    sans-serif;
                color: #334155;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                transition: all 0.2s;
            }

            div.code-toolbar > .toolbar .toolbar-item > button:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
                background: linear-gradient(180deg, #f0fdf4, #dcfce7);
            }

            /* Smooth Scroll */
            html {
                scroll-behavior: smooth;
            }

            /* Navigation Active State */
            .nav-link {
                transition: all 0.2s;
            }

            .nav-link:hover {
                color: var(--primary);
                transform: translateY(-1px);
            }

            /* Card Hover Effects */
            .card-hover {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .card-hover:hover {
                transform: translateY(-4px);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
            }

            /* Step Button Styles */
            .step-btn {
                transition: all 0.2s;
                position: relative;
            }

            .step-btn.active {
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            }

            .step-btn.active::before {
                content: '';
                position: absolute;
                inset: -2px;
                border-radius: inherit;
                background: linear-gradient(135deg, #10b981, #059669);
                z-index: -1;
                opacity: 0.3;
                filter: blur(8px);
            }

            /* Control Button Styles */
            .control-btn {
                transition: all 0.2s;
            }

            .control-btn:not(:disabled):hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 16px rgba(16, 185, 129, 0.2);
            }

            .control-btn:disabled {
                opacity: 0.4;
                cursor: not-allowed;
            }

            /* SVG Animation */
            .svg-fade-in {
                animation: fadeIn 0.4s ease-in-out;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Responsive */
            @media (max-width: 768px) {
                .two-col-layout {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body class="bg-gradient-to-br from-emerald-50 via-white to-sky-50">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-100">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <h1
                    class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-emerald-600 to-sky-600 bg-clip-text text-transparent mb-2"
                >
                    Unique Binary Search Trees II
                </h1>
                <p class="text-gray-600 text-sm sm:text-base">
                    全BST列挙 - 分割統治＋区間メモ化でカタラン数を効率的に生成
                </p>
            </div>

            <!-- Navigation -->
            <nav class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pb-4">
                <div class="flex flex-wrap gap-3 sm:gap-4 text-sm sm:text-base">
                    <a
                        href="#overview"
                        class="nav-link font-semibold text-gray-700 hover:text-emerald-600"
                        >概要</a
                    >
                    <span class="text-gray-300">•</span>
                    <a
                        href="#steps"
                        class="nav-link font-semibold text-gray-700 hover:text-emerald-600"
                        >ステップ</a
                    >
                    <span class="text-gray-300">•</span>
                    <a
                        href="#code"
                        class="nav-link font-semibold text-gray-700 hover:text-emerald-600"
                        >コード</a
                    >
                    <span class="text-gray-300">•</span>
                    <a
                        href="#diagram"
                        class="nav-link font-semibold text-gray-700 hover:text-emerald-600"
                        >図解</a
                    >
                    <span class="text-gray-300">•</span>
                    <a
                        href="#complexity"
                        class="nav-link font-semibold text-gray-700 hover:text-emerald-600"
                        >計算量</a
                    >
                </div>
            </nav>
        </header>

        <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">
            <!-- Overview Section -->
            <section id="overview" class="bg-white rounded-xl shadow-md p-6 sm:p-8 card-hover">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span
                        class="w-2 h-8 bg-gradient-to-b from-emerald-500 to-emerald-600 rounded"
                    ></span>
                    概要
                </h2>
                <div class="prose prose-slate max-w-none">
                    <p class="text-gray-700 leading-relaxed mb-4">
                        整数
                        <code class="px-2 py-1 bg-gray-100 rounded text-sm">n</code>
                        に対し、値
                        <code class="px-2 py-1 bg-gray-100 rounded text-sm">1..n</code>
                        を持つノードで構成される<strong>構造的に一意な BST（二分探索木）</strong
                        >をすべて生成します。
                    </p>
                    <ul class="space-y-2 text-gray-700">
                        <li>各木は BST の性質を満たす（左部分木 &lt; 根 &lt; 右部分木）</li>
                        <li>同型でない木はすべて列挙する（順序は任意）</li>
                        <li>
                            <code class="px-2 py-1 bg-gray-100 rounded text-sm">1 ≤ n ≤ 8</code>
                            の制約
                        </li>
                        <li>
                            <code class="px-2 py-1 bg-gray-100 rounded text-sm">n=8</code>
                            でも生成本数は<strong>カタラン数 C₈ = 1430</strong>と小規模
                        </li>
                    </ul>

                    <div class="mt-6 p-4 bg-emerald-50 border-l-4 border-emerald-500 rounded">
                        <p class="font-semibold text-emerald-800 mb-2">🎯 戦略</p>
                        <p class="text-gray-700">
                            <strong>分割統治</strong>（根を全列挙 →
                            左右部分木の直積で合成）＋<strong>区間メモ化</strong>により、重複計算を排除して出力サイズに近い計算量を実現します。
                        </p>
                    </div>
                </div>
            </section>

            <!-- Interactive Steps Section -->
            <section id="steps" class="bg-white rounded-xl shadow-md p-6 sm:p-8 card-hover">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="w-2 h-8 bg-gradient-to-b from-sky-500 to-sky-600 rounded"></span>
                    ステップバイステップ解説
                </h2>
                <div id="interactive-demo"></div>
            </section>

            <!-- Code Section -->
            <section id="code" class="bg-white rounded-xl shadow-md p-6 sm:p-8 card-hover">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span
                        class="w-2 h-8 bg-gradient-to-b from-emerald-500 to-emerald-600 rounded"
                    ></span>
                    Python実装（LeetCode形式）
                </h2>
                <div class="code-toolbar">
                    <pre
                        class="line-numbers"
                    ><code class="language-python">from __future__ import annotations

from typing import Dict, List, Optional, Tuple, TYPE_CHECKING

if TYPE_CHECKING:
    class TreeNode:
        val: int
        left: Optional[TreeNode]
        right: Optional[TreeNode]
        def __init__(self, val: int = 0,
                     left: Optional[TreeNode] = None,
                     right: Optional[TreeNode] = None) -> None: ...
else:
    try:
        TreeNode  # type: ignore
    except NameError:
        class TreeNode:
            """Binary Tree Node with __slots__ for memory efficiency."""
            __slots__ = ("val", "left", "right")

            def __init__(self, val: int = 0,
                         left: Optional[TreeNode] = None,
                         right: Optional[TreeNode] = None) -> None:
                self.val = val
                self.left = left
                self.right = right


class Solution:
    """
    Unique Binary Search Trees II
    1..n の値で構造的に一意な BST をすべて生成。

    Time:  ≈ O(C_n * n)  where C_n is n-th Catalan number
    Space: ≈ O(C_n * n)  (output + interval memoization)
    """

    def generateTrees(self, n: int) -> List[Optional[TreeNode]]:
        """
        Args:
            n: 1 <= n <= 8

        Returns:
            List of root nodes (each representing one unique BST)
        """
        if n == 0:
            return []

        # 区間 [l, r] -> 生成可能な根ノード配列
        memo: Dict[Tuple[int, int], List[Optional[TreeNode]]] = {}

        def build(l: int, r: int) -> List[Optional[TreeNode]]:
            """
            区間 [l, r] 内の値で構築可能な BST をすべて生成。
            空区間は [None]（空木1通り）で表す。
            """
            # 基底: 空区間 → 空木
            if l > r:
                return [None]

            # メモ化チェック
            key = (l, r)
            if key in memo:
                return memo[key]

            result: List[Optional[TreeNode]] = []

            # 各値を根候補として列挙
            for root_val in range(l, r + 1):
                # 左部分木: [l, root_val - 1]
                left_trees = build(l, root_val - 1)
                # 右部分木: [root_val + 1, r]
                right_trees = build(root_val + 1, r)

                # 直積で全組合せを合成
                for lt in left_trees:
                    for rt in right_trees:
                        # 新規ノード作成（部分木は参照共有）
                        node = TreeNode(root_val, lt, rt)
                        result.append(node)

            # メモに保存して返却
            memo[key] = result
            return result

        return build(1, n)</code></pre>
                </div>
            </section>

            <!-- Diagram Section -->
            <section id="diagram" class="bg-white rounded-xl shadow-md p-6 sm:p-8 card-hover">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="w-2 h-8 bg-gradient-to-b from-sky-500 to-sky-600 rounded"></span>
                    視覚的図解
                </h2>

                <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">分割統治フローチャート</h3>
                    <svg
                        viewBox="0 0 800 600"
                        class="w-full h-auto"
                        xmlns="http://www.w3.org/2000/svg"
                    >
                        <!-- Start -->
                        <rect
                            x="310"
                            y="20"
                            width="180"
                            height="50"
                            rx="8"
                            fill="#10b981"
                            stroke="#059669"
                            stroke-width="2"
                        />
                        <text
                            x="400"
                            y="50"
                            text-anchor="middle"
                            fill="white"
                            font-size="15"
                            font-weight="600"
                        >
                            開始 build(l, r)
                        </text>

                        <!-- Arrow -->
                        <path
                            d="M 400 70 L 400 100"
                            stroke="#64748b"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowhead)"
                        />

                        <!-- Empty Check -->
                        <path
                            d="M 400 100 L 480 140 L 400 180 L 320 140 Z"
                            fill="#e0f2fe"
                            stroke="#0ea5e9"
                            stroke-width="2"
                        />
                        <text
                            x="400"
                            y="145"
                            text-anchor="middle"
                            fill="#0369a1"
                            font-size="14"
                            font-weight="600"
                        >
                            l &gt; r?
                        </text>

                        <!-- Yes Branch -->
                        <path
                            d="M 480 140 L 580 140"
                            stroke="#64748b"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowhead)"
                        />
                        <text x="520" y="130" fill="#059669" font-size="12" font-weight="600">
                            はい
                        </text>
                        <rect
                            x="580"
                            y="115"
                            width="140"
                            height="50"
                            rx="8"
                            fill="#d1fae5"
                            stroke="#10b981"
                            stroke-width="2"
                        />
                        <text
                            x="650"
                            y="145"
                            text-anchor="middle"
                            fill="#059669"
                            font-size="13"
                            font-weight="600"
                        >
                            [None]を返す
                        </text>

                        <!-- No Branch -->
                        <path
                            d="M 400 180 L 400 220"
                            stroke="#64748b"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowhead)"
                        />
                        <text x="420" y="205" fill="#0369a1" font-size="12" font-weight="600">
                            いいえ
                        </text>

                        <!-- Memo Check -->
                        <path
                            d="M 400 220 L 490 260 L 400 300 L 310 260 Z"
                            fill="#fef3c7"
                            stroke="#f59e0b"
                            stroke-width="2"
                        />
                        <text
                            x="400"
                            y="265"
                            text-anchor="middle"
                            fill="#b45309"
                            font-size="13"
                            font-weight="600"
                        >
                            キャッシュ済?
                        </text>

                        <!-- Cached Yes -->
                        <path
                            d="M 490 260 L 570 260"
                            stroke="#64748b"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowhead)"
                        />
                        <text x="520" y="250" fill="#059669" font-size="12" font-weight="600">
                            はい
                        </text>
                        <rect
                            x="570"
                            y="235"
                            width="150"
                            height="50"
                            rx="8"
                            fill="#d1fae5"
                            stroke="#10b981"
                            stroke-width="2"
                        />
                        <text
                            x="645"
                            y="265"
                            text-anchor="middle"
                            fill="#059669"
                            font-size="13"
                            font-weight="600"
                        >
                            キャッシュを返す
                        </text>

                        <!-- Cached No -->
                        <path
                            d="M 400 300 L 400 340"
                            stroke="#64748b"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowhead)"
                        />
                        <text x="420" y="325" fill="#b45309" font-size="12" font-weight="600">
                            いいえ
                        </text>

                        <!-- Loop -->
                        <rect
                            x="280"
                            y="340"
                            width="240"
                            height="50"
                            rx="8"
                            fill="#e0f2fe"
                            stroke="#0ea5e9"
                            stroke-width="2"
                        />
                        <text
                            x="400"
                            y="370"
                            text-anchor="middle"
                            fill="#0369a1"
                            font-size="13"
                            font-weight="600"
                        >
                            各root_val ∈ [l, r]
                            <!-- ∈: 「〜に属する」を意味する数学記号です。プログラミング言語によっては、inやforeachなどのキーワードで表現されます。 -->
                        </text>

                        <!-- Recurse -->
                        <path
                            d="M 400 390 L 400 420"
                            stroke="#64748b"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowhead)"
                        />
                        <rect
                            x="270"
                            y="420"
                            width="260"
                            height="50"
                            rx="8"
                            fill="#fae8ff"
                            stroke="#a855f7"
                            stroke-width="2"
                        />
                        <text
                            x="400"
                            y="450"
                            text-anchor="middle"
                            fill="#7e22ce"
                            font-size="13"
                            font-weight="600"
                        >
                            左右を再帰処理
                        </text>

                        <!-- Combine -->
                        <path
                            d="M 400 470 L 400 500"
                            stroke="#64748b"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowhead)"
                        />
                        <rect
                            x="290"
                            y="500"
                            width="220"
                            height="50"
                            rx="8"
                            fill="#ddd6fe"
                            stroke="#8b5cf6"
                            stroke-width="2"
                        />
                        <text
                            x="400"
                            y="530"
                            text-anchor="middle"
                            fill="#6d28d9"
                            font-size="13"
                            font-weight="600"
                        >
                            直積で合成
                        </text>

                        <!-- Store -->
                        <path
                            d="M 290 525 L 180 525 L 180 260 L 310 260"
                            stroke="#64748b"
                            stroke-width="2"
                            fill="none"
                            marker-end="url(#arrowhead)"
                            stroke-dasharray="5,5"
                        />
                        <text x="200" y="380" fill="#64748b" font-size="11" font-weight="600">
                            メモに保存
                        </text>

                        <!-- Arrow Definition -->
                        <defs>
                            <marker
                                id="arrowhead"
                                markerWidth="10"
                                markerHeight="10"
                                refX="9"
                                refY="3"
                                orient="auto"
                            >
                                <polygon points="0 0, 10 3, 0 6" fill="#64748b" />
                            </marker>
                        </defs>
                    </svg>
                </div>
            </section>

            <!-- Complexity Section -->
            <section id="complexity" class="bg-white rounded-xl shadow-md p-6 sm:p-8 card-hover">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span
                        class="w-2 h-8 bg-gradient-to-b from-emerald-500 to-emerald-600 rounded"
                    ></span>
                    計算量
                </h2>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-emerald-50 rounded-lg p-6 border-l-4 border-emerald-500">
                        <h3 class="text-lg font-semibold text-emerald-800 mb-3">⏱️ 時間計算量</h3>
                        <p class="text-3xl font-bold text-emerald-600 mb-2">O(Cₙ · n)</p>
                        <p class="text-sm text-gray-700">
                            Cₙ はカタラン数（第n項）。各木の構築に O(n)
                            の操作が必要です。メモ化により重複計算を完全に排除し、出力サイズに近い下限に到達します。
                        </p>
                    </div>

                    <div class="bg-sky-50 rounded-lg p-6 border-l-4 border-sky-500">
                        <h3 class="text-lg font-semibold text-sky-800 mb-3">💾 空間計算量</h3>
                        <p class="text-3xl font-bold text-sky-600 mb-2">O(Cₙ · n)</p>
                        <p class="text-sm text-gray-700">
                            出力（全木）が支配的。アルゴリズム側は区間メモ O(n²)
                            個の区間に対し、各区間が最大 O(Cₙ) 本の木を保持します。
                        </p>
                    </div>
                </div>

                <div class="mt-6 overflow-x-auto">
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-300">
                                <th class="px-4 py-3 text-left font-semibold text-gray-700">n</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700">
                                    カタラン数 Cₙ
                                </th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700">
                                    生成本数
                                </th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700">
                                    実行時間
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">1</td>
                                <td class="px-4 py-3">1</td>
                                <td class="px-4 py-3">1本</td>
                                <td class="px-4 py-3 text-green-600">即時</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">2</td>
                                <td class="px-4 py-3">2</td>
                                <td class="px-4 py-3">2本</td>
                                <td class="px-4 py-3 text-green-600">即時</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">3</td>
                                <td class="px-4 py-3">5</td>
                                <td class="px-4 py-3">5本</td>
                                <td class="px-4 py-3 text-green-600">即時</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">8</td>
                                <td class="px-4 py-3">1430</td>
                                <td class="px-4 py-3">1430本</td>
                                <td class="px-4 py-3 text-yellow-600">&lt;100ms</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>

        <footer class="bg-gray-50 border-t border-gray-200 mt-16 py-8">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-600 text-sm">
                <p>LeetCode 95 - Unique Binary Search Trees II</p>
                <p class="mt-2">分割統治 + 区間メモ化による効率的なBST全列挙</p>
            </div>
        </footer>

        <!-- Prism.js Scripts -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

        <!-- React Component -->
        <script type="text/babel">
            const { useState, useEffect, useRef } = React;

            const STEP_AUTO_ADVANCE_DELAY = 2000;
            const INITIAL_STEP = 1;

            const stepsData = [
                {
                    step: 1,
                    title: '初期化',
                    desc: 'n=3 で build(1, 3) を呼び出し。メモ辞書を初期化します。',
                    visual: {
                        type: 'init',
                        range: '[1, 3]',
                        memo: '{}',
                        state: 'start',
                    },
                },
                {
                    step: 2,
                    title: '根候補 1 を選択',
                    desc: 'root_val = 1。左 [1, 0]（空）、右 [2, 3] に分割します。',
                    visual: {
                        type: 'root_select',
                        root: 1,
                        left: '[1, 0]',
                        right: '[2, 3]',
                        leftEmpty: true,
                    },
                },
                {
                    step: 3,
                    title: '右部分木 [2, 3] を再帰',
                    desc: 'build(2, 3) を呼び出し。根候補 2 と 3 を列挙します。',
                    visual: {
                        type: 'recurse',
                        range: '[2, 3]',
                        roots: [2, 3],
                        trees: 2,
                    },
                },
                {
                    step: 4,
                    title: '根候補 2 を選択',
                    desc: 'root_val = 2。左 [1, 1]、右 [3, 3] に分割（中規模の例）。',
                    visual: {
                        type: 'root_select',
                        root: 2,
                        left: '[1, 1]',
                        right: '[3, 3]',
                        leftEmpty: false,
                    },
                },
                {
                    step: 5,
                    title: '直積合成',
                    desc: '左右の全組合せ（left_trees × right_trees）で新しい木を構築します。',
                    visual: {
                        type: 'combine',
                        leftCount: 2,
                        rightCount: 2,
                        resultCount: 4,
                    },
                },
                {
                    step: 6,
                    title: 'メモ化保存',
                    desc: '区間 [l, r] の結果をメモに保存。同一区間の再計算を回避します。',
                    visual: {
                        type: 'memoize',
                        key: '(1, 3)',
                        trees: 5,
                    },
                },
                {
                    step: 7,
                    title: '全木生成完了',
                    desc: 'n=3 の場合、5本の構造的に一意な BST が生成されました。',
                    visual: {
                        type: 'result',
                        totalTrees: 5,
                        catalanNumber: 'C₃ = 5',
                    },
                },
            ];

            function StepVisualization({ stepInfo }) {
                const { visual } = stepInfo;

                if (visual.type === 'init') {
                    return (
                        <svg
                            viewBox="0 0 400 300"
                            className="w-full h-auto svg-fade-in"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            {/* Background */}
                            <rect x="0" y="0" width="400" height="300" fill="#f8fafc" />

                            {/* Title */}
                            <text
                                x="200"
                                y="40"
                                textAnchor="middle"
                                fill="#1e293b"
                                fontSize="20"
                                fontWeight="700"
                            >
                                初期状態
                            </text>

                            {/* Range Box */}
                            <rect
                                x="100"
                                y="80"
                                width="200"
                                height="60"
                                rx="8"
                                fill="#e0f2fe"
                                stroke="#0ea5e9"
                                strokeWidth="2"
                            />
                            <text
                                x="200"
                                y="110"
                                textAnchor="middle"
                                fill="#0369a1"
                                fontSize="16"
                                fontWeight="600"
                            >
                                範囲: {visual.range}
                            </text>
                            <text x="200" y="130" textAnchor="middle" fill="#64748b" fontSize="14">
                                build(1, 3) を呼び出し
                            </text>

                            {/* Memo Box */}
                            <rect
                                x="100"
                                y="170"
                                width="200"
                                height="60"
                                rx="8"
                                fill="#fef3c7"
                                stroke="#f59e0b"
                                strokeWidth="2"
                            />
                            <text
                                x="200"
                                y="200"
                                textAnchor="middle"
                                fill="#b45309"
                                fontSize="16"
                                fontWeight="600"
                            >
                                メモ: {visual.memo}
                            </text>
                            <text x="200" y="220" textAnchor="middle" fill="#64748b" fontSize="14">
                                空のキャッシュ
                            </text>

                            {/* Arrow */}
                            <path
                                d="M 200 140 L 200 170"
                                stroke="#64748b"
                                strokeWidth="2"
                                fill="none"
                                markerEnd="url(#arrow)"
                            />

                            <defs>
                                <marker
                                    id="arrow"
                                    markerWidth="10"
                                    markerHeight="10"
                                    refX="9"
                                    refY="3"
                                    orient="auto"
                                >
                                    <polygon points="0 0, 10 3, 0 6" fill="#64748b" />
                                </marker>
                            </defs>
                        </svg>
                    );
                }

                if (visual.type === 'root_select') {
                    return (
                        <svg
                            viewBox="0 0 400 300"
                            className="w-full h-auto svg-fade-in"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <rect x="0" y="0" width="400" height="300" fill="#f8fafc" />

                            <text
                                x="200"
                                y="40"
                                textAnchor="middle"
                                fill="#1e293b"
                                fontSize="20"
                                fontWeight="700"
                            >
                                根を選択
                            </text>

                            {/* Root Node */}
                            <circle
                                cx="200"
                                cy="100"
                                r="25"
                                fill="#10b981"
                                stroke="#059669"
                                strokeWidth="2"
                            />
                            <text
                                x="200"
                                y="108"
                                textAnchor="middle"
                                fill="white"
                                fontSize="18"
                                fontWeight="700"
                            >
                                {visual.root}
                            </text>

                            {/* Left Branch */}
                            <line
                                x1="200"
                                y1="125"
                                x2="120"
                                y2="180"
                                stroke="#64748b"
                                strokeWidth="2"
                            />
                            <rect
                                x="80"
                                y="180"
                                width="80"
                                height="60"
                                rx="6"
                                fill={visual.leftEmpty ? '#fee2e2' : '#ddd6fe'}
                                stroke={visual.leftEmpty ? '#ef4444' : '#8b5cf6'}
                                strokeWidth="2"
                            />
                            <text
                                x="120"
                                y="200"
                                textAnchor="middle"
                                fill="#334155"
                                fontSize="12"
                                fontWeight="600"
                            >
                                左部分木
                            </text>
                            <text x="120" y="218" textAnchor="middle" fill="#64748b" fontSize="11">
                                {visual.left}
                            </text>
                            {visual.leftEmpty && (
                                <text
                                    x="120"
                                    y="232"
                                    textAnchor="middle"
                                    fill="#dc2626"
                                    fontSize="10"
                                    fontWeight="600"
                                >
                                    空
                                </text>
                            )}

                            {/* Right Branch */}
                            <line
                                x1="200"
                                y1="125"
                                x2="280"
                                y2="180"
                                stroke="#64748b"
                                strokeWidth="2"
                            />
                            <rect
                                x="240"
                                y="180"
                                width="80"
                                height="60"
                                rx="6"
                                fill="#ddd6fe"
                                stroke="#8b5cf6"
                                strokeWidth="2"
                            />
                            <text
                                x="280"
                                y="200"
                                textAnchor="middle"
                                fill="#334155"
                                fontSize="12"
                                fontWeight="600"
                            >
                                右部分木
                            </text>
                            <text x="280" y="218" textAnchor="middle" fill="#64748b" fontSize="11">
                                {visual.right}
                            </text>
                        </svg>
                    );
                }

                if (visual.type === 'recurse') {
                    return (
                        <svg
                            viewBox="0 0 400 300"
                            className="w-full h-auto svg-fade-in"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <rect x="0" y="0" width="400" height="300" fill="#f8fafc" />

                            <text
                                x="200"
                                y="40"
                                textAnchor="middle"
                                fill="#1e293b"
                                fontSize="20"
                                fontWeight="700"
                            >
                                部分木を再帰
                            </text>

                            <rect
                                x="100"
                                y="70"
                                width="200"
                                height="50"
                                rx="8"
                                fill="#e0f2fe"
                                stroke="#0ea5e9"
                                strokeWidth="2"
                            />
                            <text
                                x="200"
                                y="95"
                                textAnchor="middle"
                                fill="#0369a1"
                                fontSize="16"
                                fontWeight="600"
                            >
                                範囲: {visual.range}
                            </text>
                            <text x="200" y="112" textAnchor="middle" fill="#64748b" fontSize="13">
                                根を列挙
                            </text>

                            {/* Root candidates */}
                            {visual.roots.map((root, idx) => (
                                <g key={idx}>
                                    <circle
                                        cx={150 + idx * 100}
                                        cy={180}
                                        r="22"
                                        fill="#a855f7"
                                        stroke="#7e22ce"
                                        strokeWidth="2"
                                    />
                                    <text
                                        x={150 + idx * 100}
                                        y={188}
                                        textAnchor="middle"
                                        fill="white"
                                        fontSize="16"
                                        fontWeight="700"
                                    >
                                        {root}
                                    </text>
                                </g>
                            ))}

                            <text
                                x="200"
                                y="240"
                                textAnchor="middle"
                                fill="#334155"
                                fontSize="14"
                                fontWeight="600"
                            >
                                {visual.trees}本の木を生成
                            </text>
                        </svg>
                    );
                }

                if (visual.type === 'combine') {
                    return (
                        <svg
                            viewBox="0 0 400 300"
                            className="w-full h-auto svg-fade-in"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <rect x="0" y="0" width="400" height="300" fill="#f8fafc" />

                            <text
                                x="200"
                                y="40"
                                textAnchor="middle"
                                fill="#1e293b"
                                fontSize="20"
                                fontWeight="700"
                            >
                                直積合成
                                {/* 「直積合成」は、一般に「直積集合（デカルト積）」や「直積結合（クロスジョイン）」を指し、複数の集合やテーブル、または要素のあらゆる組み合わせを生成する概念 */}
                            </text>

                            {/* Left Trees */}
                            <rect
                                x="50"
                                y="80"
                                width="100"
                                height="70"
                                rx="8"
                                fill="#ddd6fe"
                                stroke="#8b5cf6"
                                strokeWidth="2"
                            />
                            <text
                                x="100"
                                y="105"
                                textAnchor="middle"
                                fill="#6d28d9"
                                fontSize="14"
                                fontWeight="600"
                            >
                                左部分木
                            </text>
                            <text
                                x="100"
                                y="125"
                                textAnchor="middle"
                                fill="#334155"
                                fontSize="18"
                                fontWeight="700"
                            >
                                {visual.leftCount}
                            </text>
                            <text x="100" y="142" textAnchor="middle" fill="#64748b" fontSize="11">
                                パターン
                            </text>

                            {/* Multiply Symbol */}
                            <text
                                x="200"
                                y="120"
                                textAnchor="middle"
                                fill="#64748b"
                                fontSize="24"
                                fontWeight="700"
                            >
                                ×
                            </text>

                            {/* Right Trees */}
                            <rect
                                x="250"
                                y="80"
                                width="100"
                                height="70"
                                rx="8"
                                fill="#ddd6fe"
                                stroke="#8b5cf6"
                                strokeWidth="2"
                            />
                            <text
                                x="300"
                                y="105"
                                textAnchor="middle"
                                fill="#6d28d9"
                                fontSize="14"
                                fontWeight="600"
                            >
                                右部分木
                            </text>
                            <text
                                x="300"
                                y="125"
                                textAnchor="middle"
                                fill="#334155"
                                fontSize="18"
                                fontWeight="700"
                            >
                                {visual.rightCount}
                            </text>
                            <text x="300" y="142" textAnchor="middle" fill="#64748b" fontSize="11">
                                パターン
                            </text>

                            {/* Arrow Down */}
                            <path
                                d="M 200 140 L 200 190"
                                stroke="#64748b"
                                strokeWidth="3"
                                fill="none"
                                markerEnd="url(#arrowCombine)"
                            />

                            {/* Result */}
                            <rect
                                x="100"
                                y="190"
                                width="200"
                                height="80"
                                rx="8"
                                fill="#d1fae5"
                                stroke="#10b981"
                                strokeWidth="3"
                            />
                            <text
                                x="200"
                                y="215"
                                textAnchor="middle"
                                fill="#059669"
                                fontSize="14"
                                fontWeight="600"
                            >
                                組み合わせた木
                            </text>
                            <text
                                x="200"
                                y="240"
                                textAnchor="middle"
                                fill="#334155"
                                fontSize="24"
                                fontWeight="700"
                            >
                                {visual.resultCount}
                            </text>
                            <text x="200" y="260" textAnchor="middle" fill="#64748b" fontSize="11">
                                一意な構造
                            </text>

                            <defs>
                                <marker
                                    id="arrowCombine"
                                    markerWidth="12"
                                    markerHeight="12"
                                    refX="9"
                                    refY="3"
                                    orient="auto"
                                >
                                    <polygon points="0 0, 12 3, 0 6" fill="#64748b" />
                                </marker>
                            </defs>
                        </svg>
                    );
                }

                if (visual.type === 'memoize') {
                    return (
                        <svg
                            viewBox="0 0 400 300"
                            className="w-full h-auto svg-fade-in"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <rect x="0" y="0" width="400" height="300" fill="#f8fafc" />

                            <text
                                x="200"
                                y="40"
                                textAnchor="middle"
                                fill="#1e293b"
                                fontSize="20"
                                fontWeight="700"
                            >
                                メモ化
                            </text>

                            {/* Cache Icon */}
                            <rect
                                x="130"
                                y="80"
                                width="140"
                                height="100"
                                rx="8"
                                fill="#fef3c7"
                                stroke="#f59e0b"
                                strokeWidth="3"
                            />
                            <text
                                x="200"
                                y="105"
                                textAnchor="middle"
                                fill="#b45309"
                                fontSize="16"
                                fontWeight="600"
                            >
                                キャッシュ保存
                            </text>

                            <text x="200" y="130" textAnchor="middle" fill="#334155" fontSize="14">
                                Key: {visual.key}
                            </text>
                            <text x="200" y="150" textAnchor="middle" fill="#334155" fontSize="14">
                                Trees: {visual.trees}
                            </text>
                            <text x="200" y="170" textAnchor="middle" fill="#64748b" fontSize="12">
                                メモに保存済み
                            </text>

                            {/* Check Mark */}
                            <circle
                                cx="200"
                                cy="230"
                                r="25"
                                fill="#10b981"
                                stroke="#059669"
                                strokeWidth="2"
                            />
                            <path
                                d="M 190 230 L 197 237 L 210 222"
                                stroke="white"
                                strokeWidth="3"
                                fill="none"
                                strokeLinecap="round"
                                strokeLinejoin="round"
                            />
                        </svg>
                    );
                }

                if (visual.type === 'result') {
                    return (
                        <svg
                            viewBox="0 0 400 300"
                            className="w-full h-auto svg-fade-in"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <rect x="0" y="0" width="400" height="300" fill="#f8fafc" />

                            <text
                                x="200"
                                y="40"
                                textAnchor="middle"
                                fill="#1e293b"
                                fontSize="20"
                                fontWeight="700"
                            >
                                最終結果
                            </text>

                            {/* Result Box */}
                            <rect
                                x="80"
                                y="80"
                                width="240"
                                height="120"
                                rx="12"
                                fill="#d1fae5"
                                stroke="#10b981"
                                strokeWidth="3"
                            />
                            <text
                                x="200"
                                y="115"
                                textAnchor="middle"
                                fill="#059669"
                                fontSize="18"
                                fontWeight="700"
                            >
                                全ての一意なBSTを生成
                            </text>

                            <text
                                x="200"
                                y="150"
                                textAnchor="middle"
                                fill="#334155"
                                fontSize="32"
                                fontWeight="800"
                            >
                                {visual.totalTrees}
                            </text>
                            <text x="200" y="175" textAnchor="middle" fill="#64748b" fontSize="14">
                                一意な木
                            </text>

                            {/* Catalan Badge */}
                            <rect
                                x="120"
                                y="220"
                                width="160"
                                height="40"
                                rx="20"
                                fill="#e0f2fe"
                                stroke="#0ea5e9"
                                strokeWidth="2"
                            />
                            <text
                                x="200"
                                y="245"
                                textAnchor="middle"
                                fill="#0369a1"
                                fontSize="14"
                                fontWeight="600"
                            >
                                {visual.catalanNumber}
                            </text>
                        </svg>
                    );
                }

                return null;
            }

            function VisualizerComponent() {
                const [activeStep, setActiveStep] = useState(INITIAL_STEP);
                const [isPlaying, setIsPlaying] = useState(false);
                const timerRef = useRef(null);
                const totalSteps = stepsData.length;

                // Auto-play logic
                useEffect(() => {
                    if (!isPlaying) return;

                    timerRef.current = setTimeout(() => {
                        setActiveStep((prev) => {
                            const nextStep = prev + 1;
                            if (nextStep > totalSteps) {
                                setIsPlaying(false);
                                return INITIAL_STEP;
                            }
                            return nextStep;
                        });
                    }, STEP_AUTO_ADVANCE_DELAY);

                    return () => {
                        if (timerRef.current) {
                            clearTimeout(timerRef.current);
                        }
                    };
                }, [isPlaying, activeStep, totalSteps]);

                const handlePlay = () => {
                    if (isPlaying) return;
                    setActiveStep(INITIAL_STEP);
                    setIsPlaying(true);
                };

                const handleReset = () => {
                    setIsPlaying(false);
                    setActiveStep(INITIAL_STEP);
                    if (timerRef.current) {
                        clearTimeout(timerRef.current);
                    }
                };

                const handlePrev = () => {
                    setIsPlaying(false);
                    setActiveStep((prev) => Math.max(1, prev - 1));
                };

                const handleNext = () => {
                    setIsPlaying(false);
                    setActiveStep((prev) => Math.min(totalSteps, prev + 1));
                };

                const handleStepClick = (step) => {
                    setIsPlaying(false);
                    setActiveStep(step);
                };

                const currentStepInfo = stepsData[activeStep - 1];

                return (
                    <div className="space-y-6">
                        {/* Two Column Layout */}
                        <div className="grid md:grid-cols-2 gap-6 two-col-layout">
                            {/* Left: Step List */}
                            <div className="space-y-3">
                                <h3 className="text-lg font-semibold text-gray-800 mb-4">
                                    ステップ一覧
                                </h3>
                                {stepsData.map((stepData) => (
                                    <button
                                        key={stepData.step}
                                        type="button"
                                        onClick={() => handleStepClick(stepData.step)}
                                        className={`step-btn w-full text-left p-4 rounded-lg border-2 transition-all ${
                                            activeStep === stepData.step
                                                ? 'active border-emerald-500'
                                                : 'bg-white border-gray-200 hover:border-emerald-300 hover:shadow-md'
                                        }`}
                                        aria-label={`ステップ ${stepData.step}: ${stepData.title}`}
                                        aria-current={
                                            activeStep === stepData.step ? 'step' : undefined
                                        }
                                    >
                                        <div className="flex items-start gap-3">
                                            <span
                                                className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                                                    activeStep === stepData.step
                                                        ? 'bg-white text-emerald-600'
                                                        : 'bg-gray-100 text-gray-600'
                                                }`}
                                            >
                                                {stepData.step}
                                            </span>
                                            <div className="flex-1 min-w-0">
                                                <h4
                                                    className={`font-semibold mb-1 ${
                                                        activeStep === stepData.step
                                                            ? 'text-white'
                                                            : 'text-gray-800'
                                                    }`}
                                                >
                                                    {stepData.title}
                                                </h4>
                                                <p
                                                    className={`text-sm ${
                                                        activeStep === stepData.step
                                                            ? 'text-emerald-50'
                                                            : 'text-gray-600'
                                                    }`}
                                                >
                                                    {stepData.desc}
                                                </p>
                                            </div>
                                        </div>
                                    </button>
                                ))}
                            </div>

                            {/* Right: Visualization */}
                            <div className="bg-white rounded-lg border-2 border-gray-200 p-6">
                                <h3 className="text-lg font-semibold text-gray-800 mb-4">視覚化</h3>
                                <div className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                    <StepVisualization stepInfo={currentStepInfo} />
                                </div>

                                <div className="mt-4 p-3 bg-sky-50 rounded-lg border border-sky-200">
                                    <p className="text-sm text-gray-700">
                                        <span className="font-semibold text-sky-700">
                                            Step {activeStep}:
                                        </span>{' '}
                                        {currentStepInfo.desc}
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="flex flex-wrap items-center justify-center gap-3">
                            <button
                                type="button"
                                onClick={handlePlay}
                                disabled={isPlaying}
                                className="control-btn px-6 py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-semibold rounded-lg shadow-md disabled:opacity-40 disabled:cursor-not-allowed"
                                aria-label="自動再生"
                            >
                                ▶ Play
                            </button>

                            <button
                                type="button"
                                onClick={handlePrev}
                                disabled={activeStep === 1 || isPlaying}
                                className="control-btn px-6 py-3 bg-white text-gray-700 font-semibold rounded-lg shadow-md border-2 border-gray-300 hover:border-emerald-500"
                                aria-label="前のステップ"
                            >
                                ← Prev
                            </button>

                            <button
                                type="button"
                                onClick={handleNext}
                                disabled={activeStep === totalSteps || isPlaying}
                                className="control-btn px-6 py-3 bg-white text-gray-700 font-semibold rounded-lg shadow-md border-2 border-gray-300 hover:border-emerald-500"
                                aria-label="次のステップ"
                            >
                                Next →
                            </button>

                            <button
                                type="button"
                                onClick={handleReset}
                                className="control-btn px-6 py-3 bg-white text-gray-700 font-semibold rounded-lg shadow-md border-2 border-gray-300 hover:border-sky-500"
                                aria-label="リセット"
                            >
                                ↻ Reset
                            </button>
                        </div>

                        {/* Progress Indicator */}
                        <div className="flex items-center justify-center gap-2">
                            <span className="text-sm text-gray-600 font-medium">
                                Step {activeStep} / {totalSteps}
                            </span>
                            <div className="flex-1 max-w-md h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div
                                    className="h-full bg-gradient-to-r from-emerald-500 to-emerald-600 transition-all duration-300"
                                    style={{ width: `${(activeStep / totalSteps) * 100}%` }}
                                />
                            </div>
                        </div>
                    </div>
                );
            }

            // Mount component
            const container = document.getElementById('interactive-demo');
            if (container) {
                const root = ReactDOM.createRoot(container);
                root.render(<VisualizerComponent />);
            }
        </script>
    </body>
</html>
