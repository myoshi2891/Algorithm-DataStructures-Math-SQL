<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LeetCode 1193 - Monthly Transactions I</title>
        <script
            src="https://unpkg.com/react@18.3.1/umd/react.production.min.js"
            integrity="sha384-DGyLxAyjq0f9SPpVevD6IgztCFlnMF6oW/XQGmfe+IsZ8TqEiDrcHkMLKI6fiB/Z"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js"
            integrity="sha384-gTGxhz21lVGYNMcdJOyq01Edg0jhn/c22nsx0kyqP0TxaV5WVdsSH1fSDUf5YJj1"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://unpkg.com/@babel/standalone@7.24.7/babel.min.js"
            integrity="sha384-AISI5AuDG6E8DeEiFMVB3rGQxhZt24OU0avMp+GMV64+tpnA3+Z6F5MT0f96iPva"
            crossorigin="anonymous"
        ></script>
        <script src="/vendor/tailwindcss/script.js"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
            integrity="sha384-wFjoQjtV1y5jVHbt0p35Ui8aV8GVpEZkyF99OXWqP/eNJDU93D3Ugxkoyh6Y2I4A"
            crossorigin="anonymous"
        />
        <link
            rel="stylesheet"
            href="/vendor/prismjs/plugins/line-numbers/prism-line-numbers.css"
            integrity="sha384-nUkTNLI8COlMCRJ0FHIdX76If83145OTCLUx4gQyfnO0gGeO/sD9czGEUBxtkcUv"
            crossorigin="anonymous"
        />
        <link
            rel="stylesheet"
            href="/vendor/prismjs/plugins/toolbar/prism-toolbar.css"
            integrity="sha384-EUzJ34/1CCeefTGUKLgvA5Z/vYIwi+Jyu8aAaCfFDxfwZ3Xs3OfkkIeegsLRM11e"
            crossorigin="anonymous"
        />
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"
            integrity="sha384-06z5D//U/xpvxZHuUz92xBvq3DqBBFi7Up53HRrbV7Jlv7Yvh/MZ7oenfUe9iCEt"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"
            integrity="sha384-/MKWdycCDliku23mP5sYXbZNuXrzgmQO/jsVxwPFn99dVOaXRyKsqDjarqpueGAp"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"
            integrity="sha384-WJdEkJKrbsqw0evQ4GB6mlsKe5cGTxBOw4KAEIa52ZLB7DDpliGkwdme/HMa5n1m"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"
            integrity="sha384-6QJu8apxMmB9TiPVWzYKF5pRgKcz7snO0/QU+MrWmgBLECQjoa6erxX2VQ5t41Jd"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"
            integrity="sha384-jC1G68eGEXJpPwMDNqyIUQsQlcUCdCU+a7GGuoV4TUZvM1gLYTMJUDvqBnxtZLWA"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"
            integrity="sha384-ZdEfx8sYX8i4IVXU1tUbqwOp4PBUCCmnpagpiHchnstXkEczkzPfUd9fvBrntM+F"
            crossorigin="anonymous"
        ></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&family=JetBrains+Mono:wght@400;600&family=Outfit:wght@400;600;800&display=swap"
            rel="stylesheet"
        />
        <style>
            html {
                scroll-behavior: smooth;
            }
            body {
                font-family: 'Noto Sans JP', sans-serif;
            }
            .code-toolbar > .toolbar {
                top: 0.6em;
                right: 0.8em;
                opacity: 1 !important;
            }
            .code-toolbar > .toolbar .toolbar-item a,
            .code-toolbar > .toolbar .toolbar-item button,
            .code-toolbar > .toolbar .toolbar-item span {
                background: #10b981 !important;
                color: white !important;
                border-radius: 6px !important;
                padding: 0.5rem 1rem !important;
                font-size: 12px !important;
                border: none !important;
                cursor: pointer !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }
            .code-toolbar > .toolbar .toolbar-item button:hover,
            .code-toolbar > .toolbar .toolbar-item a:hover {
                background: #059669 !important;
                color: white !important;
                padding: 0.5rem 1rem !important;
            }
            pre[class*='language-'] {
                border-radius: 12px;
                font-family: 'JetBrains Mono', monospace;
                font-size: 14px;
            }
            .outfit {
                font-family: 'Outfit', sans-serif;
            }
        </style>
    </head>
    <body class="bg-[linear-gradient(135deg,#f0fdf4_0%,#e0f2fe_100%)] min-h-screen">
        <div class="max-w-6xl mx-auto px-4 py-8">
            <!-- Header -->
            <header
                id="header"
                class="mb-8 rounded-2xl p-8 shadow-[0_10px_30px_rgba(16,185,129,0.12)] bg-[linear-gradient(135deg,#d1fae5,#bfdbfe)]"
            >
                <div class="flex items-center gap-3 mb-2">
                    <span
                        class="bg-emerald-600 text-white text-sm font-bold px-3 py-1 rounded-full outfit"
                        >LeetCode 1193</span
                    >
                    <span
                        class="bg-sky-500 text-white text-sm font-bold px-3 py-1 rounded-full outfit"
                        >Medium</span
                    >
                </div>
                <h1 class="outfit text-[2.4rem] font-extrabold text-teal-900 mb-1">
                    Monthly Transactions I
                </h1>
                <p class="text-lg text-cyan-700 font-semibold mt-1">
                    月×国ごとの GROUP BY 集計 + 条件付き SUM による O(N) 実装
                </p>

                <nav class="flex flex-wrap gap-3 mt-6">
                    <a
                        href="#overview"
                        class="inline-block px-4 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_6px_16px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-600 text-sm"
                        >概要</a
                    >
                    <a
                        href="#steps"
                        class="inline-block px-4 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_6px_16px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-600 text-sm"
                        >ステップ解説</a
                    >
                    <a
                        href="#sql"
                        class="inline-block px-4 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_6px_16px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-600 text-sm"
                        >SQLコード</a
                    >
                    <a
                        href="#pandas"
                        class="inline-block px-4 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_6px_16px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-600 text-sm"
                        >Pandasコード</a
                    >
                    <a
                        href="#diagram"
                        class="inline-block px-4 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_6px_16px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-600 text-sm"
                        >フローチャート</a
                    >
                    <a
                        href="#complexity"
                        class="inline-block px-4 py-2 font-semibold text-slate-700 no-underline rounded-lg border-2 border-slate-200 bg-white transition hover:shadow-[0_6px_16px_rgba(15,118,110,0.20)] hover:-translate-y-0.5 hover:bg-[linear-gradient(180deg,#e8fff6,#c8f1e1)] hover:border-teal-600 text-sm"
                        >計算量</a
                    >
                </nav>
            </header>

            <!-- Overview -->
            <section id="overview" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="outfit text-[1.9rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    アルゴリズム概要
                </h2>
                <p class="text-slate-700 leading-8 mb-4">
                    <code class="bg-slate-100 px-2 py-0.5 rounded text-sm font-mono"
                        >Transactions</code
                    >
                    テーブルから、
                    <strong>月（YYYY-MM）× 国</strong>
                    の組み合わせごとに以下の4指標を集計する問題です。
                </p>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div
                        style="background: #d1fae5; color: #065f46"
                        class="rounded-xl p-3 text-center"
                    >
                        <div class="font-bold text-xs font-mono break-all leading-tight">
                            trans_count
                        </div>
                        <div class="text-xs mt-1">全トランザクション数</div>
                    </div>
                    <div
                        style="background: #bfdbfe; color: #1e40af"
                        class="rounded-xl p-3 text-center"
                    >
                        <div class="font-bold text-xs font-mono break-all leading-tight">
                            approved_count
                        </div>
                        <div class="text-xs mt-1">承認件数</div>
                    </div>
                    <div
                        style="background: #fef3c7; color: #92400e"
                        class="rounded-xl p-3 text-center"
                    >
                        <div class="font-bold text-xs font-mono break-all leading-tight">
                            trans_total_amount
                        </div>
                        <div class="text-xs mt-1">全合計金額</div>
                    </div>
                    <div
                        style="background: #ede9fe; color: #5b21b6"
                        class="rounded-xl p-3 text-center"
                    >
                        <div class="font-bold text-xs font-mono break-all leading-tight">
                            approved_total_amount
                        </div>
                        <div class="text-xs mt-1">承認合計金額</div>
                    </div>
                </div>

                <h3 class="font-bold text-teal-800 text-lg mb-2">入出力例</h3>
                <div class="overflow-x-auto mb-4">
                    <table class="text-sm w-full border-collapse">
                        <thead>
                            <tr class="bg-slate-100">
                                <th class="border border-slate-200 px-3 py-2 text-left font-mono">
                                    id
                                </th>
                                <th class="border border-slate-200 px-3 py-2 text-left font-mono">
                                    country
                                </th>
                                <th class="border border-slate-200 px-3 py-2 text-left font-mono">
                                    state
                                </th>
                                <th class="border border-slate-200 px-3 py-2 text-left font-mono">
                                    amount
                                </th>
                                <th class="border border-slate-200 px-3 py-2 text-left font-mono">
                                    trans_date
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border border-slate-200 px-3 py-1">121</td>
                                <td class="border border-slate-200 px-3 py-1">US</td>
                                <td
                                    class="border border-slate-200 px-3 py-1 text-emerald-600 font-bold"
                                >
                                    approved
                                </td>
                                <td class="border border-slate-200 px-3 py-1">1000</td>
                                <td class="border border-slate-200 px-3 py-1">2018-12-18</td>
                            </tr>
                            <tr class="bg-slate-50">
                                <td class="border border-slate-200 px-3 py-1">122</td>
                                <td class="border border-slate-200 px-3 py-1">US</td>
                                <td
                                    class="border border-slate-200 px-3 py-1 text-red-500 font-bold"
                                >
                                    declined
                                </td>
                                <td class="border border-slate-200 px-3 py-1">2000</td>
                                <td class="border border-slate-200 px-3 py-1">2018-12-19</td>
                            </tr>
                            <tr>
                                <td class="border border-slate-200 px-3 py-1">123</td>
                                <td class="border border-slate-200 px-3 py-1">US</td>
                                <td
                                    class="border border-slate-200 px-3 py-1 text-emerald-600 font-bold"
                                >
                                    approved
                                </td>
                                <td class="border border-slate-200 px-3 py-1">2000</td>
                                <td class="border border-slate-200 px-3 py-1">2019-01-01</td>
                            </tr>
                            <tr class="bg-slate-50">
                                <td class="border border-slate-200 px-3 py-1">124</td>
                                <td
                                    class="border border-slate-200 px-3 py-1 text-amber-600 font-bold"
                                >
                                    NULL
                                </td>
                                <td
                                    class="border border-slate-200 px-3 py-1 text-emerald-600 font-bold"
                                >
                                    approved
                                </td>
                                <td class="border border-slate-200 px-3 py-1">2000</td>
                                <td class="border border-slate-200 px-3 py-1">2019-01-07</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="font-bold text-teal-800 text-lg mb-2">⚠️ 落とし穴まとめ</h3>
                <div class="grid md:grid-cols-3 gap-4">
                    <div class="rounded-xl border-2 border-red-200 bg-red-50 p-4">
                        <div class="font-bold text-red-700 mb-1">❌ SUM の NULL 問題</div>
                        <div class="text-sm text-slate-600">
                            承認行が 0 件のグループで
                            <code class="bg-white px-1 rounded">SUM</code> は
                            <code class="bg-white px-1 rounded">NULL</code> を返す →
                            <code class="bg-white px-1 rounded">COALESCE(...,0)</code> 必須
                        </div>
                    </div>
                    <div class="rounded-xl border-2 border-amber-200 bg-amber-50 p-4">
                        <div class="font-bold text-amber-700 mb-1">❌ country=NULL 脱落</div>
                        <div class="text-sm text-slate-600">
                            SQL の <code class="bg-white px-1 rounded">GROUP BY</code> と pandas の
                            <code class="bg-white px-1 rounded">groupby</code> はデフォルトで NULL
                            キーを除外する
                        </div>
                    </div>
                    <div class="rounded-xl border-2 border-purple-200 bg-purple-50 p-4">
                        <div class="font-bold text-purple-700 mb-1">❌ FILTER 句の環境差異</div>
                        <div class="text-sm text-slate-600">
                            PostgreSQL 独自構文のため MySQL では動作しない。本問は PostgreSQL
                            対応済み
                        </div>
                    </div>
                </div>
            </section>

            <!-- Steps (React) -->
            <section id="steps" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="outfit text-[1.9rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    ステップバイステップ解説
                </h2>
                <div id="steps-root"></div>
            </section>

            <!-- SQL Code -->
            <section id="sql" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="outfit text-[1.9rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    PostgreSQL 実装
                </h2>
                <pre class="line-numbers"><code class="language-sql">SELECT
    TO_CHAR(trans_date, 'YYYY-MM')                              AS month,
    country,
    COUNT(*)                                                     AS trans_count,
    COUNT(*) FILTER (WHERE state = 'approved')                  AS approved_count,
    SUM(amount)                                                  AS trans_total_amount,
    COALESCE(SUM(amount) FILTER (WHERE state = 'approved'), 0)  AS approved_total_amount
FROM Transactions
GROUP BY
    TO_CHAR(trans_date, 'YYYY-MM'),
    country;</code></pre>

                <div class="mt-6 grid md:grid-cols-3 gap-4 text-sm">
                    <div class="bg-emerald-50 rounded-xl p-4 border border-emerald-200">
                        <div class="font-bold text-emerald-800 mb-1">TO_CHAR(..., 'YYYY-MM')</div>
                        <div class="text-slate-600">
                            日付を YYYY-MM 文字列に変換。DATE_TRUNC より出力形式が直接的
                        </div>
                    </div>
                    <div class="bg-sky-50 rounded-xl p-4 border border-sky-200">
                        <div class="font-bold text-sky-800 mb-1">FILTER (WHERE ...)</div>
                        <div class="text-slate-600">
                            PostgreSQL 拡張。CASE WHEN より意図が明確で最適化しやすい
                        </div>
                    </div>
                    <div class="bg-amber-50 rounded-xl p-4 border border-amber-200">
                        <div class="font-bold text-amber-800 mb-1">COALESCE(..., 0)</div>
                        <div class="text-slate-600">
                            承認行が 0 件時に SUM が NULL → 0 になるのを防ぐ。★ 最重要修正点
                        </div>
                    </div>
                </div>
            </section>

            <!-- Pandas Code -->
            <section id="pandas" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="outfit text-[1.9rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    Pandas 実装（Python 3.10 / pandas 2.2.2）
                </h2>
                <pre class="line-numbers"><code class="language-python">import pandas as pd

def monthly_transactions(transactions: pd.DataFrame) -> pd.DataFrame:
    """
    Returns:
        pd.DataFrame: 列名と順序は
            [month, country, trans_count, approved_count,
             trans_total_amount, approved_total_amount]
    """
    # ★ copy() 廃止: 必要列のみで軽量 DataFrame を新規構築
    is_approved = (transactions['state'] == 'approved').astype('int8')  # int8 で省メモリ

    tmp = pd.DataFrame({
        'month'        : transactions['trans_date'].dt.to_period('M').astype(str),
        'country'      : transactions['country'],
        'id'           : transactions['id'],
        'amount'       : transactions['amount'],
        'is_approved'  : is_approved,
        'approved_amt' : transactions['amount'] * is_approved,
    })

    out = (
        tmp.groupby(['month', 'country'], sort=False, dropna=False)  # ★ dropna=False
           .agg(
               trans_count           = ('id',          'count'),
               approved_count        = ('is_approved', 'sum'),
               trans_total_amount    = ('amount',       'sum'),
               approved_total_amount = ('approved_amt', 'sum'),
           )
           .reset_index()
    )

    # dtype を明示的に int に統一（NaN キー混在時の float64 混入を防ぐ）
    out[['trans_count', 'approved_count',
         'trans_total_amount', 'approved_total_amount']] = \
        out[['trans_count', 'approved_count',
             'trans_total_amount', 'approved_total_amount']].astype(int)

    return out</code></pre>

                <div class="mt-6 grid md:grid-cols-2 gap-4 text-sm">
                    <div class="bg-red-50 rounded-xl p-4 border-2 border-red-300">
                        <div class="font-bold text-red-700 mb-2">★ 最重要: dropna=False</div>
                        <div class="text-slate-600">
                            pandas の
                            <code class="bg-white px-1 rounded font-mono">groupby</code>
                            はデフォルト
                            <code class="bg-white px-1 rounded font-mono">dropna=True</code> で
                            <code class="bg-white px-1 rounded font-mono">country=NaN</code>
                            のグループを無言で除外する。<code
                                class="bg-white px-1 rounded font-mono"
                                >dropna=False</code
                            >
                            で NaN キーも1グループとして保持。
                        </div>
                    </div>
                    <div class="bg-purple-50 rounded-xl p-4 border-2 border-purple-300">
                        <div class="font-bold text-purple-700 mb-2">メモリ最適化</div>
                        <div class="text-slate-600">
                            <code class="bg-white px-1 rounded font-mono">.astype('int8')</code>
                            で承認フラグを 1 byte/行に圧縮（int64 比 87.5% 削減）。<code
                                class="bg-white px-1 rounded font-mono"
                                >copy()</code
                            >
                            廃止で全列複製コストをゼロに。
                        </div>
                    </div>
                </div>
            </section>

            <!-- Diagram -->
            <section id="diagram" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="outfit text-[1.9rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    処理フローチャート
                </h2>
                <div class="mt-5 overflow-x-auto">
                    <!-- viewBox: 560px幅 / 中心x=280 / 全ボックス幅440px(x=60〜500) -->
                    <svg
                        viewBox="0 0 560 1020"
                        style="
                            max-width: 560px;
                            width: 100%;
                            height: auto;
                            display: block;
                            margin: 0 auto;
                        "
                        role="img"
                        aria-label="Monthly Transactions I flowchart"
                    >
                        <defs>
                            <marker
                                id="fc-arrow"
                                markerWidth="10"
                                markerHeight="10"
                                refX="9"
                                refY="3"
                                orient="auto"
                                markerUnits="strokeWidth"
                            >
                                <path d="M0,0 L0,6 L9,3 z" fill="#64748b" />
                            </marker>
                            <marker
                                id="fc-arrowGreen"
                                markerWidth="10"
                                markerHeight="10"
                                refX="9"
                                refY="3"
                                orient="auto"
                                markerUnits="strokeWidth"
                            >
                                <path d="M0,0 L0,6 L9,3 z" fill="#059669" />
                            </marker>
                        </defs>

                        <!-- ========== 開始 ========== -->
                        <ellipse
                            cx="280"
                            cy="48"
                            rx="110"
                            ry="28"
                            fill="#d1fae5"
                            stroke="#10b981"
                            stroke-width="2"
                        />
                        <text
                            x="280"
                            y="48"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="16"
                            font-weight="bold"
                            fill="#065f46"
                        >
                            開始
                        </text>

                        <line
                            x1="280"
                            y1="76"
                            x2="280"
                            y2="103"
                            stroke="#64748b"
                            stroke-width="2"
                            marker-end="url(#fc-arrow)"
                        />

                        <!-- ========== Step1: 月文字列を生成 ========== -->
                        <!-- box: x=60 w=440 → center=280 -->
                        <rect
                            x="60"
                            y="108"
                            width="440"
                            height="58"
                            rx="10"
                            fill="#e0f2fe"
                            stroke="#0284c7"
                            stroke-width="2"
                        />
                        <text
                            x="280"
                            y="128"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="bold"
                            fill="#0c4a6e"
                        >
                            月文字列を生成
                        </text>
                        <text
                            x="280"
                            y="150"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="12"
                            fill="#0369a1"
                        >
                            TO_CHAR(trans_date, 'YYYY-MM')
                        </text>

                        <line
                            x1="280"
                            y1="166"
                            x2="280"
                            y2="193"
                            stroke="#64748b"
                            stroke-width="2"
                            marker-end="url(#fc-arrow)"
                        />

                        <!-- ========== Step2: 承認フラグ列を付与 ========== -->
                        <rect
                            x="60"
                            y="198"
                            width="440"
                            height="68"
                            rx="10"
                            fill="#e0f2fe"
                            stroke="#0284c7"
                            stroke-width="2"
                        />
                        <text
                            x="280"
                            y="220"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="bold"
                            fill="#0c4a6e"
                        >
                            承認フラグ列を付与
                        </text>
                        <text
                            x="280"
                            y="244"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="11"
                            fill="#0369a1"
                        >
                            is_approved = (state == 'approved').astype('int8')
                        </text>

                        <line
                            x1="280"
                            y1="266"
                            x2="280"
                            y2="293"
                            stroke="#64748b"
                            stroke-width="2"
                            marker-end="url(#fc-arrow)"
                        />

                        <!-- ========== Step3: GROUP BY ========== -->
                        <rect
                            x="60"
                            y="298"
                            width="440"
                            height="68"
                            rx="10"
                            fill="#e0f2fe"
                            stroke="#0284c7"
                            stroke-width="2"
                        />
                        <text
                            x="280"
                            y="320"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="bold"
                            fill="#0c4a6e"
                        >
                            GROUP BY month × country
                        </text>
                        <text
                            x="280"
                            y="344"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="12"
                            fill="#0369a1"
                        >
                            dropna=False で NaN キーも保持 ★
                        </text>

                        <line
                            x1="280"
                            y1="366"
                            x2="280"
                            y2="393"
                            stroke="#64748b"
                            stroke-width="2"
                            marker-end="url(#fc-arrow)"
                        />

                        <!-- ========== Step4: 4指標を一括集計（縦4行） ========== -->
                        <!-- box height: title行 + 4行×22px = 30+88+padding=140 -->
                        <rect
                            x="60"
                            y="398"
                            width="440"
                            height="145"
                            rx="10"
                            fill="#f1f5f9"
                            stroke="#64748b"
                            stroke-width="2"
                        />
                        <text
                            x="280"
                            y="420"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="bold"
                            fill="#1e293b"
                        >
                            4 指標を一括集計
                        </text>
                        <!-- 区切り線 -->
                        <line
                            x1="80"
                            y1="433"
                            x2="480"
                            y2="433"
                            stroke="#cbd5e1"
                            stroke-width="1"
                        />
                        <!-- 4行それぞれ中央揃え -->
                        <text
                            x="280"
                            y="452"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="12"
                            fill="#475569"
                        >
                            COUNT(*) → trans_count
                        </text>
                        <text
                            x="280"
                            y="474"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="12"
                            fill="#475569"
                        >
                            SUM(is_approved) → approved_count
                        </text>
                        <text
                            x="280"
                            y="496"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="12"
                            fill="#475569"
                        >
                            SUM(amount) → trans_total_amount
                        </text>
                        <text
                            x="280"
                            y="518"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="12"
                            fill="#475569"
                        >
                            SUM(approved_amt) → approved_total_amount
                        </text>

                        <line
                            x1="280"
                            y1="543"
                            x2="280"
                            y2="570"
                            stroke="#64748b"
                            stroke-width="2"
                            marker-end="url(#fc-arrow)"
                        />

                        <!-- ========== Step5: NULL / dtype を統一 ========== -->
                        <rect
                            x="60"
                            y="575"
                            width="440"
                            height="62"
                            rx="10"
                            fill="#fef3c7"
                            stroke="#f59e0b"
                            stroke-width="2"
                        />
                        <text
                            x="280"
                            y="597"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="bold"
                            fill="#78350f"
                        >
                            NULL / dtype を統一
                        </text>
                        <text
                            x="280"
                            y="621"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="12"
                            fill="#92400e"
                        >
                            COALESCE(..., 0) / .astype(int)
                        </text>

                        <line
                            x1="280"
                            y1="637"
                            x2="280"
                            y2="664"
                            stroke="#64748b"
                            stroke-width="2"
                            marker-end="url(#fc-arrow)"
                        />

                        <!-- ========== Step6: reset_index ========== -->
                        <rect
                            x="60"
                            y="669"
                            width="440"
                            height="52"
                            rx="10"
                            fill="#e0f2fe"
                            stroke="#0284c7"
                            stroke-width="2"
                        />
                        <text
                            x="280"
                            y="695"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="bold"
                            fill="#0c4a6e"
                        >
                            reset_index() で列に昇格
                        </text>

                        <line
                            x1="280"
                            y1="721"
                            x2="280"
                            y2="748"
                            stroke="#059669"
                            stroke-width="2"
                            marker-end="url(#fc-arrowGreen)"
                        />

                        <!-- ========== 出力 DataFrame ========== -->
                        <!-- 2行テキスト: title + 列1 + 列2 → height=95 -->
                        <rect
                            x="60"
                            y="753"
                            width="440"
                            height="95"
                            rx="12"
                            fill="#d1fae5"
                            stroke="#059669"
                            stroke-width="2.5"
                        />
                        <text
                            x="280"
                            y="776"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="14"
                            font-weight="bold"
                            fill="#065f46"
                        >
                            出力 DataFrame（6列）
                        </text>
                        <text
                            x="280"
                            y="802"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="12"
                            fill="#047857"
                        >
                            month | country | trans_count | approved_count
                        </text>
                        <text
                            x="280"
                            y="826"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="12"
                            fill="#047857"
                        >
                            trans_total_amount | approved_total_amount
                        </text>

                        <line
                            x1="280"
                            y1="848"
                            x2="280"
                            y2="875"
                            stroke="#059669"
                            stroke-width="2"
                            marker-end="url(#fc-arrowGreen)"
                        />

                        <!-- ========== 終了 ========== -->
                        <ellipse
                            cx="280"
                            cy="900"
                            rx="110"
                            ry="28"
                            fill="#d1fae5"
                            stroke="#10b981"
                            stroke-width="2"
                        />
                        <text
                            x="280"
                            y="900"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            font-size="16"
                            font-weight="bold"
                            fill="#065f46"
                        >
                            終了
                        </text>
                    </svg>
                </div>
                <p class="mt-6 text-slate-700 leading-8 text-sm">
                    <strong class="text-lg text-teal-800">フローの説明：</strong><br />
                    1. <code class="bg-slate-100 px-1 rounded font-mono">trans_date</code> から
                    <code class="bg-slate-100 px-1 rounded font-mono">YYYY-MM</code>
                    形式の月文字列列を生成する<br />
                    2.
                    <code class="bg-slate-100 px-1 rounded font-mono">state == 'approved'</code> の
                    boolean を
                    <code class="bg-slate-100 px-1 rounded font-mono">int8</code>
                    に変換し、フラグ列・金額列を付与する<br />
                    3. <code class="bg-slate-100 px-1 rounded font-mono">month × country</code> で
                    GROUP BY。<strong class="text-red-600"
                        >★
                        <code class="bg-slate-100 px-1 rounded font-mono"
                            >dropna=False</code
                        ></strong
                    >
                    で
                    <code class="bg-slate-100 px-1 rounded font-mono">country=NaN</code>
                    を保持する<br />
                    4.
                    <code class="bg-slate-100 px-1 rounded font-mono">COUNT / SUM</code>
                    で4指標を一括集計する<br />
                    5.
                    <code class="bg-slate-100 px-1 rounded font-mono">COALESCE / astype(int)</code>
                    で NULL・dtype を統一する<br />
                    6. <code class="bg-slate-100 px-1 rounded font-mono">reset_index()</code> で
                    month・country を通常列に昇格し返却する
                </p>
            </section>

            <!-- Complexity -->
            <section id="complexity" class="bg-white rounded-2xl p-8 mb-8 shadow">
                <h2
                    class="outfit text-[1.9rem] font-bold text-cyan-700 mb-4 pb-2 border-b-[3px] border-emerald-200"
                >
                    計算量分析
                </h2>
                <div class="overflow-x-auto mb-6">
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-slate-100">
                                <th class="border border-slate-200 px-4 py-3 text-left">
                                    フェーズ
                                </th>
                                <th class="border border-slate-200 px-4 py-3 text-left">SQL</th>
                                <th class="border border-slate-200 px-4 py-3 text-left">Pandas</th>
                                <th class="border border-slate-200 px-4 py-3 text-left">備考</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border border-slate-200 px-4 py-2">月文字列生成</td>
                                <td
                                    class="border border-slate-200 px-4 py-2 font-mono text-emerald-700"
                                >
                                    O(N)
                                </td>
                                <td
                                    class="border border-slate-200 px-4 py-2 font-mono text-emerald-700"
                                >
                                    O(N)
                                </td>
                                <td class="border border-slate-200 px-4 py-2 text-slate-500">
                                    ベクトル演算
                                </td>
                            </tr>
                            <tr class="bg-slate-50">
                                <td class="border border-slate-200 px-4 py-2">
                                    GROUP BY / groupby.agg
                                </td>
                                <td
                                    class="border border-slate-200 px-4 py-2 font-mono text-emerald-700"
                                >
                                    O(N)
                                </td>
                                <td
                                    class="border border-slate-200 px-4 py-2 font-mono text-emerald-700"
                                >
                                    O(N)
                                </td>
                                <td class="border border-slate-200 px-4 py-2 text-slate-500">
                                    ハッシュ集計。G ≪ N なら線形近似
                                </td>
                            </tr>
                            <tr>
                                <td class="border border-slate-200 px-4 py-2">COALESCE / astype</td>
                                <td
                                    class="border border-slate-200 px-4 py-2 font-mono text-emerald-700"
                                >
                                    O(G)
                                </td>
                                <td
                                    class="border border-slate-200 px-4 py-2 font-mono text-emerald-700"
                                >
                                    O(G)
                                </td>
                                <td class="border border-slate-200 px-4 py-2 text-slate-500">
                                    G = 月×国のユニーク数
                                </td>
                            </tr>
                            <tr class="bg-slate-50 font-bold">
                                <td class="border border-slate-200 px-4 py-2">合計</td>
                                <td
                                    class="border border-slate-200 px-4 py-2 font-mono text-teal-700"
                                >
                                    O(N)
                                </td>
                                <td
                                    class="border border-slate-200 px-4 py-2 font-mono text-teal-700"
                                >
                                    O(N)
                                </td>
                                <td class="border border-slate-200 px-4 py-2 text-slate-500">
                                    sort=False でソートコスト回避
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="font-bold text-teal-800 text-lg mb-3">手法比較</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-slate-100">
                                <th class="border border-slate-200 px-4 py-3 text-left">手法</th>
                                <th class="border border-slate-200 px-4 py-3 text-left">時間</th>
                                <th class="border border-slate-200 px-4 py-3 text-left">空間</th>
                                <th class="border border-slate-200 px-4 py-3 text-left">可読性</th>
                                <th class="border border-slate-200 px-4 py-3 text-left">
                                    NULL 安全
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-emerald-50">
                                <td
                                    class="border border-slate-200 px-4 py-2 font-bold text-emerald-700"
                                >
                                    ✅ FILTER + COALESCE
                                </td>
                                <td class="border border-slate-200 px-4 py-2">O(N)</td>
                                <td class="border border-slate-200 px-4 py-2">O(G)</td>
                                <td class="border border-slate-200 px-4 py-2">◎</td>
                                <td
                                    class="border border-slate-200 px-4 py-2 text-emerald-600 font-bold"
                                >
                                    ◎
                                </td>
                            </tr>
                            <tr>
                                <td class="border border-slate-200 px-4 py-2">CASE WHEN</td>
                                <td class="border border-slate-200 px-4 py-2">O(N)</td>
                                <td class="border border-slate-200 px-4 py-2">O(G)</td>
                                <td class="border border-slate-200 px-4 py-2">○</td>
                                <td class="border border-slate-200 px-4 py-2 text-amber-600">
                                    要 COALESCE
                                </td>
                            </tr>
                            <tr class="bg-slate-50">
                                <td class="border border-slate-200 px-4 py-2">サブクエリ結合</td>
                                <td class="border border-slate-200 px-4 py-2">O(N)</td>
                                <td class="border border-slate-200 px-4 py-2">O(G×2)</td>
                                <td class="border border-slate-200 px-4 py-2">△</td>
                                <td class="border border-slate-200 px-4 py-2 text-amber-600">
                                    要注意
                                </td>
                            </tr>
                            <tr>
                                <td class="border border-slate-200 px-4 py-2">pandas apply</td>
                                <td class="border border-slate-200 px-4 py-2">O(N×G)</td>
                                <td class="border border-slate-200 px-4 py-2">O(N)</td>
                                <td class="border border-slate-200 px-4 py-2">○</td>
                                <td class="border border-slate-200 px-4 py-2 text-red-500">△</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <script type="text/babel">
            const { useState, useEffect, useRef } = React;

            const stepsData = [
                {
                    step: 1,
                    title: '入力データの確認',
                    desc: 'Transactions テーブルを確認する。id, country（NULLあり）, state（approved/declined）, amount, trans_date の5列で構成される。',
                    visual: { type: 'input' },
                },
                {
                    step: 2,
                    title: '月文字列列を生成',
                    desc: "trans_date から YYYY-MM 形式の month 列を生成する。SQL: TO_CHAR(trans_date, 'YYYY-MM') / pandas: dt.to_period('M').astype(str)",
                    visual: { type: 'month' },
                },
                {
                    step: 3,
                    title: '承認フラグ列を付与',
                    desc: "state == 'approved' の boolean を int8 に変換し is_approved 列を作成する。これで SUM による条件集計が可能になり、0件時も 0 を返す（NULL にならない）。",
                    visual: { type: 'flag' },
                },
                {
                    step: 4,
                    title: 'GROUP BY month × country',
                    desc: '月と国の組み合わせでグループ化する。★ 重要: dropna=False（pandas）/ GROUP BY そのまま（SQL）で country=NULL のグループも保持する。',
                    visual: { type: 'group' },
                },
                {
                    step: 5,
                    title: '4指標を一括集計',
                    desc: 'COUNT(*), COUNT FILTER approved, SUM(amount), SUM approved_amount を一発で集計する。COALESCE で承認0件グループの NULL を 0 に変換する。',
                    visual: { type: 'agg' },
                },
                {
                    step: 6,
                    title: '結果出力',
                    desc: 'month, country, trans_count, approved_count, trans_total_amount, approved_total_amount の6列を返す。country=NULL の行も正しく含まれる。',
                    visual: { type: 'result' },
                },
            ];

            const inputRows = [
                { id: 121, country: 'US', state: 'approved', amount: 1000, date: '2018-12-18' },
                { id: 122, country: 'US', state: 'declined', amount: 2000, date: '2018-12-19' },
                { id: 123, country: 'US', state: 'approved', amount: 2000, date: '2019-01-01' },
                { id: 124, country: 'NULL', state: 'approved', amount: 2000, date: '2019-01-07' },
            ];

            function StepViz({ type }) {
                const colors = { approved: '#d1fae5', declined: '#fee2e2' };
                const txtColors = { approved: '#065f46', declined: '#7f1d1d' };

                if (type === 'input')
                    return (
                        <svg
                            viewBox="0 0 560 220"
                            style={{ maxWidth: '100%', height: 'auto', marginTop: '16px' }}
                            role="img"
                            aria-labelledby="svg-input-title"
                        >
                            <title id="svg-input-title">Transactions テーブル（入力）</title>
                            <rect
                                x="10"
                                y="10"
                                width="540"
                                height="200"
                                rx="12"
                                fill="#f8fafc"
                                stroke="#e2e8f0"
                                strokeWidth="1.5"
                            />
                            <text
                                x="280"
                                y="38"
                                textAnchor="middle"
                                fontSize="14"
                                fontWeight="bold"
                                fill="#0c4a6e"
                            >
                                Transactions テーブル（入力）
                            </text>
                            {['id', 'country', 'state', 'amount', 'trans_date'].map((h, i) => (
                                <text
                                    key={h}
                                    x={55 + i * 100}
                                    y="65"
                                    textAnchor="middle"
                                    fontSize="12"
                                    fontWeight="bold"
                                    fill="#475569"
                                >
                                    {h}
                                </text>
                            ))}
                            {inputRows.map((r, ri) => {
                                const y = 95 + ri * 28;
                                const bg = ri % 2 === 0 ? '#f0fdf4' : '#f0f9ff';
                                return (
                                    <g key={r.id}>
                                        <rect
                                            x="15"
                                            y={y - 12}
                                            width="530"
                                            height="26"
                                            rx="4"
                                            fill={bg}
                                        />
                                        <text
                                            x="55"
                                            y={y + 2}
                                            textAnchor="middle"
                                            fontSize="12"
                                            fill="#1e293b"
                                        >
                                            {r.id}
                                        </text>
                                        <text
                                            x="155"
                                            y={y + 2}
                                            textAnchor="middle"
                                            fontSize="12"
                                            fill={r.country === 'NULL' ? '#d97706' : '#1e293b'}
                                            fontWeight={r.country === 'NULL' ? 'bold' : 'normal'}
                                        >
                                            {r.country}
                                        </text>
                                        <rect
                                            x="206"
                                            y={y - 10}
                                            width="98"
                                            height="20"
                                            rx="4"
                                            fill={colors[r.state]}
                                        />
                                        <text
                                            x="255"
                                            y={y + 2}
                                            textAnchor="middle"
                                            fontSize="11"
                                            fill={txtColors[r.state]}
                                            fontWeight="bold"
                                        >
                                            {r.state}
                                        </text>
                                        <text
                                            x="355"
                                            y={y + 2}
                                            textAnchor="middle"
                                            fontSize="12"
                                            fill="#1e293b"
                                        >
                                            {r.amount}
                                        </text>
                                        <text
                                            x="455"
                                            y={y + 2}
                                            textAnchor="middle"
                                            fontSize="12"
                                            fill="#1e293b"
                                        >
                                            {r.date}
                                        </text>
                                    </g>
                                );
                            })}
                        </svg>
                    );

                if (type === 'month')
                    return (
                        <svg
                            viewBox="0 0 560 220"
                            style={{ maxWidth: '100%', height: 'auto', marginTop: '16px' }}
                            role="img"
                            aria-labelledby="svg-month-title"
                        >
                            <title id="svg-month-title">month 列を追加</title>
                            <rect
                                x="10"
                                y="10"
                                width="540"
                                height="200"
                                rx="12"
                                fill="#f8fafc"
                                stroke="#e2e8f0"
                                strokeWidth="1.5"
                            />
                            <text
                                x="280"
                                y="38"
                                textAnchor="middle"
                                fontSize="14"
                                fontWeight="bold"
                                fill="#0c4a6e"
                            >
                                month 列を追加
                            </text>
                            {['trans_date', '→', 'month (追加)'].map((h, i) => (
                                <text
                                    key={h}
                                    x={[120, 280, 430][i]}
                                    y="65"
                                    textAnchor="middle"
                                    fontSize="13"
                                    fontWeight="bold"
                                    fill={i === 2 ? '#0369a1' : '#475569'}
                                >
                                    {h}
                                </text>
                            ))}
                            {inputRows.map((r, ri) => {
                                const y = 95 + ri * 28,
                                    month = r.date.slice(0, 7);
                                return (
                                    <g key={r.id}>
                                        <rect
                                            x="15"
                                            y={y - 12}
                                            width="530"
                                            height="26"
                                            rx="4"
                                            fill={ri % 2 === 0 ? '#f0fdf4' : '#f0f9ff'}
                                        />
                                        <text
                                            x="120"
                                            y={y + 2}
                                            textAnchor="middle"
                                            fontSize="12"
                                            fill="#64748b"
                                        >
                                            {r.date}
                                        </text>
                                        <text
                                            x="280"
                                            y={y + 2}
                                            textAnchor="middle"
                                            fontSize="16"
                                            fill="#0284c7"
                                        >
                                            →
                                        </text>
                                        <rect
                                            x="360"
                                            y={y - 10}
                                            width="150"
                                            height="20"
                                            rx="4"
                                            fill="#bfdbfe"
                                        />
                                        <text
                                            x="435"
                                            y={y + 2}
                                            textAnchor="middle"
                                            fontSize="13"
                                            fill="#1e40af"
                                            fontWeight="bold"
                                        >
                                            {month}
                                        </text>
                                    </g>
                                );
                            })}
                        </svg>
                    );

                if (type === 'flag')
                    return (
                        <svg
                            viewBox="0 0 560 230"
                            style={{ maxWidth: '100%', height: 'auto', marginTop: '16px' }}
                            role="img"
                            aria-labelledby="svg-flag-title"
                        >
                            <title id="svg-flag-title">is_approved フラグ列</title>
                            <rect
                                x="10"
                                y="10"
                                width="540"
                                height="210"
                                rx="12"
                                fill="#f8fafc"
                                stroke="#e2e8f0"
                                strokeWidth="1.5"
                            />
                            <text
                                x="280"
                                y="38"
                                textAnchor="middle"
                                fontSize="14"
                                fontWeight="bold"
                                fill="#0c4a6e"
                            >
                                is_approved フラグ列 (int8) を付与
                            </text>
                            {['state', '→', 'is_approved', 'approved_amt'].map((h, i) => (
                                <text
                                    key={h}
                                    x={[100, 230, 340, 460][i]}
                                    y="65"
                                    textAnchor="middle"
                                    fontSize="12"
                                    fontWeight="bold"
                                    fill={i >= 2 ? '#7c3aed' : '#475569'}
                                >
                                    {h}
                                </text>
                            ))}
                            {inputRows.map((r, ri) => {
                                const y = 97 + ri * 30,
                                    flag = r.state === 'approved' ? 1 : 0;
                                return (
                                    <g key={r.id}>
                                        <rect
                                            x="15"
                                            y={y - 13}
                                            width="530"
                                            height="26"
                                            rx="4"
                                            fill={ri % 2 === 0 ? '#f5f3ff' : '#ede9fe'}
                                        />
                                        <rect
                                            x="50"
                                            y={y - 10}
                                            width="100"
                                            height="20"
                                            rx="4"
                                            fill={colors[r.state]}
                                        />
                                        <text
                                            x="100"
                                            y={y + 2}
                                            textAnchor="middle"
                                            fontSize="11"
                                            fill={txtColors[r.state]}
                                            fontWeight="bold"
                                        >
                                            {r.state}
                                        </text>
                                        <text
                                            x="230"
                                            y={y + 2}
                                            textAnchor="middle"
                                            fontSize="16"
                                            fill="#7c3aed"
                                        >
                                            →
                                        </text>
                                        <rect
                                            x="295"
                                            y={y - 10}
                                            width="90"
                                            height="20"
                                            rx="4"
                                            fill={flag ? '#d1fae5' : '#fee2e2'}
                                        />
                                        <text
                                            x="340"
                                            y={y + 2}
                                            textAnchor="middle"
                                            fontSize="14"
                                            fontWeight="bold"
                                            fill={flag ? '#065f46' : '#7f1d1d'}
                                        >
                                            {flag}
                                        </text>
                                        <rect
                                            x="400"
                                            y={y - 10}
                                            width="120"
                                            height="20"
                                            rx="4"
                                            fill="#ede9fe"
                                        />
                                        <text
                                            x="460"
                                            y={y + 2}
                                            textAnchor="middle"
                                            fontSize="13"
                                            fontWeight="bold"
                                            fill="#5b21b6"
                                        >
                                            {r.amount * flag}
                                        </text>
                                    </g>
                                );
                            })}
                        </svg>
                    );

                if (type === 'group')
                    return (
                        <svg
                            viewBox="0 0 560 240"
                            style={{ maxWidth: '100%', height: 'auto', marginTop: '16px' }}
                            role="img"
                            aria-labelledby="svg-group-title"
                        >
                            <title id="svg-group-title">GROUP BY month × country</title>
                            <rect
                                x="10"
                                y="10"
                                width="540"
                                height="220"
                                rx="12"
                                fill="#f8fafc"
                                stroke="#e2e8f0"
                                strokeWidth="1.5"
                            />
                            <text
                                x="280"
                                y="38"
                                textAnchor="middle"
                                fontSize="14"
                                fontWeight="bold"
                                fill="#0c4a6e"
                            >
                                GROUP BY month × country
                            </text>
                            <text
                                x="280"
                                y="60"
                                textAnchor="middle"
                                fontSize="12"
                                fill="#dc2626"
                                fontWeight="bold"
                            >
                                ★ dropna=False で NULL キーも保持
                            </text>

                            {[
                                ['2018-12', 'US', '#fef3c7', '#92400e', [121, 122]],
                                ['2019-01', 'US', '#d1fae5', '#065f46', [123]],
                                ['2019-01', 'NULL', '#fee2e2', '#7f1d1d', [124]],
                            ].map(([m, c, bg, fg, ids], gi) => (
                                <g key={gi}>
                                    <rect
                                        x="30"
                                        y={85 + gi * 45}
                                        width="500"
                                        height="36"
                                        rx="8"
                                        fill={bg}
                                        stroke={fg}
                                        strokeWidth="1.5"
                                    />
                                    <text
                                        x="120"
                                        y={108 + gi * 45}
                                        textAnchor="middle"
                                        fontSize="13"
                                        fontWeight="bold"
                                        fill={fg}
                                    >
                                        {m}
                                    </text>
                                    <text
                                        x="240"
                                        y={108 + gi * 45}
                                        textAnchor="middle"
                                        fontSize="13"
                                        fontWeight="bold"
                                        fill={c === 'NULL' ? '#d97706' : fg}
                                    >
                                        {c}
                                    </text>
                                    <text
                                        x="400"
                                        y={108 + gi * 45}
                                        textAnchor="middle"
                                        fontSize="12"
                                        fill="#475569"
                                    >
                                        IDs: {ids.join(', ')}
                                    </text>
                                </g>
                            ))}
                            <text x="120" y="79" textAnchor="middle" fontSize="11" fill="#64748b">
                                month
                            </text>
                            <text x="240" y="79" textAnchor="middle" fontSize="11" fill="#64748b">
                                country
                            </text>
                            <text x="400" y="79" textAnchor="middle" fontSize="11" fill="#64748b">
                                グループ内の行
                            </text>
                        </svg>
                    );

                if (type === 'agg')
                    return (
                        <svg
                            viewBox="0 0 580 240"
                            style={{ maxWidth: '100%', height: 'auto', marginTop: '16px' }}
                            role="img"
                            aria-labelledby="svg-agg-title"
                        >
                            <title id="svg-agg-title">4指標を一括集計 + COALESCE</title>
                            <rect
                                x="10"
                                y="10"
                                width="560"
                                height="220"
                                rx="12"
                                fill="#f8fafc"
                                stroke="#e2e8f0"
                                strokeWidth="1.5"
                            />
                            <text
                                x="290"
                                y="38"
                                textAnchor="middle"
                                fontSize="14"
                                fontWeight="bold"
                                fill="#0c4a6e"
                            >
                                4指標を一括集計 + COALESCE
                            </text>
                            {[
                                'month',
                                'country',
                                'trans_count',
                                'approved_count',
                                'trans_total',
                                'approved_total',
                            ].map((h, i) => (
                                <text
                                    key={h}
                                    x={[60, 130, 215, 305, 400, 500][i]}
                                    y="65"
                                    textAnchor="middle"
                                    fontSize="10"
                                    fontWeight="bold"
                                    fill="#475569"
                                >
                                    {h}
                                </text>
                            ))}
                            {[
                                ['2018-12', 'US', '2', '1', '3000', '1000', '#fef3c7'],
                                ['2019-01', 'US', '1', '1', '2000', '2000', '#d1fae5'],
                                ['2019-01', 'NULL', '1', '1', '2000', '2000', '#fee2e2'],
                            ].map(([m, c, tc, ac, tt, at, bg], ri) => {
                                const y = 88 + ri * 45;
                                return (
                                    <g key={ri}>
                                        <rect
                                            x="20"
                                            y={y - 12}
                                            width="540"
                                            height="36"
                                            rx="6"
                                            fill={bg}
                                        />
                                        <text
                                            x="60"
                                            y={y + 8}
                                            textAnchor="middle"
                                            fontSize="12"
                                            fontWeight="bold"
                                            fill="#1e293b"
                                        >
                                            {m}
                                        </text>
                                        <text
                                            x="130"
                                            y={y + 8}
                                            textAnchor="middle"
                                            fontSize="12"
                                            fontWeight="bold"
                                            fill={c === 'NULL' ? '#d97706' : '#1e293b'}
                                        >
                                            {c}
                                        </text>
                                        <text
                                            x="215"
                                            y={y + 8}
                                            textAnchor="middle"
                                            fontSize="13"
                                            fontWeight="bold"
                                            fill="#0369a1"
                                        >
                                            {tc}
                                        </text>
                                        <text
                                            x="305"
                                            y={y + 8}
                                            textAnchor="middle"
                                            fontSize="13"
                                            fontWeight="bold"
                                            fill="#059669"
                                        >
                                            {ac}
                                        </text>
                                        <text
                                            x="400"
                                            y={y + 8}
                                            textAnchor="middle"
                                            fontSize="13"
                                            fontWeight="bold"
                                            fill="#7c3aed"
                                        >
                                            {tt}
                                        </text>
                                        <text
                                            x="500"
                                            y={y + 8}
                                            textAnchor="middle"
                                            fontSize="13"
                                            fontWeight="bold"
                                            fill="#dc2626"
                                        >
                                            {at}
                                        </text>
                                    </g>
                                );
                            })}
                        </svg>
                    );

                if (type === 'result')
                    return (
                        <svg
                            viewBox="0 0 580 240"
                            style={{ maxWidth: '100%', height: 'auto', marginTop: '16px' }}
                            role="img"
                            aria-labelledby="svg-result-title"
                        >
                            <title id="svg-result-title">最終出力（6列）</title>
                            <rect
                                x="10"
                                y="10"
                                width="560"
                                height="220"
                                rx="12"
                                fill="#d1fae5"
                                stroke="#10b981"
                                strokeWidth="2"
                            />
                            <text
                                x="290"
                                y="38"
                                textAnchor="middle"
                                fontSize="14"
                                fontWeight="bold"
                                fill="#065f46"
                            >
                                ✅ 最終出力（6列）
                            </text>
                            {[
                                'month',
                                'country',
                                'trans_count',
                                'approved_count',
                                'trans_total',
                                'approved_total',
                            ].map((h, i) => (
                                <text
                                    key={h}
                                    x={[60, 130, 215, 305, 400, 500][i]}
                                    y="65"
                                    textAnchor="middle"
                                    fontSize="10"
                                    fontWeight="bold"
                                    fill="#065f46"
                                >
                                    {h}
                                </text>
                            ))}
                            {[
                                ['2018-12', 'US', '2', '1', '3000', '1000'],
                                ['2019-01', 'US', '1', '1', '2000', '2000'],
                                ['2019-01', 'NULL', '1', '1', '2000', '2000'],
                            ].map(([m, c, tc, ac, tt, at], ri) => {
                                const y = 90 + ri * 45;
                                const bg = ri % 2 === 0 ? '#ecfdf5' : '#f0fdf4';
                                return (
                                    <g key={ri}>
                                        <rect
                                            x="20"
                                            y={y - 14}
                                            width="540"
                                            height="38"
                                            rx="6"
                                            fill={bg}
                                            stroke="#a7f3d0"
                                            strokeWidth="1"
                                        />
                                        <text
                                            x="60"
                                            y={y + 6}
                                            textAnchor="middle"
                                            fontSize="12"
                                            fontWeight="bold"
                                            fill="#047857"
                                        >
                                            {m}
                                        </text>
                                        <text
                                            x="130"
                                            y={y + 6}
                                            textAnchor="middle"
                                            fontSize="12"
                                            fontWeight="bold"
                                            fill={c === 'NULL' ? '#d97706' : '#047857'}
                                        >
                                            {c}
                                        </text>
                                        <text
                                            x="215"
                                            y={y + 6}
                                            textAnchor="middle"
                                            fontSize="14"
                                            fontWeight="bold"
                                            fill="#0369a1"
                                        >
                                            {tc}
                                        </text>
                                        <text
                                            x="305"
                                            y={y + 6}
                                            textAnchor="middle"
                                            fontSize="14"
                                            fontWeight="bold"
                                            fill="#059669"
                                        >
                                            {ac}
                                        </text>
                                        <text
                                            x="400"
                                            y={y + 6}
                                            textAnchor="middle"
                                            fontSize="14"
                                            fontWeight="bold"
                                            fill="#7c3aed"
                                        >
                                            {tt}
                                        </text>
                                        <text
                                            x="500"
                                            y={y + 6}
                                            textAnchor="middle"
                                            fontSize="14"
                                            fontWeight="bold"
                                            fill="#dc2626"
                                        >
                                            {at}
                                        </text>
                                    </g>
                                );
                            })}
                        </svg>
                    );

                return null;
            }

            function StepsApp() {
                const [activeStep, setActiveStep] = useState(1);
                const [isPlaying, setIsPlaying] = useState(false);
                const timerRef = useRef(null);

                const currentStepData =
                    stepsData.find((s) => s.step === activeStep) || stepsData[0];

                useEffect(() => {
                    if (isPlaying) {
                        if (activeStep > stepsData.length) {
                            setIsPlaying(false);
                            setActiveStep(1);
                            return;
                        }
                        timerRef.current = setTimeout(() => {
                            if (activeStep === stepsData.length) {
                                setActiveStep(1);
                                setIsPlaying(false);
                            } else {
                                setActiveStep((prev) => prev + 1);
                            }
                        }, 1800);
                    }
                    return () => {
                        if (timerRef.current) clearTimeout(timerRef.current);
                    };
                }, [isPlaying, activeStep]);

                const handlePlay = () => {
                    if (isPlaying) return;
                    setIsPlaying(true);
                    setActiveStep(1);
                };

                return (
                    <div className="grid grid-cols-1 md:grid-cols-[1fr_2fr] gap-8 mt-2">
                        <div>
                            <h3 className="mt-0 mb-4 text-teal-800 text-xl font-semibold">
                                ステップ一覧
                            </h3>
                            <div className="space-y-2">
                                {stepsData.map((step) => {
                                    const isActive = activeStep === step.step;
                                    return (
                                        <button
                                            key={step.step}
                                            type="button"
                                            className={[
                                                'w-full text-left text-[0.9rem] rounded-xl border-2 transition cursor-pointer px-4 py-3',
                                                'bg-white border-slate-200 hover:border-emerald-500 hover:translate-x-1',
                                                isActive
                                                    ? 'bg-[linear-gradient(135deg,#d1fae5,#a7f3d0)] border-emerald-500 shadow-[0_4px_12px_rgba(16,185,129,0.20)]'
                                                    : '',
                                            ].join(' ')}
                                            onClick={() => {
                                                setActiveStep(step.step);
                                                setIsPlaying(false);
                                            }}
                                            aria-label={`ステップ${step.step}: ${step.title}`}
                                            aria-current={isActive ? 'step' : undefined}
                                        >
                                            <div
                                                className={[
                                                    'font-bold mb-1',
                                                    isActive ? 'text-emerald-900' : 'text-teal-800',
                                                ].join(' ')}
                                            >
                                                Step {step.step}: {step.title}
                                            </div>
                                            <div className="text-slate-500 text-xs">
                                                {step.desc.substring(0, 55)}
                                                {step.desc.length > 55 ? '...' : ''}
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="my-auto">
                            <div className="rounded-2xl p-6 border-2 border-emerald-200 bg-[linear-gradient(135deg,#ecfdf5,#f0f9ff)]">
                                <h3 className="mt-0 text-teal-800 text-lg font-bold">
                                    Step {currentStepData.step}: {currentStepData.title}
                                </h3>
                                <p className="text-slate-600 leading-7 text-sm mt-2">
                                    {currentStepData.desc}
                                </p>
                            </div>

                            <StepViz type={currentStepData.visual.type} />

                            <div className="flex flex-wrap justify-center gap-2 mt-4">
                                <button
                                    type="button"
                                    className="px-5 py-2.5 rounded-xl font-semibold text-white transition disabled:opacity-50 shadow hover:-translate-y-0.5 bg-[linear-gradient(135deg,#10b981,#059669)] text-sm"
                                    onClick={handlePlay}
                                    disabled={isPlaying}
                                >
                                    ▶ Play
                                </button>
                                <button
                                    type="button"
                                    className="px-5 py-2.5 rounded-xl font-semibold text-white transition disabled:opacity-50 shadow hover:-translate-y-0.5 bg-[linear-gradient(135deg,#0ea5e9,#0284c7)] text-sm"
                                    onClick={() => {
                                        setActiveStep((s) => Math.max(1, s - 1));
                                        setIsPlaying(false);
                                    }}
                                    disabled={activeStep === 1}
                                >
                                    ◀ Prev
                                </button>
                                <button
                                    type="button"
                                    className="px-5 py-2.5 rounded-xl font-semibold text-white transition disabled:opacity-50 shadow hover:-translate-y-0.5 bg-[linear-gradient(135deg,#0ea5e9,#0284c7)] text-sm"
                                    onClick={() => {
                                        setActiveStep((s) => Math.min(stepsData.length, s + 1));
                                        setIsPlaying(false);
                                    }}
                                    disabled={activeStep === stepsData.length}
                                >
                                    Next ▶
                                </button>
                                <button
                                    type="button"
                                    className="px-5 py-2.5 rounded-xl font-semibold text-slate-700 transition shadow hover:-translate-y-0.5 bg-white border-2 border-slate-200 text-sm"
                                    onClick={() => {
                                        setActiveStep(1);
                                        setIsPlaying(false);
                                    }}
                                >
                                    ↺ Reset
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('steps-root'));
            root.render(<StepsApp />);

            setTimeout(() => {
                Prism.highlightAll();
            }, 300);
        </script>
    </body>
</html>
